(function(){function C(a){let b=Math.floor(a/60);a%=60;return`${10>b?"0"+b:b}:${10>a?"0"+a:a}`}function H(){(new y(r?40:20,500,function(){let a=document.querySelector(e.danmuBtn);return a?(a.checked&&a.click(),!0):!1})).start()}function D(a){(new y(r?40:20,500,function(){if(2===a&&document.body.classList.contains("player-fullscreen-fix")||1===a&&document.body.classList.contains("player-mode-widescreen"))return!0;let b;1===a?b=document.querySelector(e.widescreen):2===a&&(b=document.querySelector(e.pagefullscreen));
return b?(b.click(),!0):!1})).start()}function T(a){document.fullscreenElement?u=(a=!!document.querySelector("#bilibiliPlayer"))&&document.body.classList.contains("player-mode-webfullscreen")||!a&&document.body.classList.contains("player-fullscreen-fix")?2:document.body.classList.contains("player-mode-widescreen")?1:0:0!=u&&(""==document.body.className&&1===u?D(u):setTimeout(()=>D(u),0))}function I(){document.fullscreenElement&&setTimeout(function(){let a=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video');
a&&a.ended&&document.fullscreenElement&&document.exitFullscreen()},600)}function J(){let a=document.querySelector(e.nextBtn);a&&a.click()}function K(a){if(!a&&(a=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video'),!a))return;let b=!1;try{b=window.self!==
window.top}catch(c){b=!0}b?"1"==(new URL(location.href)).searchParams.get("autoplay")&&a.play().catch(c=>{}):a.play().catch(c=>{})}function E(a){let b=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video');if(b){let c=b.style.width;""==c&&(c="100%");b.style.width=
0<a?"50%"==c?"75%":"100%":0>a?"100%"==c?"75%":"50%":"100%";b.style.margin="auto"}}async function L(a){var b=a.target.tagName;if("INPUT"!==b&&"TEXTAREA"!==b&&"BILI-COMMENTS"!==b&&!a.target.isContentEditable){b=a.keyCode;var c=a.code;if(!(a.ctrlKey||a.metaKey||a.altKey&&83!==b))if(70===b)a.preventDefault(),a.stopPropagation(),document.pictureInPictureElement&&await document.exitPictureInPicture(),(a=document.querySelector(e.fullscreen))&&a.click();else if(87===b)a.preventDefault(),a.stopPropagation(),
(a=document.querySelector(e.pagefullscreen))&&a.click();else if(68===b)if(a.preventDefault(),a.stopPropagation(),a.shiftKey)f.showDanmuState();else{if(a=document.querySelector(e.danmuBtn))a.click(),f.showDanmuState()}else if(84===b)a.preventDefault(),a.stopPropagation(),(a=document.querySelector(e.widescreen))&&a.click();else if(75===b||32===b&&d.spaceAlwaysControl)a.preventDefault(),a.stopPropagation(),(a=document.querySelector(e.playBtn))&&a.click();else if(74===b)a.preventDefault(),a.stopPropagation(),
a.shiftKey?z(!1,F):G(!1);else if(76===b)a.preventDefault(),a.stopPropagation(),a.shiftKey?z(!0,F):G(!0);else if("Equal"===c)a.preventDefault(),a.stopPropagation(),a.shiftKey?E(1):((a=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video'))&&5>a.playbackRate&&
(a.playbackRate=parseFloat((a.playbackRate+d.speedStep).toFixed(2))),a&&f.showState(t.stateSpeed+a.playbackRate));else if("Minus"===c)if(a.preventDefault(),a.stopPropagation(),a.shiftKey)E(-1);else{if(a=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video'))b=
parseFloat((a.playbackRate-d.speedStep).toFixed(2)),.25<=b&&(a.playbackRate=b),f.showState(t.stateSpeed+a.playbackRate)}else if("Digit0"===c)if(a.preventDefault(),a.stopPropagation(),a.shiftKey)E(0);else{if(a=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video'))a.playbackRate=
1,f.showState(t.stateSpeed+1)}else if(67===b)a.preventDefault(),a.stopPropagation(),U();else if(73===b)a.preventDefault(),a.stopPropagation(),m.toggle(0);else if(78===b)a.preventDefault(),a.stopPropagation(),J();else if(77===b){if(a.preventDefault(),a.stopPropagation(),a=document.querySelector(e.muteBtn))if(a.firstElementChild.click(),b=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video'))a=
(c=document.querySelector(".bpx-player-ctrl-volume-number"))?"0"==c.textContent:a.classList.contains("squirtle-volume-icon")?a.classList.contains("squirtle-volume-mute-state"):b.muted,f.showState(a?t.stateMute:t.stateUnmute)}else 80===b?(a.preventDefault(),a.stopPropagation(),V()):188===b?(a.preventDefault(),a.stopPropagation(),z(!1,.042)):190===b?(a.preventDefault(),a.stopPropagation(),z(!0,.042)):83===b&&a.shiftKey?(a.preventDefault(),a.stopPropagation(),W(a.altKey)):71===b?(a.preventDefault(),
a.stopPropagation(),f.toggleTimeState()):72===b?(a.preventDefault(),a.stopPropagation(),f.toggleClockState()):66===b?(a.preventDefault(),a.stopPropagation(),f.showTitle()):"Backspace"===c&&(a.preventDefault(),a.stopPropagation(),a=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video'))&&
(a.currentTime=0,a.paused&&a.play().catch(g=>{}))}}function z(a,b){let c=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video');!c||0===c.readyState||!Number.isFinite(c.duration)||1>b&&!c.paused||(a?c.currentTime=Math.min(c.currentTime+b,c.duration-1):c.duration==
c.currentTime?G(!1):c.currentTime=Math.max(c.currentTime-b,0))}function G(a){var b=document.querySelector(e.videoArea);b&&b.click();b=a?{bubbles:!0,cancelable:!0,key:"ArrowRight",code:"ArrowRight",keyCode:39}:{bubbles:!0,cancelable:!0,key:"ArrowLeft",code:"ArrowLeft",keyCode:37};a=new KeyboardEvent("keydown",b);b=new KeyboardEvent("keyup",b);document.body.dispatchEvent(a);document.body.dispatchEvent(b)}async function V(){let a=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video');
a&&document.pictureInPictureEnabled&&!a.disablePictureInPicture&&0!==a.readyState&&(document.fullscreenElement&&await document.exitFullscreen(),document.pictureInPictureElement?document.exitPictureInPicture():a.requestPictureInPicture())}function U(){let a=document.querySelector(".bilibili-player-iconfont-subtitle");if(a)if(a.nextElementSibling)a.click();else{let b=a.parentElement;b.addEventListener("mouseover",c=>{setTimeout(()=>{b.dispatchEvent(new MouseEvent("mouseout"));setTimeout(()=>a.click(),
500)},150)},{once:!0});b.dispatchEvent(new MouseEvent("mouseover"))}else(a=document.querySelector(".bpx-player-ctrl-subtitle span"))?a.click():(a=document.querySelector(".squirtle-subtitle-wrap"))&&a.firstElementChild&&a.firstElementChild.click()}function W(a=!1){var b=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video');
if(b&&!(2>b.readyState))if(k||(k=document.createElement("a")),"BWP-VIDEO"===b.tagName){if(b.toDataURL)if(a){a=M;var c=b.toDataURL().split(",");b=c[0].match(/:(.*?);/)[1];c=atob(c[1]);for(var g=c.length,v=new Uint8Array(g);g--;)v[g]=c.charCodeAt(g);b=new Blob([v],{type:b});a(b)}else k.download=`screenshot-${b.currentTime.toFixed(3)}.png`,k.href=b.toDataURL(),k.click()}else l||(l=document.createElement("canvas")),l.width=b.videoWidth,l.height=b.videoHeight,l.getContext("2d").drawImage(b,0,0,l.width,
l.height),a?l.toBlob(M):(d&&"png"==d.imageFormat?(k.download=`screenshot-${b.currentTime.toFixed(3)}.png`,k.href=l.toDataURL("image/png")):(k.download=`screenshot-${b.currentTime.toFixed(3)}.jpg`,k.href=l.toDataURL("image/jpeg",.98)),k.click())}function M(a){navigator.clipboard.write([new ClipboardItem({[a.type]:a})]).then(function(){f.showState(t.copied)}).catch(b=>console.error(b))}function N(){let a=document.querySelector(".bilibili-player-video-danmaku,.bpx-player-row-dm-wrap");var b=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video');
if(a&&b){var c=b.clientHeight;b=a.parentElement.clientHeight;c=.85*c+(b-c)/2;b=`${(c/b*100).toFixed(2)}%`;c=Math.round(c*devicePixelRatio);a.style.height!=b&&(a.style.height=b);"CANVAS"===a.tagName&&a.height!=c&&(a.height=c)}}function O(){let a=document.querySelector(".bilibili-player-video-danmaku,.bpx-player-row-dm-wrap");a&&(N(),A=new ResizeObserver(()=>{setTimeout(N,1E3)}),A.observe(a.parentElement))}function X(){let a=document.querySelector("#bilibiliPlayer");if(a){const b={childList:!0};let c;
function g(){c=new MutationObserver(P);c.observe(a,b)}g();let v=document.querySelector("#bilibili-player,.player-container,#bofqi");v&&(new MutationObserver(function(){c.disconnect();setTimeout(g,800);P()})).observe(v,b)}}function P(){d.turnOffDanmu&&H();d.preventshade&&(A&&A.disconnect(),setTimeout(O,500));d.autoplay&&setTimeout(K,500);d.exitFullscreen&&setTimeout(function(){let a=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video');
a&&a.addEventListener("ended",I)},2E3);h&&"none"!=h.style.display&&setTimeout(f.showTitle,1500)}function Y(){(new y(r?60:30,600,function(){let a=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video');if(a){X();!r&&d.keyboard&&document.addEventListener("keydown",
L,!0);d.turnOffDanmu&&H();let b=d.screenMode;0!==b&&D(b);d.autoplay&&K(a);d.turnOffLight&&(m.initTurnOffLight(),d.smartLight&&m.smartLight());d.preventshade&&O();F=d.longStep;document.addEventListener("fullscreenchange",T);d.exitFullscreen&&a.addEventListener("ended",I);return!0}return!1})).start()}function Q(){r&&d.keyboard&&document.addEventListener("keydown",L,!0);Y()}var d=JSON.parse(document.currentScript.dataset.settings);const Z={stateMute:"\u5df2\u9759\u97f3",stateUnmute:"\u5df2\u53d6\u6d88\u9759\u97f3",
stateSpeed:"\u500d\u901f ",copied:"\u5df2\u590d\u5236\u5230\u526a\u5207\u677f"},aa={stateMute:"Muted",stateUnmute:"Unmuted",stateSpeed:"Speed ",copied:"Copied to Clipboard"},t=navigator.language.startsWith("zh-")?Z:aa,e={danmuBtn:".bilibili-player-video-danmaku-switch > input[type=checkbox],.bpx-player-dm-switch input[type=checkbox]",playBtn:".bpx-player-ctrl-play,.bilibili-player-video-btn-start,.squirtle-video-start",nextBtn:".bpx-player-ctrl-next,.bilibili-player-video-btn-next,.squirtle-video-next",
muteBtn:".bpx-player-ctrl-volume,.bilibili-player-video-btn-volume,.squirtle-volume-icon",state:".bilibili-player-video-state,.bpx-player-state-wrap,.bpx-player-video-state",title:".video-title,.bilibili-player-video-top-title,#player-title,.season-info .title",widescreen:".bpx-player-ctrl-wide,.bilibili-player-video-btn-widescreen,.squirtle-video-widescreen",pagefullscreen:".bpx-player-ctrl-web,.bilibili-player-video-web-fullscreen,.squirtle-video-pagefullscreen",fullscreen:".bpx-player-ctrl-full,.bilibili-player-video-btn-fullscreen,.squirtle-video-fullscreen",
videoArea:".bilibili-player-video-wrap,.bpx-player-video-area"};var F=30;class y{constructor(a,b,c){this.max=a;this.fn=c;this.timeout=b;this.count=0;this.repeat=this.start.bind(this)}start(){this.count++;this.count>this.max||this.fn()||setTimeout(this.repeat,this.timeout)}}var q,B,n,w,p,x,R,h;class f{static showState(a){if(!q){var b=document.createElement("div");b.style.cssText="position: absolute; z-index: 100000; left: 34px; bottom: 80px; padding: 10px; background-color: black; color: white; font-size: 30px;";
q=b}if(b=document.querySelector(e.state))q.innerText=a,q.style.display="block",b.parentElement.appendChild(q),B&&clearTimeout(B),B=setTimeout(f.clearState,1500)}static clearState(){B=null;q&&(q.style.display="none")}static showDanmuState(){let a=document.querySelector(e.danmuBtn);a&&f.showState(`\u5f39\u5e55 ${a.checked?"On":"Off"}`)}static toggleTimeState(){if(w)clearTimeout(w),w=null,n&&(n.style.display="none");else{if(!n){let a=document.createElement("div");a.style.cssText="position: absolute; z-index: 100000; left: 0px; top: 0px; padding: 4px; background-color: rgba(8, 8, 8, 0.75); color: white; font-family: monospace; font-size: 22px;";
n=a}f.showPlayerTime(!0)}}static showPlayerTime(a=!1){var b=document.querySelector('#bilibiliPlayer video,#bilibili-player video,.bilibili-player video,.player-container video,#bilibiliPlayer bwp-video,#bilibili-player bwp-video,.bilibili-player bwp-video,.player-container bwp-video,#bofqi video,[aria-label="\u54d4\u54e9\u54d4\u54e9\u64ad\u653e\u5668"] video');let c=document.querySelector(e.state);if(c&&b&&0!==b.readyState&&Number.isFinite(b.duration)){var g=Math.round(b.currentTime);b=Math.round(b.duration);
g=`${C(g)} / ${C(b)} [-${C(b-g)}]`;a&&(n.style.display="block");c.parentElement!==n.parentElement&&c.parentElement.appendChild(n);n.innerText=g;w=setTimeout(f.showPlayerTime,1E3)}else w=null,n.style.display="none"}static toggleClockState(){if(x)clearTimeout(x),x=null,p&&(p.style.display="none");else{if(!p){var a={hour12:!0,hour:"2-digit",minute:"2-digit"};d&&(a.hour12=!d.timeFormatHour24,d.timeFormatSecond&&(a.second="2-digit"));R=new Intl.DateTimeFormat("en-GB",a);a=document.createElement("div");
a.style.cssText="position: absolute; z-index: 100000; right: 0px; top: 0px; padding: 4px; background-color: rgba(8, 8, 8, 0.75); color: white; font-family: monospace; font-size: 22px;";p=a}f.showClockTime(!0)}}static showClockTime(a=!1){let b=document.querySelector(e.state);b?(p.innerText=R.format(new Date),a&&(p.style.display="block"),b.parentElement!==p.parentElement&&b.parentElement.appendChild(p),x=setTimeout(f.showClockTime,1E3)):(x=null,p.style.display="none")}static showTitle(){if(!h){var a=
document.createElement("div");a.style.cssText="display: none; position: absolute; z-index: 100000; top: 0px; left: 50%; transform: translateX(-50%); padding: 4px 8px; background-color: rgba(8, 8, 8, 0.75); color: white; font-size: 22px;";h=a}a=document.querySelector(e.state);let b=document.querySelector(e.title);a&&b&&b.textContent?(a.parentElement!==h.parentElement&&(a.parentElement.appendChild(h),h.style.display="none"),"none"==h.style.display?(h.innerText=b.textContent,h.style.display="block"):
h.style.display="none"):h.style.display="none"}}var u=0;if("mediaSession"in navigator)try{navigator.mediaSession.setActionHandler("nexttrack",J)}catch(a){}class m{static clickLightBtn(a){let b=document.querySelector(".bpx-player-ctrl-setting-lightoff input[type=checkbox],.bilibili-player-video-btn-setting-right-others-content-lightoff input[type=checkbox],.squirtle-lightoff");return b?(0===a?b.click():1!==a||!0!==b.checked&&!b.classList.contains("active")?2!==a||!1!==b.checked&&b.classList.contains("active")||
b.click():b.click(),!0):!1}static toggle(a){if(m.clickLightBtn(a))return!0;let b=document.querySelector(".bilibili-player-video-btn-setting");return b?(b.addEventListener("mouseover",c=>{b.dispatchEvent(new MouseEvent("mouseout"));setTimeout(()=>m.clickLightBtn(a),100)},{once:!0}),b.dispatchEvent(new MouseEvent("mouseover")),!0):!1}static initTurnOffLight(){(new y(r?30:15,600,()=>m.toggle(2))).start()}static smartCallback(a,b){a=a[0];a.isIntersecting?a.target.classList.contains("mini-player")||m.toggle(2):
m.toggle(1)}static smartLight(){let a=new IntersectionObserver(m.smartCallback,{threshold:.75}),b=document.querySelector("#bilibili-player,.player-container,#bofqi");b&&a.observe(b)}}var l,k,A,r=function(){const a=location.href;return a.startsWith("https://www.bilibili.com/video/")||a.startsWith("https://www.bilibili.com/bangumi/")||a.startsWith("https://www.bilibili.com/cheese/")}(),S=!1;document.hidden?document.addEventListener("visibilitychange",function(){document.hidden||S||(S=!0,Q())}):Q()})();
