(function(){var BUILTINSYNCKEY,Log,OmegaTargetCurrent,Promise,dispName,options,startupCheck,upgradeMigrateFn,zeroBackground,_ref,__hasProp={}.hasOwnProperty;OmegaTargetCurrent=Object.create(OmegaTargetChromium),(Promise=OmegaTargetCurrent.Promise).longStackTraces(),OmegaTargetCurrent.Log=Object.create(OmegaTargetCurrent.Log),Log=OmegaTargetCurrent.Log,BUILTINSYNCKEY="zeroOmegaSync",globalThis.isBrowserRestart=void 0===globalThis.startupCheck,globalThis.hasStartupCheck=!globalThis.isBrowserRestart,startupCheck=null!=globalThis.startupCheck?globalThis.startupCheck:globalThis.startupCheck=function(){return!0},options=null,chrome.runtime.onStartup.addListener((function(){return globalThis.isBrowserRestart=!0})),null!=(_ref=chrome.contextMenus)&&_ref.onClicked.addListener((function(info,tab){return null!=options?options.ready.then((function(){switch(info.menuItemId){case"inspectPage":case"inspectLink":case"inspectElement":case"inspectFrame":return options._inspect.inspect(info,tab)}})):void 0})),upgradeMigrateFn=function(details){var currentVersion,previousVersion;if("update"===details.reason&&(currentVersion=chrome.runtime.getManifest().version,previousVersion=details.previousVersion,compareVersions.compare(currentVersion,previousVersion,">"))){if(compareVersions.compare("3.3.0",currentVersion,">"))return options.ready.then((function(){return chrome.storage.sync.clear(),chrome.storage.local.clear(),idbKeyval.clear()}));switch(currentVersion){case"3.3.10":case"3.3.11":return options.ready.then((function(){return!0}))}}},chrome.runtime.onInstalled.addListener((function(details){return setTimeout((function(){return upgradeMigrateFn(details)}),2)})),dispName=function(name){return chrome.i18n.getMessage("profile_"+name)||name},zeroBackground=function(zeroStorage,opts){var actionForUrl,builtInSyncStorage,charCodeUnderscore,drawContext,drawError,drawIcon,encodeError,external,iconCache,isHidden,proxyImpl,refreshActivePageIfEnabled,resetAllOptions,state,storage,sync,syncStorage,tabs,timeout,unhandledPromises,unhandledPromisesId,unhandledPromisesNextId,_ref1,_ref2;return unhandledPromises=[],unhandledPromisesId=[],unhandledPromisesNextId=1,Promise.onPossiblyUnhandledRejection((function(reason,promise){return Log.error("["+unhandledPromisesNextId+"] Unhandled rejection:\n",reason),unhandledPromises.push(promise),unhandledPromisesId.push(unhandledPromisesNextId),unhandledPromisesNextId++})),Promise.onUnhandledRejectionHandled((function(promise){var index;return index=unhandledPromises.indexOf(promise),Log.log("["+unhandledPromisesId[index]+"] Rejection handled!",promise),unhandledPromises.splice(index,1),unhandledPromisesId.splice(index,1)})),iconCache={},drawContext=null,drawError=null,drawIcon=function(resultColor,profileColor){var cacheKey,canvas,e,icon,size,_i,_len,_ref1;if(icon=iconCache[cacheKey="omega+"+(null!=resultColor?resultColor:"")+"+"+profileColor])return icon;try{for(null==drawContext&&(canvas=new OffscreenCanvas(300,300),drawContext=canvas.getContext("2d",{willReadFrequently:!0})),icon={},_i=0,_len=(_ref1=[16,19,24,32,38]).length;_i<_len;_i++)if(size=_ref1[_i],drawContext.scale(size,size),drawContext.clearRect(0,0,1,1),null!=resultColor?drawOmega(drawContext,resultColor,profileColor):drawOmega(drawContext,profileColor),drawContext.setTransform(1,0,0,1,0,0),icon[size]=drawContext.getImageData(0,0,size,size),255===icon[size].data[3])throw new Error("Icon drawing blocked by privacy.resistFingerprinting.")}catch(_error){e=_error,null==drawError&&(drawError=e,Log.error(e),Log.error("Profile-colored icon disabled. Falling back to static icon.")),icon=null}return iconCache[cacheKey]=icon},charCodeUnderscore="_".charCodeAt(0),isHidden=function(name){return name.charCodeAt(0)===charCodeUnderscore&&name.charCodeAt(1)===charCodeUnderscore},actionForUrl=function(url){return options.ready.then((function(){var request;return request=OmegaPac.Conditions.requestFromUrl(url),options.matchProfile(request)})).then((function(_arg){var attached,condition2Str,current,currentName,details,direct,icon,name,profile,profileColor,realCurrentName,result,resultColor,results,shortTitle,_i,_len,_ref1,_ref2;for(profile=_arg.profile,results=_arg.results,current=options.currentProfile(),currentName=dispName(current.name),"VirtualProfile"===current.profileType&&(realCurrentName=current.defaultProfileName,currentName+=" ["+dispName(realCurrentName)+"]",current=options.profile(realCurrentName)),details="",direct=!1,attached=!1,condition2Str=function(condition){return condition.pattern||OmegaPac.Conditions.str(condition)},_i=0,_len=results.length;_i<_len;_i++)result=results[_i],Array.isArray(result)?null==result[1]?(attached=!1,"+"===(name=result[0])[0]&&(name=name.substr(1)),isHidden(name)?attached=!0:name!==realCurrentName&&(details+=chrome.i18n.getMessage("browserAction_defaultRuleDetails"),details+=" => "+dispName(name)+"\n")):0===result[1].length?"DIRECT"===result[0]?(details+=chrome.i18n.getMessage("browserAction_directResult"),details+="\n",direct=!0):details+=result[0]+"\n":"string"==typeof result[1]?details+=result[1]+" => "+result[0]+"\n":(details+=condition2Str(null!=(_ref1=result[1].condition)?_ref1:result[1])+" => ","DIRECT"===result[0]?(details+=chrome.i18n.getMessage("browserAction_directResult"),details+="\n",direct=!0):details+=result[0]+"\n"):result.profileName&&(result.isTempRule?details+=chrome.i18n.getMessage("browserAction_tempRulePrefix"):attached&&(details+=chrome.i18n.getMessage("browserAction_attachedPrefix"),attached=!1),details+=(null!=(_ref2=result.source)?_ref2:condition2Str(result.condition))+" => "+dispName(result.profileName)+"\n");return details||(details=options.printProfile(current)),resultColor=profile.color,profileColor=current.color,icon=null,direct?(resultColor=options.profile("direct").color,profileColor=profile.color):profile.name===current.name&&options.isCurrentProfileStatic()?(resultColor=profileColor=profile.color,icon=drawIcon(profile.color)):(resultColor=profile.color,profileColor=current.color),null==icon&&(icon=drawIcon(resultColor,profileColor)),shortTitle="Omega: "+currentName,profile.name!==currentName&&(shortTitle+=" => "+profile.name),{title:chrome.i18n.getMessage("browserAction_titleWithResult",[currentName,dispName(profile.name),details]),shortTitle:shortTitle,icon:icon,resultColor:resultColor,profileColor:profileColor}})).catch((function(){return null}))},storage=new OmegaTargetCurrent.Storage("local"),state=new OmegaTargetCurrent.BrowserStorage(zeroStorage,"omega.local."),(("undefined"!=typeof chrome&&null!==chrome&&null!=(_ref1=chrome.storage)?_ref1.sync:void 0)||("undefined"!=typeof browser&&null!==browser&&null!=(_ref2=browser.storage)?_ref2.sync:void 0))&&(syncStorage=new OmegaTargetCurrent.SyncStorage("sync",state),builtInSyncStorage=new OmegaTargetCurrent.Storage("sync"),(sync=new OmegaTargetCurrent.OptionsSync(syncStorage,builtInSyncStorage,state)).transformValue=OmegaTargetCurrent.Options.transformValueForSync),proxyImpl=OmegaTargetCurrent.proxy.getProxyImpl(Log),state.set({proxyImplFeatures:proxyImpl.features}),(options=new OmegaTargetCurrent.Options(storage,state,Log,sync,proxyImpl)).initWithOptions(null,startupCheck),options.externalApi=new OmegaTargetCurrent.ExternalApi(options),options.externalApi.listen(),chrome.runtime.id,OmegaTargetCurrent.SwitchySharp.extId,sync&&options&&builtInSyncStorage&&builtInSyncStorage.watch([BUILTINSYNCKEY],(function(changes,opts){var builtInSyncConfig,gistId,gistToken,lastGistCommit;if(null==opts&&(opts={}),builtInSyncConfig=changes[BUILTINSYNCKEY])return gistId=builtInSyncConfig.gistId,gistToken=builtInSyncConfig.gistToken,lastGistCommit=builtInSyncConfig.lastGistCommit,state.set({gistId:gistId,gistToken:gistToken}),sync.enabled?(console.log("check gist change",lastGistCommit),sync.init({gistId:gistId,gistToken:gistToken}),state.get({lastGistCommit:""}).then((function(syncConfig){if(syncConfig.lastGistCommit!==lastGistCommit)return console.log("no match last gist commit, will check change",syncConfig.lastGistCommit),sync.checkChange()}))):state.get({syncOptions:"",lastGistCommit:""}).then((function(syncConfig){var _ref3;if(syncConfig.lastGistCommit!==lastGistCommit)return"pristine"===(_ref3=syncConfig.syncOptions)||"conflict"===_ref3?state.set({syncOptions:"conflict"}).then((function(){return options.setOptionsSync(!0,{gistId:gistId,gistToken:gistToken,useBuiltInSync:!0,force:!0})})):void 0}))})),(tabs=new OmegaTargetCurrent.ChromeTabs(actionForUrl)).watch(),options._inspect=new OmegaTargetCurrent.Inspect((function(url,tab){return url===tab.url?(options.clearBadge(),tabs.processTab(tab),void state.remove("inspectUrl")):(state.set({inspectUrl:url}),actionForUrl(url).then((function(action){var parsedUrl,title,urlDisp;if(action)return urlDisp=(parsedUrl=OmegaTargetCurrent.Url.parse(url)).hostname===OmegaTargetCurrent.Url.parse(tab.url).hostname?parsedUrl.path:parsedUrl.hostname,title=chrome.i18n.getMessage("browserAction_titleInspect",urlDisp)+"\n",title+=action.title,chrome.action.setTitle({title:title,tabId:tab.id}),tabs.setTabBadge(tab,{text:"#",color:action.resultColor})})))})),options.setProxyNotControllable(null),timeout=null,proxyImpl.watchProxyChange((function(details){var internal,noRevert,notControllableBefore,parsed,reason;if(!options.externalApi.disabled&&details){switch(notControllableBefore=options.proxyNotControllable(),internal=!1,noRevert=!1,details.levelOfControl){case"controlled_by_other_extensions":case"not_controllable":reason="not_controllable"===details.levelOfControl?"policy":"app",options.setProxyNotControllable(reason),noRevert=!0;break;default:options.setProxyNotControllable(null)}("controlled_by_this_extension"!==details.levelOfControl||(internal=!0,notControllableBefore))&&(Log.log("external proxy: ",details),null!=timeout&&clearTimeout(timeout),parsed=null,timeout=setTimeout((function(){if(parsed)return options.setExternalProfile(parsed,{noRevert:noRevert,internal:internal})}),500),parsed=proxyImpl.parseExternalProfile(details,options._options))}})),external=!1,options.currentProfileChanged=function(reason){var current,currentName,details,icon,realCurrentName,shortTitle,title;return iconCache={},"external"===reason?external=!0:"clearBadge"!==reason&&(external=!1),currentName="",(current=options.currentProfile())&&(currentName=dispName(current.name),"VirtualProfile"===current.profileType&&(realCurrentName=current.defaultProfileName,currentName+=" ["+dispName(realCurrentName)+"]",current=options.profile(realCurrentName))),details=options.printProfile(current),currentName?(title=chrome.i18n.getMessage("browserAction_titleWithResult",[currentName,"",details]),shortTitle="Omega: "+currentName):(title=details,shortTitle="Omega: "+details),external&&"SystemProfile"!==current.profileType&&(title=chrome.i18n.getMessage("browserAction_titleExternalProxy")+"\n"+title,shortTitle="Omega-Extern: "+details,options.setBadge()),icon=current.name&&OmegaPac.Profiles.isInclusive(current)?drawIcon(options.profile("direct").color,current.color):drawIcon(current.color),tabs.resetAll({icon:icon,title:title,shortTitle:shortTitle})},encodeError=function(obj){return obj instanceof Error?{_error:"error",name:obj.name,message:obj.message,stack:obj.stack,original:obj}:obj},refreshActivePageIfEnabled=function(){if("false"!==zeroStorage["omega.local.refreshOnProfileChange"])return chrome.tabs.query({active:!0,lastFocusedWindow:!0},(function(tabs){var url;if((url=tabs[0].pendingUrl||tabs[0].url)&&"chrome"!==url.substr(0,6)&&"about:"!==url.substr(0,6)&&"moz-"!==url.substr(0,4))return tabs[0].pendingUrl?chrome.tabs.update(tabs[0].id,{url:url}):chrome.tabs.reload(tabs[0].id,{bypassCache:!0})}))},resetAllOptions=function(){return options.ready.then((function(){return"function"==typeof options._watchStop&&options._watchStop(),"function"==typeof options._syncWatchStop&&options._syncWatchStop(),Promise.all([chrome.storage.sync.clear(),chrome.storage.local.clear()])}))},chrome.runtime.onMessage.addListener((function(request,sender,respond){if(request&&request.method)return options.ready.then((function(){var method,promise,target;return"resetAllOptions"===request.method?(target=globalThis,method=resetAllOptions):"getState"===request.method?(target=state,method=state.get):"setState"===request.method?(target=state,method=state.set):method=(target=options)[request.method],"function"!=typeof method?(Log.error("No such method "+request.method+"!"),void respond({error:{reason:"noSuchMethod"}})):(promise=Promise.resolve().then((function(){return method.apply(target,request.args)})),request.refreshActivePage&&promise.then(refreshActivePageIfEnabled),request.noReply?void 0:(promise.then((function(result){var key,value;if("updateProfile"===request.method)for(key in result)__hasProp.call(result,key)&&(value=result[key],result[key]=encodeError(value));return respond({result:result})})),promise.catch((function(error){return Log.error(request.method+" ==>",error),respond({error:encodeError(error)})}))))})),!request.noReply||void 0}))},globalThis.zeroBackground=zeroBackground}).call(this);