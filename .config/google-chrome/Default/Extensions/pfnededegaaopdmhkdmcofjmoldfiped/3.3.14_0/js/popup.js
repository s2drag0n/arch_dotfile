(function(){var customProfiles,i,module,moveDown,moveUp,shortcutKeys,_i,_customProfiles,__hasProp={}.hasOwnProperty;for((module=angular.module("omegaPopup",["omegaTarget","omegaDecoration","ui.bootstrap","ui.validate"])).filter("tr",(function(omegaTarget){return omegaTarget.getMessage})),module.filter("dispName",(function(omegaTarget){return function(name){return"object"==typeof name&&(name=name.name),omegaTarget.getMessage("profile_"+name)||name}})),moveUp=function(activeIndex,items){var i,_ref;if((i=activeIndex-1)>=0)return null!=(_ref=items.eq(i)[0])?_ref.focus():void 0},shortcutKeys={38:moveUp,40:moveDown=function(activeIndex,items){var _ref;return null!=(_ref=items.eq(activeIndex+1)[0])?_ref.focus():void 0},74:moveDown,75:moveUp,48:"+direct",83:"+system",191:"help",63:"help",69:"external",65:"addRule",43:"addRule",61:"addRule",84:"tempRule",79:"option",82:"requestInfo"},i=_i=1;_i<=9;i=++_i)shortcutKeys[48+i]=i;_customProfiles=null,customProfiles=function(){return null!=_customProfiles?_customProfiles:_customProfiles=jQuery(".custom-profile:not(.ng-hide) > a")},jQuery(document).on("keydown",(function(e){var handler,items,key,keys,shortcut,showHelp,_ref,_ref1;if((handler=shortcutKeys[e.keyCode])&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName){switch(typeof handler){case"string":if("help"===handler){for(shortcut in showHelp=function(element,key){var span;return"string"==typeof element&&(element=jQuery("a[data-shortcut='"+element+"']")),0===(span=jQuery(".shortcut-help",element)).length&&(span=jQuery("<span/>").addClass("shortcut-help")),span.text(key),element.find(".glyphicon").after(span)},keys={"+direct":"0","+system":"S",external:"E",addRule:"A",tempRule:"T",option:"O",requestInfo:"R"})key=keys[shortcut],showHelp(shortcut,key);customProfiles().each((function(i,el){if(i<=8)return showHelp(jQuery(el),i+1)}))}else null!=(_ref=jQuery("a[data-shortcut='"+handler+"']")[0])&&_ref.click();break;case"number":null!=(_ref1=customProfiles().eq(handler-1))&&_ref1.click();break;case"function":items=jQuery(".popup-menu-nav > li:not(.ng-hide) > a"),-1===(i=items.index(jQuery(e.target).closest("a")))&&(i=items.index(jQuery(".popup-menu-nav > li.active > a"))),handler(i,items)}return!1}})),module.controller("PopupCtrl",(function($scope,$window,$q,omegaTarget,profileIcons,profileOrder,dispNameFilter,getVirtualTarget){var preselectedProfileNameForCondition,refresh,refreshOnProfileChange;return omegaTarget.state("customCss").then((function(customCss){return null==customCss&&(customCss=""),$scope.customCss=customCss})),$scope.closePopup=function(){return $window.top.close()},$scope.openManage=function(){return omegaTarget.openManage(),$window.top.close()},refreshOnProfileChange=!1,refresh=function(){return refreshOnProfileChange?omegaTarget.refreshActivePage().then((function(){return $window.top.close()})):$window.top.close()},$scope.profileIcons=profileIcons,$scope.dispNameFilter=dispNameFilter,$scope.isActive=function(profileName){return $scope.isSystemProfile?"system"===profileName:$scope.currentProfileName===profileName},$scope.isEffective=function(profileName){return $scope.isSystemProfile&&$scope.currentProfileName===profileName},$scope.getIcon=function(profile,normal){if(profile)return!normal&&$scope.isEffective(profile.name)?"glyphicon-ok":void 0},$scope.getProfileTitle=function(profile,normal){var desc;for(desc="";profile;)desc=profile.desc,profile=getVirtualTarget(profile,$scope.availableProfiles);return desc||(null!=profile?profile.name:void 0)||""},$scope.openOptions=function(hash){return omegaTarget.openOptions(hash).then((function(){return $window.top.close()}))},$scope.openConditionHelp=function(){var pname;return pname=encodeURIComponent($scope.currentProfileName),$scope.openOptions("#/profile/"+pname+"?help=condition")},$scope.applyProfile=function(profile){var apply,next;return next=function(){if("SwitchProfile"===profile.profileType)return omegaTarget.state("web.switchGuide").then((function(switchGuide){if("showOnFirstUse"===switchGuide)return $scope.openOptions("#/profile/"+profile.name)}))},refreshOnProfileChange?apply=omegaTarget.applyProfile(profile.name).then((function(){return omegaTarget.refreshActivePage()})).then(next):(omegaTarget.applyProfileNoReply(profile.name),apply=next()),apply?apply.then((function(){return $window.top.close()})):$window.top.close()},$scope.tempRuleMenu={open:!1},$scope.nameExternal={open:!1},$scope.addTempRule=function(domain,profileName){return $scope.tempRuleMenu.open=!1,omegaTarget.addTempRule(domain,profileName).then((function(){return omegaTarget.state("lastProfileNameForCondition",profileName),refresh()}))},$scope.setDefaultProfile=function(profileName,defaultProfileName){return omegaTarget.setDefaultProfile(profileName,defaultProfileName).then((function(){return refresh()}))},$scope.addCondition=function(condition,profileName){return omegaTarget.addCondition(condition,profileName).then((function(){return omegaTarget.state("lastProfileNameForCondition",profileName),refresh()}))},$scope.addConditionForDomains=function(domains,profileName){var conditions,domain;for(domain in conditions=[],domains)__hasProp.call(domains,domain)&&domains[domain]&&conditions.push({conditionType:"HostWildcardCondition",pattern:domain});return omegaTarget.addCondition(conditions,profileName).then((function(){return omegaTarget.state("lastProfileNameForCondition",profileName),refresh()}))},$scope.addTempConditionForDomains=function(domains,profileName){var domain,promises;for(domain in[],promises=[],domains)__hasProp.call(domains,domain)&&domains[domain]&&promises.push(omegaTarget.addTempRule(domain.substring(2),profileName,1));return Promise.all(promises).then((function(){return omegaTarget.state("lastProfileNameForCondition",profileName),refresh()}))},$scope.validateProfileName={conflict:'!$value || !availableProfiles["+" + $value]',hidden:'!$value || $value[0] != "_"'},$scope.saveExternal=function(){var name,_ref;if($scope.nameExternal.open=!1,name=null!=(_ref=$scope.externalProfile)?_ref.name:void 0)return omegaTarget.addProfile($scope.externalProfile).then((function(){return omegaTarget.applyProfile(name).then((function(){return refresh()}))}))},$scope.returnToMenu=function(){if(!(location.hash.indexOf("!")>=0))return $scope.showConditionForm=!1,$scope.showRequestInfo=!1;location.href="popup/index.html"},preselectedProfileNameForCondition="direct","#!requestInfo"===$window.location.hash?$scope.showRequestInfo=!0:"#!external"===$window.location.hash&&($scope.nameExternal={open:!0}),omegaTarget.state(["availableProfiles","currentProfileName","isSystemProfile","validResultProfiles","refreshOnProfileChange","externalProfile","proxyNotControllable","lastProfileNameForCondition"]).then((function(_arg){var availableProfiles,charCodeUnderscore,currentProfileName,externalProfile,isSystemProfile,key,lastProfileNameForCondition,profile,profilesByNames,proxyNotControllable,refresh,validResultProfiles,_j,_len,_ref;if(availableProfiles=_arg[0],currentProfileName=_arg[1],isSystemProfile=_arg[2],validResultProfiles=_arg[3],refresh=_arg[4],externalProfile=_arg[5],proxyNotControllable=_arg[6],lastProfileNameForCondition=_arg[7],$scope.proxyNotControllable=proxyNotControllable,!proxyNotControllable){if($scope.availableProfiles=availableProfiles,$scope.currentProfile=availableProfiles["+"+currentProfileName],$scope.currentProfileName=currentProfileName,$scope.isSystemProfile=isSystemProfile,$scope.externalProfile=externalProfile,refreshOnProfileChange=refresh,charCodeUnderscore="_".charCodeAt(0),profilesByNames=function(names){var name,profiles,_j,_len;for(profiles=[],_j=0,_len=names.length;_j<_len;_j++)((name=names[_j]).charCodeAt(0)!==charCodeUnderscore||name.charCodeAt(1)!==charCodeUnderscore)&&profiles.push(availableProfiles["+"+name]);return profiles},$scope.validResultProfiles=profilesByNames(validResultProfiles),lastProfileNameForCondition)for(_j=0,_len=(_ref=$scope.validResultProfiles).length;_j<_len;_j++)(profile=_ref[_j]).name===lastProfileNameForCondition&&(preselectedProfileNameForCondition=lastProfileNameForCondition);for(key in $scope.builtinProfiles=[],$scope.customProfiles=[],availableProfiles)__hasProp.call(availableProfiles,key)&&((profile=availableProfiles[key]).builtin?$scope.builtinProfiles.push(profile):profile.name.charCodeAt(0)!==charCodeUnderscore&&$scope.customProfiles.push(profile),profile.validResultProfiles&&(profile.validResultProfiles=profilesByNames(profile.validResultProfiles)));return $scope.customProfiles.sort(profileOrder)}})),$scope.domainsForCondition={},$scope.requestInfoProvided=null,omegaTarget.setRequestInfoCallback((function(info){var domain,domainInfo,_ref;for(domain in info.domains=[],_ref=info.summary)__hasProp.call(_ref,domain)&&((domainInfo=_ref[domain]).domain=domain,info.domains.push(domainInfo));return info.domains.sort((function(a,b){return b.errorCount-a.errorCount})),$scope.$apply((function(){var _base,_j,_len,_name,_ref1;for($scope.requestInfo=info,null==$scope.requestInfoProvided&&($scope.requestInfoProvided=(null!=info?info.domains.length:void 0)>0),_j=0,_len=(_ref1=info.domains).length;_j<_len;_j++)domain=_ref1[_j],null==(_base=$scope.domainsForCondition)[_name=domain.domain]&&(_base[_name]=!0);return null!=$scope.profileForDomains?$scope.profileForDomains:$scope.profileForDomains=preselectedProfileNameForCondition}))})),$q.all([omegaTarget.state("currentProfileCanAddRule"),omegaTarget.getActivePageInfo()]).then((function(_arg){var canAddRule,info;if(canAddRule=_arg[0],info=_arg[1],$scope.currentProfileCanAddRule=canAddRule,info&&($scope.currentTempRuleProfile=info.tempRuleProfileName,$scope.currentTempRuleProfile&&(preselectedProfileNameForCondition=$scope.currentTempRuleProfile),$scope.currentDomain=info.domain,"#!addRule"===$window.location.hash))return $scope.prepareConditionForm()})),$scope.prepareConditionForm=function(){var conditionSuggestion,currentDomain,currentDomainEscaped,domainLooksLikeIp;return currentDomainEscaped=(currentDomain=$scope.currentDomain).replace(/\./g,"\\."),domainLooksLikeIp=!1,currentDomain.indexOf(":")>=0?(domainLooksLikeIp=!0,"["!==currentDomain[0]&&(currentDomainEscaped=(currentDomain="["+currentDomain+"]").replace(/\./g,"\\.").replace(/\[/g,"\\[").replace(/\]/g,"\\]"))):currentDomain[currentDomain.length-1]>=0&&(domainLooksLikeIp=!0),conditionSuggestion=domainLooksLikeIp?{HostWildcardCondition:currentDomain,HostRegexCondition:"^"+currentDomainEscaped+"$",UrlWildcardCondition:"*://"+currentDomain+"/*",UrlRegexCondition:"://"+currentDomainEscaped+"(:\\d+)?/",KeywordCondition:currentDomain}:{HostWildcardCondition:"*."+currentDomain,HostRegexCondition:"(^|\\.)"+currentDomainEscaped+"$",UrlWildcardCondition:"*://*."+currentDomain+"/*",UrlRegexCondition:"://([^/.]+\\.)*"+currentDomainEscaped+"(:\\d+)?/",KeywordCondition:currentDomain},$scope.rule={condition:{conditionType:"HostWildcardCondition",pattern:conditionSuggestion.HostWildcardCondition},profileName:preselectedProfileNameForCondition},$scope.$watch("rule.condition.conditionType",(function(type){return $scope.rule.condition.pattern=conditionSuggestion[type]})),$scope.showConditionForm=!0}}))}).call(this);