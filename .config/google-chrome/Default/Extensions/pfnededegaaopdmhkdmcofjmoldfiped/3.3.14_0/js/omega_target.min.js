!function(f){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=f();else if("function"==typeof define&&define.amd)define([],f);else{("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).OmegaTarget=f()}}((function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof require&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,(function(e){var n=t[o][1][e];return s(n||e)}),l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof require&&require,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var lookup="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";!function(exports){"use strict";var Arr="undefined"!=typeof Uint8Array?Uint8Array:Array,PLUS="+".charCodeAt(0),SLASH="/".charCodeAt(0),NUMBER="0".charCodeAt(0),LOWER="a".charCodeAt(0),UPPER="A".charCodeAt(0),PLUS_URL_SAFE="-".charCodeAt(0),SLASH_URL_SAFE="_".charCodeAt(0);function decode(elt){var code=elt.charCodeAt(0);return code===PLUS||code===PLUS_URL_SAFE?62:code===SLASH||code===SLASH_URL_SAFE?63:code<NUMBER?-1:code<NUMBER+10?code-NUMBER+26+26:code<UPPER+26?code-UPPER:code<LOWER+26?code-LOWER+26:void 0}function b64ToByteArray(b64){var i,j,l,tmp,placeHolders,arr;if(b64.length%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var len=b64.length;placeHolders="="===b64.charAt(len-2)?2:"="===b64.charAt(len-1)?1:0,arr=new Arr(3*b64.length/4-placeHolders),l=placeHolders>0?b64.length-4:b64.length;var L=0;function push(v){arr[L++]=v}for(i=0,j=0;i<l;i+=4,j+=3)push((16711680&(tmp=decode(b64.charAt(i))<<18|decode(b64.charAt(i+1))<<12|decode(b64.charAt(i+2))<<6|decode(b64.charAt(i+3))))>>16),push((65280&tmp)>>8),push(255&tmp);return 2===placeHolders?push(255&(tmp=decode(b64.charAt(i))<<2|decode(b64.charAt(i+1))>>4)):1===placeHolders&&(push((tmp=decode(b64.charAt(i))<<10|decode(b64.charAt(i+1))<<4|decode(b64.charAt(i+2))>>2)>>8&255),push(255&tmp)),arr}function uint8ToBase64(uint8){var i,temp,length,extraBytes=uint8.length%3,output="";function encode(num){return lookup.charAt(num)}function tripletToBase64(num){return encode(num>>18&63)+encode(num>>12&63)+encode(num>>6&63)+encode(63&num)}for(i=0,length=uint8.length-extraBytes;i<length;i+=3)output+=tripletToBase64(temp=(uint8[i]<<16)+(uint8[i+1]<<8)+uint8[i+2]);switch(extraBytes){case 1:output+=encode((temp=uint8[uint8.length-1])>>2),output+=encode(temp<<4&63),output+="==";break;case 2:output+=encode((temp=(uint8[uint8.length-2]<<8)+uint8[uint8.length-1])>>10),output+=encode(temp>>4&63),output+=encode(temp<<2&63),output+="="}return output}exports.toByteArray=b64ToByteArray,exports.fromByteArray=uint8ToBase64}(void 0===exports?this.base64js={}:exports)},{}],2:[function(require,module,exports){(function(process,global){!function(e){if("object"==typeof exports&&void 0!==module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var f;"undefined"!=typeof window?f=window:void 0!==global?f=global:"undefined"!=typeof self&&(f=self),f.Promise=e()}}((function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a="function"==typeof _dereq_&&_dereq_;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,(function(e){var n=t[o][1][e];return s(n||e)}),l,l.exports,e,t,n,r)}return n[o].exports}for(var i="function"==typeof _dereq_&&_dereq_,o=0;o<r.length;o++)s(r[o]);return s}({1:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise){var SomePromiseArray=Promise._SomePromiseArray;function any(promises){var ret=new SomePromiseArray(promises),promise=ret.promise();return ret.setHowMany(1),ret.setUnwrap(),ret.init(),promise}Promise.any=function(promises){return any(promises)},Promise.prototype.any=function(){return any(this)}}},{}],2:[function(_dereq_,module,exports){"use strict";var firstLineError;try{throw new Error}catch(e){firstLineError=e}var schedule=_dereq_("./schedule.js"),Queue=_dereq_("./queue.js"),util=_dereq_("./util.js");function Async(){this._isTickUsed=!1,this._lateQueue=new Queue(16),this._normalQueue=new Queue(16),this._trampolineEnabled=!0;var self=this;this.drainQueues=function(){self._drainQueues()},this._schedule=schedule.isStatic?schedule(this.drainQueues):schedule}function AsyncInvokeLater(fn,receiver,arg){this._lateQueue.push(fn,receiver,arg),this._queueTick()}function AsyncInvoke(fn,receiver,arg){this._normalQueue.push(fn,receiver,arg),this._queueTick()}function AsyncSettlePromises(promise){this._normalQueue._pushOne(promise),this._queueTick()}Async.prototype.disableTrampolineIfNecessary=function(){util.hasDevTools&&(this._trampolineEnabled=!1)},Async.prototype.enableTrampoline=function(){this._trampolineEnabled||(this._trampolineEnabled=!0,this._schedule=function(fn){setTimeout(fn,0)})},Async.prototype.haveItemsQueued=function(){return this._normalQueue.length()>0},Async.prototype.throwLater=function(fn,arg){if(1===arguments.length&&(arg=fn,fn=function(){throw arg}),"undefined"!=typeof setTimeout)setTimeout((function(){fn(arg)}),0);else try{this._schedule((function(){fn(arg)}))}catch(e){throw new Error("No async scheduler available\n\n    See http://goo.gl/m3OTXk\n")}},util.hasDevTools?(schedule.isStatic&&(schedule=function(fn){setTimeout(fn,0)}),Async.prototype.invokeLater=function(fn,receiver,arg){this._trampolineEnabled?AsyncInvokeLater.call(this,fn,receiver,arg):this._schedule((function(){setTimeout((function(){fn.call(receiver,arg)}),100)}))},Async.prototype.invoke=function(fn,receiver,arg){this._trampolineEnabled?AsyncInvoke.call(this,fn,receiver,arg):this._schedule((function(){fn.call(receiver,arg)}))},Async.prototype.settlePromises=function(promise){this._trampolineEnabled?AsyncSettlePromises.call(this,promise):this._schedule((function(){promise._settlePromises()}))}):(Async.prototype.invokeLater=AsyncInvokeLater,Async.prototype.invoke=AsyncInvoke,Async.prototype.settlePromises=AsyncSettlePromises),Async.prototype.invokeFirst=function(fn,receiver,arg){this._normalQueue.unshift(fn,receiver,arg),this._queueTick()},Async.prototype._drainQueue=function(queue){for(;queue.length()>0;){var fn=queue.shift();if("function"==typeof fn){var receiver=queue.shift(),arg=queue.shift();fn.call(receiver,arg)}else fn._settlePromises()}},Async.prototype._drainQueues=function(){this._drainQueue(this._normalQueue),this._reset(),this._drainQueue(this._lateQueue)},Async.prototype._queueTick=function(){this._isTickUsed||(this._isTickUsed=!0,this._schedule(this.drainQueues))},Async.prototype._reset=function(){this._isTickUsed=!1},module.exports=new Async,module.exports.firstLineError=firstLineError},{"./queue.js":28,"./schedule.js":31,"./util.js":38}],3:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL,tryConvertToPromise){var rejectThis=function(_,e){this._reject(e)},targetRejected=function(e,context){context.promiseRejectionQueued=!0,context.bindingPromise._then(rejectThis,rejectThis,null,this,e)},bindingResolved=function(thisArg,context){this._isPending()&&this._resolveCallback(context.target)},bindingRejected=function(e,context){context.promiseRejectionQueued||this._reject(e)};Promise.prototype.bind=function(thisArg){var maybePromise=tryConvertToPromise(thisArg),ret=new Promise(INTERNAL);ret._propagateFrom(this,1);var target=this._target();if(ret._setBoundTo(maybePromise),maybePromise instanceof Promise){var context={promiseRejectionQueued:!1,promise:ret,target:target,bindingPromise:maybePromise};target._then(INTERNAL,targetRejected,ret._progress,ret,context),maybePromise._then(bindingResolved,bindingRejected,ret._progress,ret,context)}else ret._resolveCallback(target);return ret},Promise.prototype._setBoundTo=function(obj){void 0!==obj?(this._bitField=131072|this._bitField,this._boundTo=obj):this._bitField=-131073&this._bitField},Promise.prototype._isBound=function(){return 131072==(131072&this._bitField)},Promise.bind=function(thisArg,value){var maybePromise=tryConvertToPromise(thisArg),ret=new Promise(INTERNAL);return ret._setBoundTo(maybePromise),maybePromise instanceof Promise?maybePromise._then((function(){ret._resolveCallback(value)}),ret._reject,ret._progress,ret,null):ret._resolveCallback(value),ret}}},{}],4:[function(_dereq_,module,exports){"use strict";var old;function noConflict(){try{Promise===bluebird&&(Promise=old)}catch(e){}return bluebird}"undefined"!=typeof Promise&&(old=Promise);var bluebird=_dereq_("./promise.js")();bluebird.noConflict=noConflict,module.exports=bluebird},{"./promise.js":23}],5:[function(_dereq_,module,exports){"use strict";var cr=Object.create;if(cr){var callerCache=cr(null),getterCache=cr(null);callerCache[" size"]=getterCache[" size"]=0}module.exports=function(Promise){var getGetter,util=_dereq_("./util.js"),canEvaluate=util.canEvaluate;util.isIdentifier;function ensureMethod(obj,methodName){var fn;if(null!=obj&&(fn=obj[methodName]),"function"!=typeof fn){var message="Object "+util.classString(obj)+" has no method '"+util.toString(methodName)+"'";throw new Promise.TypeError(message)}return fn}function caller(obj){return ensureMethod(obj,this.pop()).apply(obj,this)}function namedGetter(obj){return obj[this]}function indexedGetter(obj){var index=+this;return index<0&&(index=Math.max(0,index+obj.length)),obj[index]}Promise.prototype.call=function(methodName){for(var $_len=arguments.length,args=new Array($_len-1),$_i=1;$_i<$_len;++$_i)args[$_i-1]=arguments[$_i];return args.push(methodName),this._then(caller,void 0,void 0,args,void 0)},Promise.prototype.get=function(propertyName){var getter;if("number"==typeof propertyName)getter=indexedGetter;else if(canEvaluate){var maybeGetter=getGetter(propertyName);getter=null!==maybeGetter?maybeGetter:namedGetter}else getter=namedGetter;return this._then(getter,void 0,void 0,propertyName,void 0)}}},{"./util.js":38}],6:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise){var errors=_dereq_("./errors.js"),async=_dereq_("./async.js"),CancellationError=errors.CancellationError;Promise.prototype._cancel=function(reason){if(!this.isCancellable())return this;for(var parent,promiseToReject=this;void 0!==(parent=promiseToReject._cancellationParent)&&parent.isCancellable();)promiseToReject=parent;this._unsetCancellable(),promiseToReject._target()._rejectCallback(reason,!1,!0)},Promise.prototype.cancel=function(reason){return this.isCancellable()?(void 0===reason&&(reason=new CancellationError),async.invokeLater(this._cancel,this,reason),this):this},Promise.prototype.cancellable=function(){return this._cancellable()||(async.enableTrampoline(),this._setCancellable(),this._cancellationParent=void 0),this},Promise.prototype.uncancellable=function(){var ret=this.then();return ret._unsetCancellable(),ret},Promise.prototype.fork=function(didFulfill,didReject,didProgress){var ret=this._then(didFulfill,didReject,didProgress,void 0,void 0);return ret._setCancellable(),ret._cancellationParent=void 0,ret}}},{"./async.js":2,"./errors.js":13}],7:[function(_dereq_,module,exports){"use strict";module.exports=function(){var warn,async=_dereq_("./async.js"),util=_dereq_("./util.js"),bluebirdFramePattern=/[\\\/]bluebird[\\\/]js[\\\/](main|debug|zalgo|instrumented)/,stackFramePattern=null,formatStack=null,indentStackFrames=!1;function CapturedTrace(parent){this._parent=parent;var length=this._length=1+(void 0===parent?0:parent._length);captureStackTrace(this,CapturedTrace),length>32&&this.uncycle()}function reconstructStack(message,stacks){for(var i=0;i<stacks.length-1;++i)stacks[i].push("From previous event:"),stacks[i]=stacks[i].join("\n");return i<stacks.length&&(stacks[i]=stacks[i].join("\n")),message+"\n"+stacks.join("\n")}function removeDuplicateOrEmptyJumps(stacks){for(var i=0;i<stacks.length;++i)(0===stacks[i].length||i+1<stacks.length&&stacks[i][0]===stacks[i+1][0])&&(stacks.splice(i,1),i--)}function removeCommonRoots(stacks){for(var current=stacks[0],i=1;i<stacks.length;++i){for(var prev=stacks[i],currentLastIndex=current.length-1,currentLastLine=current[currentLastIndex],commonRootMeetPoint=-1,j=prev.length-1;j>=0;--j)if(prev[j]===currentLastLine){commonRootMeetPoint=j;break}for(j=commonRootMeetPoint;j>=0;--j){var line=prev[j];if(current[currentLastIndex]!==line)break;current.pop(),currentLastIndex--}current=prev}}function cleanStack(stack){for(var ret=[],i=0;i<stack.length;++i){var line=stack[i],isTraceLine=stackFramePattern.test(line)||"    (No stack trace)"===line,isInternalFrame=isTraceLine&&shouldIgnore(line);isTraceLine&&!isInternalFrame&&(indentStackFrames&&" "!==line.charAt(0)&&(line="    "+line),ret.push(line))}return ret}function stackFramesAsArray(error){for(var stack=error.stack.replace(/\s+$/g,"").split("\n"),i=0;i<stack.length;++i){var line=stack[i];if("    (No stack trace)"===line||stackFramePattern.test(line))break}return i>0&&(stack=stack.slice(i)),stack}function formatNonError(obj){var str;if("function"==typeof obj)str="[function "+(obj.name||"anonymous")+"]";else{if(str=obj.toString(),/\[object [a-zA-Z0-9$_]+\]/.test(str))try{str=JSON.stringify(obj)}catch(e){}0===str.length&&(str="(empty array)")}return"(<"+snip(str)+">, no stack trace)"}function snip(str){var maxChars=41;return str.length<maxChars?str:str.substr(0,maxChars-3)+"..."}util.inherits(CapturedTrace,Error),CapturedTrace.prototype.uncycle=function(){var length=this._length;if(!(length<2)){for(var nodes=[],stackToIndex={},i=0,node=this;void 0!==node;++i)nodes.push(node),node=node._parent;for(i=(length=this._length=i)-1;i>=0;--i){var stack=nodes[i].stack;void 0===stackToIndex[stack]&&(stackToIndex[stack]=i)}for(i=0;i<length;++i){var index=stackToIndex[nodes[i].stack];if(void 0!==index&&index!==i){index>0&&(nodes[index-1]._parent=void 0,nodes[index-1]._length=1),nodes[i]._parent=void 0,nodes[i]._length=1;var cycleEdgeNode=i>0?nodes[i-1]:this;index<length-1?(cycleEdgeNode._parent=nodes[index+1],cycleEdgeNode._parent.uncycle(),cycleEdgeNode._length=cycleEdgeNode._parent._length+1):(cycleEdgeNode._parent=void 0,cycleEdgeNode._length=1);for(var currentChildLength=cycleEdgeNode._length+1,j=i-2;j>=0;--j)nodes[j]._length=currentChildLength,currentChildLength++;return}}}},CapturedTrace.prototype.parent=function(){return this._parent},CapturedTrace.prototype.hasParent=function(){return void 0!==this._parent},CapturedTrace.prototype.attachExtraTrace=function(error){if(!error.__stackCleaned__){this.uncycle();for(var parsed=CapturedTrace.parseStackAndMessage(error),message=parsed.message,stacks=[parsed.stack],trace=this;void 0!==trace;)stacks.push(cleanStack(trace.stack.split("\n"))),trace=trace._parent;removeCommonRoots(stacks),removeDuplicateOrEmptyJumps(stacks),util.notEnumerableProp(error,"stack",reconstructStack(message,stacks)),util.notEnumerableProp(error,"__stackCleaned__",!0)}},CapturedTrace.parseStackAndMessage=function(error){var stack=error.stack;return{message:error.toString(),stack:cleanStack(stack="string"==typeof stack&&stack.length>0?stackFramesAsArray(error):["    (No stack trace)"])}},CapturedTrace.formatAndLogError=function(error,title){if("undefined"!=typeof console){var message;if("object"==typeof error||"function"==typeof error){var stack=error.stack;message=title+formatStack(stack,error)}else message=title+String(error);"function"==typeof warn?warn(message):"function"!=typeof console.log&&"object"!=typeof console.log||console.log(message)}},CapturedTrace.unhandledRejection=function(reason){CapturedTrace.formatAndLogError(reason,"^--- With additional stack trace: ")},CapturedTrace.isSupported=function(){return"function"==typeof captureStackTrace},CapturedTrace.fireRejectionEvent=function(name,localHandler,reason,promise){var localEventFired=!1;try{"function"==typeof localHandler&&(localEventFired=!0,"rejectionHandled"===name?localHandler(promise):localHandler(reason,promise))}catch(e){async.throwLater(e)}var globalEventFired=!1;try{globalEventFired=fireGlobalEvent(name,reason,promise)}catch(e){globalEventFired=!0,async.throwLater(e)}var domEventFired=!1;if(fireDomEvent)try{domEventFired=fireDomEvent(name.toLowerCase(),{reason:reason,promise:promise})}catch(e){domEventFired=!0,async.throwLater(e)}globalEventFired||localEventFired||domEventFired||"unhandledRejection"!==name||CapturedTrace.formatAndLogError(reason,"Unhandled rejection ")};var shouldIgnore=function(){return!1},parseLineInfoRegex=/[\/<\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/;function parseLineInfo(line){var matches=line.match(parseLineInfoRegex);if(matches)return{fileName:matches[1],line:parseInt(matches[2],10)}}CapturedTrace.setBounds=function(firstLineError,lastLineError){if(CapturedTrace.isSupported()){for(var firstFileName,lastFileName,firstStackLines=firstLineError.stack.split("\n"),lastStackLines=lastLineError.stack.split("\n"),firstIndex=-1,lastIndex=-1,i=0;i<firstStackLines.length;++i){if(result=parseLineInfo(firstStackLines[i])){firstFileName=result.fileName,firstIndex=result.line;break}}for(i=0;i<lastStackLines.length;++i){var result;if(result=parseLineInfo(lastStackLines[i])){lastFileName=result.fileName,lastIndex=result.line;break}}firstIndex<0||lastIndex<0||!firstFileName||!lastFileName||firstFileName!==lastFileName||firstIndex>=lastIndex||(shouldIgnore=function(line){if(bluebirdFramePattern.test(line))return!0;var info=parseLineInfo(line);return!!(info&&info.fileName===firstFileName&&firstIndex<=info.line&&info.line<=lastIndex)})}};var fireDomEvent,captureStackTrace=function(){var v8stackFramePattern=/^\s*at\s*/,v8stackFormatter=function(stack,error){return"string"==typeof stack?stack:void 0!==error.name&&void 0!==error.message?error.toString():formatNonError(error)};if("number"==typeof Error.stackTraceLimit&&"function"==typeof Error.captureStackTrace){Error.stackTraceLimit=Error.stackTraceLimit+6,stackFramePattern=v8stackFramePattern,formatStack=v8stackFormatter;var captureStackTrace=Error.captureStackTrace;return shouldIgnore=function(line){return bluebirdFramePattern.test(line)},function(receiver,ignoreUntil){Error.stackTraceLimit=Error.stackTraceLimit+6,captureStackTrace(receiver,ignoreUntil),Error.stackTraceLimit=Error.stackTraceLimit-6}}var hasStackAfterThrow,err=new Error;if("string"==typeof err.stack&&err.stack.split("\n")[0].indexOf("stackDetection@")>=0)return stackFramePattern=/@/,formatStack=v8stackFormatter,indentStackFrames=!0,function(o){o.stack=(new Error).stack};try{throw new Error}catch(e){hasStackAfterThrow="stack"in e}return!("stack"in err)&&hasStackAfterThrow&&"number"==typeof Error.stackTraceLimit?(stackFramePattern=v8stackFramePattern,formatStack=v8stackFormatter,function(o){Error.stackTraceLimit=Error.stackTraceLimit+6;try{throw new Error}catch(e){o.stack=e.stack}Error.stackTraceLimit=Error.stackTraceLimit-6}):(formatStack=function(stack,error){return"string"==typeof stack?stack:"object"!=typeof error&&"function"!=typeof error||void 0===error.name||void 0===error.message?formatNonError(error):error.toString()},null)}(),fireGlobalEvent=function(){if(util.isNode)return function(name,reason,promise){return"rejectionHandled"===name?process.emit(name,promise):process.emit(name,reason,promise)};var customEventWorks=!1,anyEventWorks=!0;try{var ev=new self.CustomEvent("test");customEventWorks=ev instanceof CustomEvent}catch(e){}if(!customEventWorks)try{var event=document.createEvent("CustomEvent");event.initCustomEvent("testingtheevent",!1,!0,{}),self.dispatchEvent(event)}catch(e){anyEventWorks=!1}anyEventWorks&&(fireDomEvent=function(type,detail){var event;return customEventWorks?event=new self.CustomEvent(type,{detail:detail,bubbles:!1,cancelable:!0}):self.dispatchEvent&&(event=document.createEvent("CustomEvent")).initCustomEvent(type,!1,!0,detail),!!event&&!self.dispatchEvent(event)});var toWindowMethodNameMap={};return toWindowMethodNameMap.unhandledRejection="onunhandledRejection".toLowerCase(),toWindowMethodNameMap.rejectionHandled="onrejectionHandled".toLowerCase(),function(name,reason,promise){var methodName=toWindowMethodNameMap[name],method=self[methodName];return!!method&&("rejectionHandled"===name?method.call(self,promise):method.call(self,reason,promise),!0)}}();return"undefined"!=typeof console&&void 0!==console.warn&&(warn=function(message){console.warn(message)},util.isNode&&process.stderr.isTTY?warn=function(message){process.stderr.write("[31m"+message+"[39m\n")}:util.isNode||"string"!=typeof(new Error).stack||(warn=function(message){console.warn("%c"+message,"color: red")})),CapturedTrace}},{"./async.js":2,"./util.js":38}],8:[function(_dereq_,module,exports){"use strict";module.exports=function(NEXT_FILTER){var util=_dereq_("./util.js"),errors=_dereq_("./errors.js"),tryCatch=util.tryCatch,errorObj=util.errorObj,keys=_dereq_("./es5.js").keys,TypeError=errors.TypeError;function CatchFilter(instances,callback,promise){this._instances=instances,this._callback=callback,this._promise=promise}function safePredicate(predicate,e){var safeObject={},retfilter=tryCatch(predicate).call(safeObject,e);return retfilter===errorObj?retfilter:keys(safeObject).length?(errorObj.e=new TypeError("Catch filter must inherit from Error or be a simple predicate function\n\n    See http://goo.gl/o84o68\n"),errorObj):retfilter}return CatchFilter.prototype.doFilter=function(e){for(var cb=this._callback,boundTo=this._promise._boundValue(),i=0,len=this._instances.length;i<len;++i){var item=this._instances[i],itemIsErrorType=item===Error||null!=item&&item.prototype instanceof Error;if(itemIsErrorType&&e instanceof item)return(ret=tryCatch(cb).call(boundTo,e))===errorObj?(NEXT_FILTER.e=ret.e,NEXT_FILTER):ret;if("function"==typeof item&&!itemIsErrorType){var ret,shouldHandle=safePredicate(item,e);if(shouldHandle===errorObj){e=errorObj.e;break}if(shouldHandle)return(ret=tryCatch(cb).call(boundTo,e))===errorObj?(NEXT_FILTER.e=ret.e,NEXT_FILTER):ret}}return NEXT_FILTER.e=e,NEXT_FILTER},CatchFilter}},{"./errors.js":13,"./es5.js":14,"./util.js":38}],9:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,CapturedTrace,isDebugging){var contextStack=[];function Context(){this._trace=new CapturedTrace(peekContext())}function createContext(){if(isDebugging())return new Context}function peekContext(){var lastIndex=contextStack.length-1;if(lastIndex>=0)return contextStack[lastIndex]}return Context.prototype._pushContext=function(){isDebugging()&&void 0!==this._trace&&contextStack.push(this._trace)},Context.prototype._popContext=function(){isDebugging()&&void 0!==this._trace&&contextStack.pop()},Promise.prototype._peekContext=peekContext,Promise.prototype._pushContext=Context.prototype._pushContext,Promise.prototype._popContext=Context.prototype._popContext,createContext}},{}],10:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,CapturedTrace){var unhandledRejectionHandled,possiblyUnhandledRejection,getDomain=Promise._getDomain,async=_dereq_("./async.js"),Warning=_dereq_("./errors.js").Warning,util=_dereq_("./util.js"),canAttachTrace=util.canAttachTrace,debugging=util.isNode&&(!!process.env.BLUEBIRD_DEBUG||"development"===process.env.NODE_ENV);return util.isNode&&0==process.env.BLUEBIRD_DEBUG&&(debugging=!1),debugging&&async.disableTrampolineIfNecessary(),Promise.prototype._ignoreRejections=function(){this._unsetRejectionIsUnhandled(),this._bitField=16777216|this._bitField},Promise.prototype._ensurePossibleRejectionHandled=function(){0==(16777216&this._bitField)&&(this._setRejectionIsUnhandled(),async.invokeLater(this._notifyUnhandledRejection,this,void 0))},Promise.prototype._notifyUnhandledRejectionIsHandled=function(){CapturedTrace.fireRejectionEvent("rejectionHandled",unhandledRejectionHandled,void 0,this)},Promise.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var reason=this._getCarriedStackTrace()||this._settledValue;this._setUnhandledRejectionIsNotified(),CapturedTrace.fireRejectionEvent("unhandledRejection",possiblyUnhandledRejection,reason,this)}},Promise.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=524288|this._bitField},Promise.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=-524289&this._bitField},Promise.prototype._isUnhandledRejectionNotified=function(){return(524288&this._bitField)>0},Promise.prototype._setRejectionIsUnhandled=function(){this._bitField=2097152|this._bitField},Promise.prototype._unsetRejectionIsUnhandled=function(){this._bitField=-2097153&this._bitField,this._isUnhandledRejectionNotified()&&(this._unsetUnhandledRejectionIsNotified(),this._notifyUnhandledRejectionIsHandled())},Promise.prototype._isRejectionUnhandled=function(){return(2097152&this._bitField)>0},Promise.prototype._setCarriedStackTrace=function(capturedTrace){this._bitField=1048576|this._bitField,this._fulfillmentHandler0=capturedTrace},Promise.prototype._isCarryingStackTrace=function(){return(1048576&this._bitField)>0},Promise.prototype._getCarriedStackTrace=function(){return this._isCarryingStackTrace()?this._fulfillmentHandler0:void 0},Promise.prototype._captureStackTrace=function(){return debugging&&(this._trace=new CapturedTrace(this._peekContext())),this},Promise.prototype._attachExtraTrace=function(error,ignoreSelf){if(debugging&&canAttachTrace(error)){var trace=this._trace;if(void 0!==trace&&ignoreSelf&&(trace=trace._parent),void 0!==trace)trace.attachExtraTrace(error);else if(!error.__stackCleaned__){var parsed=CapturedTrace.parseStackAndMessage(error);util.notEnumerableProp(error,"stack",parsed.message+"\n"+parsed.stack.join("\n")),util.notEnumerableProp(error,"__stackCleaned__",!0)}}},Promise.prototype._warn=function(message){var warning=new Warning(message),ctx=this._peekContext();if(ctx)ctx.attachExtraTrace(warning);else{var parsed=CapturedTrace.parseStackAndMessage(warning);warning.stack=parsed.message+"\n"+parsed.stack.join("\n")}CapturedTrace.formatAndLogError(warning,"")},Promise.onPossiblyUnhandledRejection=function(fn){var domain=getDomain();possiblyUnhandledRejection="function"==typeof fn?null===domain?fn:domain.bind(fn):void 0},Promise.onUnhandledRejectionHandled=function(fn){var domain=getDomain();unhandledRejectionHandled="function"==typeof fn?null===domain?fn:domain.bind(fn):void 0},Promise.longStackTraces=function(){if(async.haveItemsQueued()&&!1===debugging)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/DT1qyG\n");(debugging=CapturedTrace.isSupported())&&async.disableTrampolineIfNecessary()},Promise.hasLongStackTraces=function(){return debugging&&CapturedTrace.isSupported()},CapturedTrace.isSupported()||(Promise.longStackTraces=function(){},debugging=!1),function(){return debugging}}},{"./async.js":2,"./errors.js":13,"./util.js":38}],11:[function(_dereq_,module,exports){"use strict";var isPrimitive=_dereq_("./util.js").isPrimitive;module.exports=function(Promise){var returner=function(){return this},thrower=function(){throw this},returnUndefined=function(){},throwUndefined=function(){throw void 0},wrapper=function(value,action){return 1===action?function(){throw value}:2===action?function(){return value}:void 0};Promise.prototype.return=Promise.prototype.thenReturn=function(value){return void 0===value?this.then(returnUndefined):isPrimitive(value)?this._then(wrapper(value,2),void 0,void 0,void 0,void 0):(value instanceof Promise&&value._ignoreRejections(),this._then(returner,void 0,void 0,value,void 0))},Promise.prototype.throw=Promise.prototype.thenThrow=function(reason){return void 0===reason?this.then(throwUndefined):isPrimitive(reason)?this._then(wrapper(reason,1),void 0,void 0,void 0,void 0):this._then(thrower,void 0,void 0,reason,void 0)}}},{"./util.js":38}],12:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL){var PromiseReduce=Promise.reduce;Promise.prototype.each=function(fn){return PromiseReduce(this,fn,null,INTERNAL)},Promise.each=function(promises,fn){return PromiseReduce(promises,fn,null,INTERNAL)}}},{}],13:[function(_dereq_,module,exports){"use strict";var _TypeError,_RangeError,es5=_dereq_("./es5.js"),Objectfreeze=es5.freeze,util=_dereq_("./util.js"),inherits=util.inherits,notEnumerableProp=util.notEnumerableProp;function subError(nameProperty,defaultMessage){function SubError(message){if(!(this instanceof SubError))return new SubError(message);notEnumerableProp(this,"message","string"==typeof message?message:defaultMessage),notEnumerableProp(this,"name",nameProperty),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):Error.call(this)}return inherits(SubError,Error),SubError}var Warning=subError("Warning","warning"),CancellationError=subError("CancellationError","cancellation error"),TimeoutError=subError("TimeoutError","timeout error"),AggregateError=subError("AggregateError","aggregate error");try{_TypeError=TypeError,_RangeError=RangeError}catch(e){_TypeError=subError("TypeError","type error"),_RangeError=subError("RangeError","range error")}for(var methods="join pop push shift unshift slice filter forEach some every map indexOf lastIndexOf reduce reduceRight sort reverse".split(" "),i=0;i<methods.length;++i)"function"==typeof Array.prototype[methods[i]]&&(AggregateError.prototype[methods[i]]=Array.prototype[methods[i]]);es5.defineProperty(AggregateError.prototype,"length",{value:0,configurable:!1,writable:!0,enumerable:!0}),AggregateError.prototype.isOperational=!0;var level=0;function OperationalError(message){if(!(this instanceof OperationalError))return new OperationalError(message);notEnumerableProp(this,"name","OperationalError"),notEnumerableProp(this,"message",message),this.cause=message,this.isOperational=!0,message instanceof Error?(notEnumerableProp(this,"message",message.message),notEnumerableProp(this,"stack",message.stack)):Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}AggregateError.prototype.toString=function(){var indent=Array(4*level+1).join(" "),ret="\n"+indent+"AggregateError of:\n";level++,indent=Array(4*level+1).join(" ");for(var i=0;i<this.length;++i){for(var str=this[i]===this?"[Circular AggregateError]":this[i]+"",lines=str.split("\n"),j=0;j<lines.length;++j)lines[j]=indent+lines[j];ret+=(str=lines.join("\n"))+"\n"}return level--,ret},inherits(OperationalError,Error);var errorTypes=Error.__BluebirdErrorTypes__;errorTypes||(errorTypes=Objectfreeze({CancellationError:CancellationError,TimeoutError:TimeoutError,OperationalError:OperationalError,RejectionError:OperationalError,AggregateError:AggregateError}),notEnumerableProp(Error,"__BluebirdErrorTypes__",errorTypes)),module.exports={Error:Error,TypeError:_TypeError,RangeError:_RangeError,CancellationError:errorTypes.CancellationError,OperationalError:errorTypes.OperationalError,TimeoutError:errorTypes.TimeoutError,AggregateError:errorTypes.AggregateError,Warning:Warning}},{"./es5.js":14,"./util.js":38}],14:[function(_dereq_,module,exports){var isES5=function(){"use strict";return void 0===this}();if(isES5)module.exports={freeze:Object.freeze,defineProperty:Object.defineProperty,getDescriptor:Object.getOwnPropertyDescriptor,keys:Object.keys,names:Object.getOwnPropertyNames,getPrototypeOf:Object.getPrototypeOf,isArray:Array.isArray,isES5:isES5,propertyIsWritable:function(obj,prop){var descriptor=Object.getOwnPropertyDescriptor(obj,prop);return!(descriptor&&!descriptor.writable&&!descriptor.set)}};else{var has={}.hasOwnProperty,str={}.toString,proto={}.constructor.prototype,ObjectKeys=function(o){var ret=[];for(var key in o)has.call(o,key)&&ret.push(key);return ret},ObjectGetDescriptor=function(o,key){return{value:o[key]}},ObjectDefineProperty=function(o,key,desc){return o[key]=desc.value,o},ObjectFreeze=function(obj){return obj},ObjectGetPrototypeOf=function(obj){try{return Object(obj).constructor.prototype}catch(e){return proto}},ArrayIsArray=function(obj){try{return"[object Array]"===str.call(obj)}catch(e){return!1}};module.exports={isArray:ArrayIsArray,keys:ObjectKeys,names:ObjectKeys,defineProperty:ObjectDefineProperty,getDescriptor:ObjectGetDescriptor,freeze:ObjectFreeze,getPrototypeOf:ObjectGetPrototypeOf,isES5:isES5,propertyIsWritable:function(){return!0}}}},{}],15:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL){var PromiseMap=Promise.map;Promise.prototype.filter=function(fn,options){return PromiseMap(this,fn,options,INTERNAL)},Promise.filter=function(promises,fn,options){return PromiseMap(promises,fn,options,INTERNAL)}}},{}],16:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,NEXT_FILTER,tryConvertToPromise){var util=_dereq_("./util.js"),isPrimitive=util.isPrimitive,thrower=util.thrower;function returnThis(){return this}function throwThis(){throw this}function return$(r){return function(){return r}}function throw$(r){return function(){throw r}}function promisedFinally(ret,reasonOrValue,isFulfilled){var then;return then=isPrimitive(reasonOrValue)?isFulfilled?return$(reasonOrValue):throw$(reasonOrValue):isFulfilled?returnThis:throwThis,ret._then(then,thrower,void 0,reasonOrValue,void 0)}function finallyHandler(reasonOrValue){var promise=this.promise,handler=this.handler,ret=promise._isBound()?handler.call(promise._boundValue()):handler();if(void 0!==ret){var maybePromise=tryConvertToPromise(ret,promise);if(maybePromise instanceof Promise)return promisedFinally(maybePromise=maybePromise._target(),reasonOrValue,promise.isFulfilled())}return promise.isRejected()?(NEXT_FILTER.e=reasonOrValue,NEXT_FILTER):reasonOrValue}function tapHandler(value){var promise=this.promise,handler=this.handler,ret=promise._isBound()?handler.call(promise._boundValue(),value):handler(value);if(void 0!==ret){var maybePromise=tryConvertToPromise(ret,promise);if(maybePromise instanceof Promise)return promisedFinally(maybePromise=maybePromise._target(),value,!0)}return value}Promise.prototype._passThroughHandler=function(handler,isFinally){if("function"!=typeof handler)return this.then();var promiseAndHandler={promise:this,handler:handler};return this._then(isFinally?finallyHandler:tapHandler,isFinally?finallyHandler:void 0,void 0,promiseAndHandler,void 0)},Promise.prototype.lastly=Promise.prototype.finally=function(handler){return this._passThroughHandler(handler,!0)},Promise.prototype.tap=function(handler){return this._passThroughHandler(handler,!1)}}},{"./util.js":38}],17:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,apiRejection,INTERNAL,tryConvertToPromise){var TypeError=_dereq_("./errors.js").TypeError,util=_dereq_("./util.js"),errorObj=util.errorObj,tryCatch=util.tryCatch,yieldHandlers=[];function promiseFromYieldHandler(value,yieldHandlers,traceParent){for(var i=0;i<yieldHandlers.length;++i){traceParent._pushContext();var result=tryCatch(yieldHandlers[i])(value);if(traceParent._popContext(),result===errorObj){traceParent._pushContext();var ret=Promise.reject(errorObj.e);return traceParent._popContext(),ret}var maybePromise=tryConvertToPromise(result,traceParent);if(maybePromise instanceof Promise)return maybePromise}return null}function PromiseSpawn(generatorFunction,receiver,yieldHandler,stack){(this._promise=new Promise(INTERNAL))._captureStackTrace(),this._stack=stack,this._generatorFunction=generatorFunction,this._receiver=receiver,this._generator=void 0,this._yieldHandlers="function"==typeof yieldHandler?[yieldHandler].concat(yieldHandlers):yieldHandlers}PromiseSpawn.prototype.promise=function(){return this._promise},PromiseSpawn.prototype._run=function(){this._generator=this._generatorFunction.call(this._receiver),this._receiver=this._generatorFunction=void 0,this._next(void 0)},PromiseSpawn.prototype._continue=function(result){if(result===errorObj)return this._promise._rejectCallback(result.e,!1,!0);var value=result.value;if(!0===result.done)this._promise._resolveCallback(value);else{var maybePromise=tryConvertToPromise(value,this._promise);if(!(maybePromise instanceof Promise)&&null===(maybePromise=promiseFromYieldHandler(maybePromise,this._yieldHandlers,this._promise)))return void this._throw(new TypeError("A value %s was yielded that could not be treated as a promise\n\n    See http://goo.gl/4Y4pDk\n\n".replace("%s",value)+"From coroutine:\n"+this._stack.split("\n").slice(1,-7).join("\n")));maybePromise._then(this._next,this._throw,void 0,this,null)}},PromiseSpawn.prototype._throw=function(reason){this._promise._attachExtraTrace(reason),this._promise._pushContext();var result=tryCatch(this._generator.throw).call(this._generator,reason);this._promise._popContext(),this._continue(result)},PromiseSpawn.prototype._next=function(value){this._promise._pushContext();var result=tryCatch(this._generator.next).call(this._generator,value);this._promise._popContext(),this._continue(result)},Promise.coroutine=function(generatorFunction,options){if("function"!=typeof generatorFunction)throw new TypeError("generatorFunction must be a function\n\n    See http://goo.gl/6Vqhm0\n");var yieldHandler=Object(options).yieldHandler,PromiseSpawn$=PromiseSpawn,stack=(new Error).stack;return function(){var generator=generatorFunction.apply(this,arguments),spawn=new PromiseSpawn$(void 0,void 0,yieldHandler,stack);return spawn._generator=generator,spawn._next(void 0),spawn.promise()}},Promise.coroutine.addYieldHandler=function(fn){if("function"!=typeof fn)throw new TypeError("fn must be a function\n\n    See http://goo.gl/916lJJ\n");yieldHandlers.push(fn)},Promise.spawn=function(generatorFunction){if("function"!=typeof generatorFunction)return apiRejection("generatorFunction must be a function\n\n    See http://goo.gl/6Vqhm0\n");var spawn=new PromiseSpawn(generatorFunction,this),ret=spawn.promise();return spawn._run(Promise.spawn),ret}}},{"./errors.js":13,"./util.js":38}],18:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,tryConvertToPromise,INTERNAL){var util=_dereq_("./util.js");util.canEvaluate,util.tryCatch,util.errorObj;Promise.join=function(){var fn,last=arguments.length-1;last>0&&"function"==typeof arguments[last]&&(fn=arguments[last]);for(var $_len=arguments.length,args=new Array($_len),$_i=0;$_i<$_len;++$_i)args[$_i]=arguments[$_i];fn&&args.pop();var ret=new PromiseArray(args).promise();return void 0!==fn?ret.spread(fn):ret}}},{"./util.js":38}],19:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,apiRejection,tryConvertToPromise,INTERNAL){var getDomain=Promise._getDomain,async=_dereq_("./async.js"),util=_dereq_("./util.js"),tryCatch=util.tryCatch,errorObj=util.errorObj,PENDING={},EMPTY_ARRAY=[];function MappingPromiseArray(promises,fn,limit,_filter){this.constructor$(promises),this._promise._captureStackTrace();var domain=getDomain();this._callback=null===domain?fn:domain.bind(fn),this._preservedValues=_filter===INTERNAL?new Array(this.length()):null,this._limit=limit,this._inFlight=0,this._queue=limit>=1?[]:EMPTY_ARRAY,async.invoke(init,this,void 0)}function init(){this._init$(void 0,-2)}function map(promises,fn,options,_filter){var limit="object"==typeof options&&null!==options?options.concurrency:0;return new MappingPromiseArray(promises,fn,limit="number"==typeof limit&&isFinite(limit)&&limit>=1?limit:0,_filter)}util.inherits(MappingPromiseArray,PromiseArray),MappingPromiseArray.prototype._init=function(){},MappingPromiseArray.prototype._promiseFulfilled=function(value,index){var values=this._values,length=this.length(),preservedValues=this._preservedValues,limit=this._limit;if(values[index]===PENDING){if(values[index]=value,limit>=1&&(this._inFlight--,this._drainQueue(),this._isResolved()))return}else{if(limit>=1&&this._inFlight>=limit)return values[index]=value,void this._queue.push(index);null!==preservedValues&&(preservedValues[index]=value);var callback=this._callback,receiver=this._promise._boundValue();this._promise._pushContext();var ret=tryCatch(callback).call(receiver,value,index,length);if(this._promise._popContext(),ret===errorObj)return this._reject(ret.e);var maybePromise=tryConvertToPromise(ret,this._promise);if(maybePromise instanceof Promise){if((maybePromise=maybePromise._target())._isPending())return limit>=1&&this._inFlight++,values[index]=PENDING,maybePromise._proxyPromiseArray(this,index);if(!maybePromise._isFulfilled())return this._reject(maybePromise._reason());ret=maybePromise._value()}values[index]=ret}++this._totalResolved>=length&&(null!==preservedValues?this._filter(values,preservedValues):this._resolve(values))},MappingPromiseArray.prototype._drainQueue=function(){for(var queue=this._queue,limit=this._limit,values=this._values;queue.length>0&&this._inFlight<limit;){if(this._isResolved())return;var index=queue.pop();this._promiseFulfilled(values[index],index)}},MappingPromiseArray.prototype._filter=function(booleans,values){for(var len=values.length,ret=new Array(len),j=0,i=0;i<len;++i)booleans[i]&&(ret[j++]=values[i]);ret.length=j,this._resolve(ret)},MappingPromiseArray.prototype.preservedValues=function(){return this._preservedValues},Promise.prototype.map=function(fn,options){return"function"!=typeof fn?apiRejection("fn must be a function\n\n    See http://goo.gl/916lJJ\n"):map(this,fn,options,null).promise()},Promise.map=function(promises,fn,options,_filter){return"function"!=typeof fn?apiRejection("fn must be a function\n\n    See http://goo.gl/916lJJ\n"):map(promises,fn,options,_filter).promise()}}},{"./async.js":2,"./util.js":38}],20:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL,tryConvertToPromise,apiRejection){var util=_dereq_("./util.js"),tryCatch=util.tryCatch;Promise.method=function(fn){if("function"!=typeof fn)throw new Promise.TypeError("fn must be a function\n\n    See http://goo.gl/916lJJ\n");return function(){var ret=new Promise(INTERNAL);ret._captureStackTrace(),ret._pushContext();var value=tryCatch(fn).apply(this,arguments);return ret._popContext(),ret._resolveFromSyncValue(value),ret}},Promise.attempt=Promise.try=function(fn,args,ctx){if("function"!=typeof fn)return apiRejection("fn must be a function\n\n    See http://goo.gl/916lJJ\n");var ret=new Promise(INTERNAL);ret._captureStackTrace(),ret._pushContext();var value=util.isArray(args)?tryCatch(fn).apply(ctx,args):tryCatch(fn).call(ctx,args);return ret._popContext(),ret._resolveFromSyncValue(value),ret},Promise.prototype._resolveFromSyncValue=function(value){value===util.errorObj?this._rejectCallback(value.e,!1,!0):this._resolveCallback(value,!0)}}},{"./util.js":38}],21:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise){var util=_dereq_("./util.js"),async=_dereq_("./async.js"),tryCatch=util.tryCatch,errorObj=util.errorObj;function spreadAdapter(val,nodeback){var promise=this;if(!util.isArray(val))return successAdapter.call(promise,val,nodeback);var ret=tryCatch(nodeback).apply(promise._boundValue(),[null].concat(val));ret===errorObj&&async.throwLater(ret.e)}function successAdapter(val,nodeback){var receiver=this._boundValue(),ret=void 0===val?tryCatch(nodeback).call(receiver,null):tryCatch(nodeback).call(receiver,null,val);ret===errorObj&&async.throwLater(ret.e)}function errorAdapter(reason,nodeback){var promise=this;if(!reason){var newReason=promise._target()._getCarriedStackTrace();newReason.cause=reason,reason=newReason}var ret=tryCatch(nodeback).call(promise._boundValue(),reason);ret===errorObj&&async.throwLater(ret.e)}Promise.prototype.asCallback=Promise.prototype.nodeify=function(nodeback,options){if("function"==typeof nodeback){var adapter=successAdapter;void 0!==options&&Object(options).spread&&(adapter=spreadAdapter),this._then(adapter,errorAdapter,void 0,this,nodeback)}return this}}},{"./async.js":2,"./util.js":38}],22:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray){var util=_dereq_("./util.js"),async=_dereq_("./async.js"),tryCatch=util.tryCatch,errorObj=util.errorObj;Promise.prototype.progressed=function(handler){return this._then(void 0,void 0,handler,void 0,void 0)},Promise.prototype._progress=function(progressValue){this._isFollowingOrFulfilledOrRejected()||this._target()._progressUnchecked(progressValue)},Promise.prototype._progressHandlerAt=function(index){return 0===index?this._progressHandler0:this[(index<<2)+index-5+2]},Promise.prototype._doProgressWith=function(progression){var progressValue=progression.value,handler=progression.handler,promise=progression.promise,receiver=progression.receiver,ret=tryCatch(handler).call(receiver,progressValue);if(ret===errorObj){if(null!=ret.e&&"StopProgressPropagation"!==ret.e.name){var trace=util.canAttachTrace(ret.e)?ret.e:new Error(util.toString(ret.e));promise._attachExtraTrace(trace),promise._progress(ret.e)}}else ret instanceof Promise?ret._then(promise._progress,null,null,promise,void 0):promise._progress(ret)},Promise.prototype._progressUnchecked=function(progressValue){for(var len=this._length(),progress=this._progress,i=0;i<len;i++){var handler=this._progressHandlerAt(i),promise=this._promiseAt(i);if(promise instanceof Promise)"function"==typeof handler?async.invoke(this._doProgressWith,this,{handler:handler,promise:promise,receiver:this._receiverAt(i),value:progressValue}):async.invoke(progress,promise,progressValue);else{var receiver=this._receiverAt(i);"function"==typeof handler?handler.call(receiver,progressValue,promise):receiver instanceof PromiseArray&&!receiver._isResolved()&&receiver._promiseProgressed(progressValue,promise)}}}}},{"./async.js":2,"./util.js":38}],23:[function(_dereq_,module,exports){"use strict";module.exports=function(){var getDomain,makeSelfResolutionError=function(){return new TypeError("circular promise resolution chain\n\n    See http://goo.gl/LhFpo0\n")},reflect=function(){return new Promise.PromiseInspection(this._target())},apiRejection=function(msg){return Promise.reject(new TypeError(msg))},util=_dereq_("./util.js");getDomain=util.isNode?function(){var ret=process.domain;return void 0===ret&&(ret=null),ret}:function(){return null},util.notEnumerableProp(Promise,"_getDomain",getDomain);var UNDEFINED_BINDING={},async=_dereq_("./async.js"),errors=_dereq_("./errors.js"),TypeError=Promise.TypeError=errors.TypeError;Promise.RangeError=errors.RangeError,Promise.CancellationError=errors.CancellationError,Promise.TimeoutError=errors.TimeoutError,Promise.OperationalError=errors.OperationalError,Promise.RejectionError=errors.OperationalError,Promise.AggregateError=errors.AggregateError;var INTERNAL=function(){},APPLY={},NEXT_FILTER={e:null},tryConvertToPromise=_dereq_("./thenables.js")(Promise,INTERNAL),PromiseArray=_dereq_("./promise_array.js")(Promise,INTERNAL,tryConvertToPromise,apiRejection),CapturedTrace=_dereq_("./captured_trace.js")(),isDebugging=_dereq_("./debuggability.js")(Promise,CapturedTrace),createContext=_dereq_("./context.js")(Promise,CapturedTrace,isDebugging),CatchFilter=_dereq_("./catch_filter.js")(NEXT_FILTER),PromiseResolver=_dereq_("./promise_resolver.js"),nodebackForPromise=PromiseResolver._nodebackForPromise,errorObj=util.errorObj,tryCatch=util.tryCatch;function Promise(resolver){if("function"!=typeof resolver)throw new TypeError("the promise constructor requires a resolver function\n\n    See http://goo.gl/EC22Yn\n");if(this.constructor!==Promise)throw new TypeError("the promise constructor cannot be invoked directly\n\n    See http://goo.gl/KsIlge\n");this._bitField=0,this._fulfillmentHandler0=void 0,this._rejectionHandler0=void 0,this._progressHandler0=void 0,this._promise0=void 0,this._receiver0=void 0,this._settledValue=void 0,resolver!==INTERNAL&&this._resolveFromResolver(resolver)}function fillTypes(value){var p=new Promise(INTERNAL);p._fulfillmentHandler0=value,p._rejectionHandler0=value,p._progressHandler0=value,p._promise0=value,p._receiver0=value,p._settledValue=value}return Promise.prototype.toString=function(){return"[object Promise]"},Promise.prototype.caught=Promise.prototype.catch=function(fn){var len=arguments.length;if(len>1){var i,catchInstances=new Array(len-1),j=0;for(i=0;i<len-1;++i){var item=arguments[i];if("function"!=typeof item)return Promise.reject(new TypeError("Catch filter must inherit from Error or be a simple predicate function\n\n    See http://goo.gl/o84o68\n"));catchInstances[j++]=item}catchInstances.length=j;var catchFilter=new CatchFilter(catchInstances,fn=arguments[i],this);return this._then(void 0,catchFilter.doFilter,void 0,catchFilter,void 0)}return this._then(void 0,fn,void 0,void 0,void 0)},Promise.prototype.reflect=function(){return this._then(reflect,reflect,void 0,this,void 0)},Promise.prototype.then=function(didFulfill,didReject,didProgress){if(isDebugging()&&arguments.length>0&&"function"!=typeof didFulfill&&"function"!=typeof didReject){var msg=".then() only accepts functions but was passed: "+util.classString(didFulfill);arguments.length>1&&(msg+=", "+util.classString(didReject)),this._warn(msg)}return this._then(didFulfill,didReject,didProgress,void 0,void 0)},Promise.prototype.done=function(didFulfill,didReject,didProgress){this._then(didFulfill,didReject,didProgress,void 0,void 0)._setIsFinal()},Promise.prototype.spread=function(didFulfill,didReject){return this.all()._then(didFulfill,didReject,void 0,APPLY,void 0)},Promise.prototype.isCancellable=function(){return!this.isResolved()&&this._cancellable()},Promise.prototype.toJSON=function(){var ret={isFulfilled:!1,isRejected:!1,fulfillmentValue:void 0,rejectionReason:void 0};return this.isFulfilled()?(ret.fulfillmentValue=this.value(),ret.isFulfilled=!0):this.isRejected()&&(ret.rejectionReason=this.reason(),ret.isRejected=!0),ret},Promise.prototype.all=function(){return new PromiseArray(this).promise()},Promise.prototype.error=function(fn){return this.caught(util.originatesFromRejection,fn)},Promise.getNewLibraryCopy=module.exports,Promise.is=function(val){return val instanceof Promise},Promise.fromNode=function(fn){var ret=new Promise(INTERNAL),result=tryCatch(fn)(nodebackForPromise(ret));return result===errorObj&&ret._rejectCallback(result.e,!0,!0),ret},Promise.all=function(promises){return new PromiseArray(promises).promise()},Promise.defer=Promise.pending=function(){var promise=new Promise(INTERNAL);return new PromiseResolver(promise)},Promise.cast=function(obj){var ret=tryConvertToPromise(obj);if(!(ret instanceof Promise)){var val=ret;(ret=new Promise(INTERNAL))._fulfillUnchecked(val)}return ret},Promise.resolve=Promise.fulfilled=Promise.cast,Promise.reject=Promise.rejected=function(reason){var ret=new Promise(INTERNAL);return ret._captureStackTrace(),ret._rejectCallback(reason,!0),ret},Promise.setScheduler=function(fn){if("function"!=typeof fn)throw new TypeError("fn must be a function\n\n    See http://goo.gl/916lJJ\n");var prev=async._schedule;return async._schedule=fn,prev},Promise.prototype._then=function(didFulfill,didReject,didProgress,receiver,internalData){var haveInternalData=void 0!==internalData,ret=haveInternalData?internalData:new Promise(INTERNAL);haveInternalData||(ret._propagateFrom(this,5),ret._captureStackTrace());var target=this._target();target!==this&&(void 0===receiver&&(receiver=this._boundTo),haveInternalData||ret._setIsMigrated());var callbackIndex=target._addCallbacks(didFulfill,didReject,didProgress,ret,receiver,getDomain());return target._isResolved()&&!target._isSettlePromisesQueued()&&async.invoke(target._settlePromiseAtPostResolution,target,callbackIndex),ret},Promise.prototype._settlePromiseAtPostResolution=function(index){this._isRejectionUnhandled()&&this._unsetRejectionIsUnhandled(),this._settlePromiseAt(index)},Promise.prototype._length=function(){return 131071&this._bitField},Promise.prototype._isFollowingOrFulfilledOrRejected=function(){return(939524096&this._bitField)>0},Promise.prototype._isFollowing=function(){return 536870912==(536870912&this._bitField)},Promise.prototype._setLength=function(len){this._bitField=-131072&this._bitField|131071&len},Promise.prototype._setFulfilled=function(){this._bitField=268435456|this._bitField},Promise.prototype._setRejected=function(){this._bitField=134217728|this._bitField},Promise.prototype._setFollowing=function(){this._bitField=536870912|this._bitField},Promise.prototype._setIsFinal=function(){this._bitField=33554432|this._bitField},Promise.prototype._isFinal=function(){return(33554432&this._bitField)>0},Promise.prototype._cancellable=function(){return(67108864&this._bitField)>0},Promise.prototype._setCancellable=function(){this._bitField=67108864|this._bitField},Promise.prototype._unsetCancellable=function(){this._bitField=-67108865&this._bitField},Promise.prototype._setIsMigrated=function(){this._bitField=4194304|this._bitField},Promise.prototype._unsetIsMigrated=function(){this._bitField=-4194305&this._bitField},Promise.prototype._isMigrated=function(){return(4194304&this._bitField)>0},Promise.prototype._receiverAt=function(index){var ret=0===index?this._receiver0:this[5*index-5+4];if(ret!==UNDEFINED_BINDING)return void 0===ret&&this._isBound()?this._boundValue():ret},Promise.prototype._promiseAt=function(index){return 0===index?this._promise0:this[5*index-5+3]},Promise.prototype._fulfillmentHandlerAt=function(index){return 0===index?this._fulfillmentHandler0:this[5*index-5+0]},Promise.prototype._rejectionHandlerAt=function(index){return 0===index?this._rejectionHandler0:this[5*index-5+1]},Promise.prototype._boundValue=function(){var ret=this._boundTo;return void 0!==ret&&ret instanceof Promise?ret.isFulfilled()?ret.value():void 0:ret},Promise.prototype._migrateCallbacks=function(follower,index){var fulfill=follower._fulfillmentHandlerAt(index),reject=follower._rejectionHandlerAt(index),progress=follower._progressHandlerAt(index),promise=follower._promiseAt(index),receiver=follower._receiverAt(index);promise instanceof Promise&&promise._setIsMigrated(),void 0===receiver&&(receiver=UNDEFINED_BINDING),this._addCallbacks(fulfill,reject,progress,promise,receiver,null)},Promise.prototype._addCallbacks=function(fulfill,reject,progress,promise,receiver,domain){var index=this._length();if(index>=131066&&(index=0,this._setLength(0)),0===index)this._promise0=promise,void 0!==receiver&&(this._receiver0=receiver),"function"!=typeof fulfill||this._isCarryingStackTrace()||(this._fulfillmentHandler0=null===domain?fulfill:domain.bind(fulfill)),"function"==typeof reject&&(this._rejectionHandler0=null===domain?reject:domain.bind(reject)),"function"==typeof progress&&(this._progressHandler0=null===domain?progress:domain.bind(progress));else{var base=5*index-5;this[base+3]=promise,this[base+4]=receiver,"function"==typeof fulfill&&(this[base+0]=null===domain?fulfill:domain.bind(fulfill)),"function"==typeof reject&&(this[base+1]=null===domain?reject:domain.bind(reject)),"function"==typeof progress&&(this[base+2]=null===domain?progress:domain.bind(progress))}return this._setLength(index+1),index},Promise.prototype._setProxyHandlers=function(receiver,promiseSlotValue){var index=this._length();if(index>=131066&&(index=0,this._setLength(0)),0===index)this._promise0=promiseSlotValue,this._receiver0=receiver;else{var base=5*index-5;this[base+3]=promiseSlotValue,this[base+4]=receiver}this._setLength(index+1)},Promise.prototype._proxyPromiseArray=function(promiseArray,index){this._setProxyHandlers(promiseArray,index)},Promise.prototype._resolveCallback=function(value,shouldBind){if(!this._isFollowingOrFulfilledOrRejected()){if(value===this)return this._rejectCallback(makeSelfResolutionError(),!1,!0);var maybePromise=tryConvertToPromise(value,this);if(!(maybePromise instanceof Promise))return this._fulfill(value);var propagationFlags=1|(shouldBind?4:0);this._propagateFrom(maybePromise,propagationFlags);var promise=maybePromise._target();if(promise._isPending()){for(var len=this._length(),i=0;i<len;++i)promise._migrateCallbacks(this,i);this._setFollowing(),this._setLength(0),this._setFollowee(promise)}else promise._isFulfilled()?this._fulfillUnchecked(promise._value()):this._rejectUnchecked(promise._reason(),promise._getCarriedStackTrace())}},Promise.prototype._rejectCallback=function(reason,synchronous,shouldNotMarkOriginatingFromRejection){shouldNotMarkOriginatingFromRejection||util.markAsOriginatingFromRejection(reason);var trace=util.ensureErrorObject(reason),hasStack=trace===reason;this._attachExtraTrace(trace,!!synchronous&&hasStack),this._reject(reason,hasStack?void 0:trace)},Promise.prototype._resolveFromResolver=function(resolver){var promise=this;this._captureStackTrace(),this._pushContext();var synchronous=!0,r=tryCatch(resolver)((function(value){null!==promise&&(promise._resolveCallback(value),promise=null)}),(function(reason){null!==promise&&(promise._rejectCallback(reason,synchronous),promise=null)}));synchronous=!1,this._popContext(),void 0!==r&&r===errorObj&&null!==promise&&(promise._rejectCallback(r.e,!0,!0),promise=null)},Promise.prototype._settlePromiseFromHandler=function(handler,receiver,value,promise){var x;if(!promise._isRejected())if(promise._pushContext(),x=receiver!==APPLY||this._isRejected()?tryCatch(handler).call(receiver,value):tryCatch(handler).apply(this._boundValue(),value),promise._popContext(),x===errorObj||x===promise||x===NEXT_FILTER){var err=x===promise?makeSelfResolutionError():x.e;promise._rejectCallback(err,!1,!0)}else promise._resolveCallback(x)},Promise.prototype._target=function(){for(var ret=this;ret._isFollowing();)ret=ret._followee();return ret},Promise.prototype._followee=function(){return this._rejectionHandler0},Promise.prototype._setFollowee=function(promise){this._rejectionHandler0=promise},Promise.prototype._cleanValues=function(){this._cancellable()&&(this._cancellationParent=void 0)},Promise.prototype._propagateFrom=function(parent,flags){(1&flags)>0&&parent._cancellable()&&(this._setCancellable(),this._cancellationParent=parent),(4&flags)>0&&parent._isBound()&&this._setBoundTo(parent._boundTo)},Promise.prototype._fulfill=function(value){this._isFollowingOrFulfilledOrRejected()||this._fulfillUnchecked(value)},Promise.prototype._reject=function(reason,carriedStackTrace){this._isFollowingOrFulfilledOrRejected()||this._rejectUnchecked(reason,carriedStackTrace)},Promise.prototype._settlePromiseAt=function(index){var promise=this._promiseAt(index),isPromise=promise instanceof Promise;if(isPromise&&promise._isMigrated())return promise._unsetIsMigrated(),async.invoke(this._settlePromiseAt,this,index);var handler=this._isFulfilled()?this._fulfillmentHandlerAt(index):this._rejectionHandlerAt(index),carriedStackTrace=this._isCarryingStackTrace()?this._getCarriedStackTrace():void 0,value=this._settledValue,receiver=this._receiverAt(index);this._clearCallbackDataAtIndex(index),"function"==typeof handler?isPromise?this._settlePromiseFromHandler(handler,receiver,value,promise):handler.call(receiver,value,promise):receiver instanceof PromiseArray?receiver._isResolved()||(this._isFulfilled()?receiver._promiseFulfilled(value,promise):receiver._promiseRejected(value,promise)):isPromise&&(this._isFulfilled()?promise._fulfill(value):promise._reject(value,carriedStackTrace)),index>=4&&4==(31&index)&&async.invokeLater(this._setLength,this,0)},Promise.prototype._clearCallbackDataAtIndex=function(index){if(0===index)this._isCarryingStackTrace()||(this._fulfillmentHandler0=void 0),this._rejectionHandler0=this._progressHandler0=this._receiver0=this._promise0=void 0;else{var base=5*index-5;this[base+3]=this[base+4]=this[base+0]=this[base+1]=this[base+2]=void 0}},Promise.prototype._isSettlePromisesQueued=function(){return-1073741824==(-1073741824&this._bitField)},Promise.prototype._setSettlePromisesQueued=function(){this._bitField=-1073741824|this._bitField},Promise.prototype._unsetSettlePromisesQueued=function(){this._bitField=1073741823&this._bitField},Promise.prototype._queueSettlePromises=function(){async.settlePromises(this),this._setSettlePromisesQueued()},Promise.prototype._fulfillUnchecked=function(value){if(value===this){var err=makeSelfResolutionError();return this._attachExtraTrace(err),this._rejectUnchecked(err,void 0)}this._setFulfilled(),this._settledValue=value,this._cleanValues(),this._length()>0&&this._queueSettlePromises()},Promise.prototype._rejectUncheckedCheckError=function(reason){var trace=util.ensureErrorObject(reason);this._rejectUnchecked(reason,trace===reason?void 0:trace)},Promise.prototype._rejectUnchecked=function(reason,trace){if(reason===this){var err=makeSelfResolutionError();return this._attachExtraTrace(err),this._rejectUnchecked(err)}this._setRejected(),this._settledValue=reason,this._cleanValues(),this._isFinal()?async.throwLater((function(e){throw"stack"in e&&async.invokeFirst(CapturedTrace.unhandledRejection,void 0,e),e}),void 0===trace?reason:trace):(void 0!==trace&&trace!==reason&&this._setCarriedStackTrace(trace),this._length()>0?this._queueSettlePromises():this._ensurePossibleRejectionHandled())},Promise.prototype._settlePromises=function(){this._unsetSettlePromisesQueued();for(var len=this._length(),i=0;i<len;i++)this._settlePromiseAt(i)},util.notEnumerableProp(Promise,"_makeSelfResolutionError",makeSelfResolutionError),_dereq_("./progress.js")(Promise,PromiseArray),_dereq_("./method.js")(Promise,INTERNAL,tryConvertToPromise,apiRejection),_dereq_("./bind.js")(Promise,INTERNAL,tryConvertToPromise),_dereq_("./finally.js")(Promise,NEXT_FILTER,tryConvertToPromise),_dereq_("./direct_resolve.js")(Promise),_dereq_("./synchronous_inspection.js")(Promise),_dereq_("./join.js")(Promise,PromiseArray,tryConvertToPromise,INTERNAL),Promise.version="2.11.0",Promise.Promise=Promise,_dereq_("./map.js")(Promise,PromiseArray,apiRejection,tryConvertToPromise,INTERNAL),_dereq_("./cancel.js")(Promise),_dereq_("./using.js")(Promise,apiRejection,tryConvertToPromise,createContext),_dereq_("./generators.js")(Promise,apiRejection,INTERNAL,tryConvertToPromise),_dereq_("./nodeify.js")(Promise),_dereq_("./call_get.js")(Promise),_dereq_("./props.js")(Promise,PromiseArray,tryConvertToPromise,apiRejection),_dereq_("./race.js")(Promise,INTERNAL,tryConvertToPromise,apiRejection),_dereq_("./reduce.js")(Promise,PromiseArray,apiRejection,tryConvertToPromise,INTERNAL),_dereq_("./settle.js")(Promise,PromiseArray),_dereq_("./some.js")(Promise,PromiseArray,apiRejection),_dereq_("./promisify.js")(Promise,INTERNAL),_dereq_("./any.js")(Promise),_dereq_("./each.js")(Promise,INTERNAL),_dereq_("./timers.js")(Promise,INTERNAL),_dereq_("./filter.js")(Promise,INTERNAL),util.toFastProperties(Promise),util.toFastProperties(Promise.prototype),fillTypes({a:1}),fillTypes({b:2}),fillTypes({c:3}),fillTypes(1),fillTypes((function(){})),fillTypes(void 0),fillTypes(!1),fillTypes(new Promise(INTERNAL)),CapturedTrace.setBounds(async.firstLineError,util.lastLineError),Promise}},{"./any.js":1,"./async.js":2,"./bind.js":3,"./call_get.js":5,"./cancel.js":6,"./captured_trace.js":7,"./catch_filter.js":8,"./context.js":9,"./debuggability.js":10,"./direct_resolve.js":11,"./each.js":12,"./errors.js":13,"./filter.js":15,"./finally.js":16,"./generators.js":17,"./join.js":18,"./map.js":19,"./method.js":20,"./nodeify.js":21,"./progress.js":22,"./promise_array.js":24,"./promise_resolver.js":25,"./promisify.js":26,"./props.js":27,"./race.js":29,"./reduce.js":30,"./settle.js":32,"./some.js":33,"./synchronous_inspection.js":34,"./thenables.js":35,"./timers.js":36,"./using.js":37,"./util.js":38}],24:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL,tryConvertToPromise,apiRejection){var isArray=_dereq_("./util.js").isArray;function toResolutionValue(val){switch(val){case-2:return[];case-3:return{}}}function PromiseArray(values){var parent,promise=this._promise=new Promise(INTERNAL);values instanceof Promise&&(parent=values,promise._propagateFrom(parent,5)),this._values=values,this._length=0,this._totalResolved=0,this._init(void 0,-2)}return PromiseArray.prototype.length=function(){return this._length},PromiseArray.prototype.promise=function(){return this._promise},PromiseArray.prototype._init=function init(_,resolveValueIfEmpty){var values=tryConvertToPromise(this._values,this._promise);if(values instanceof Promise){if(values=values._target(),this._values=values,!values._isFulfilled())return values._isPending()?void values._then(init,this._reject,void 0,this,resolveValueIfEmpty):void this._reject(values._reason());if(values=values._value(),!isArray(values)){var err=new Promise.TypeError("expecting an array, a promise or a thenable\n\n    See http://goo.gl/s8MMhc\n");return void this.__hardReject__(err)}}else if(!isArray(values))return void this._promise._reject(apiRejection("expecting an array, a promise or a thenable\n\n    See http://goo.gl/s8MMhc\n")._reason());if(0!==values.length){var len=this.getActualLength(values.length);this._length=len,this._values=this.shouldCopyValues()?new Array(len):this._values;for(var promise=this._promise,i=0;i<len;++i){var isResolved=this._isResolved(),maybePromise=tryConvertToPromise(values[i],promise);maybePromise instanceof Promise?(maybePromise=maybePromise._target(),isResolved?maybePromise._ignoreRejections():maybePromise._isPending()?maybePromise._proxyPromiseArray(this,i):maybePromise._isFulfilled()?this._promiseFulfilled(maybePromise._value(),i):this._promiseRejected(maybePromise._reason(),i)):isResolved||this._promiseFulfilled(maybePromise,i)}}else-5===resolveValueIfEmpty?this._resolveEmptyArray():this._resolve(toResolutionValue(resolveValueIfEmpty))},PromiseArray.prototype._isResolved=function(){return null===this._values},PromiseArray.prototype._resolve=function(value){this._values=null,this._promise._fulfill(value)},PromiseArray.prototype.__hardReject__=PromiseArray.prototype._reject=function(reason){this._values=null,this._promise._rejectCallback(reason,!1,!0)},PromiseArray.prototype._promiseProgressed=function(progressValue,index){this._promise._progress({index:index,value:progressValue})},PromiseArray.prototype._promiseFulfilled=function(value,index){this._values[index]=value,++this._totalResolved>=this._length&&this._resolve(this._values)},PromiseArray.prototype._promiseRejected=function(reason,index){this._totalResolved++,this._reject(reason)},PromiseArray.prototype.shouldCopyValues=function(){return!0},PromiseArray.prototype.getActualLength=function(len){return len},PromiseArray}},{"./util.js":38}],25:[function(_dereq_,module,exports){"use strict";var util=_dereq_("./util.js"),maybeWrapAsError=util.maybeWrapAsError,errors=_dereq_("./errors.js"),TimeoutError=errors.TimeoutError,OperationalError=errors.OperationalError,haveGetters=util.haveGetters,es5=_dereq_("./es5.js");function isUntypedError(obj){return obj instanceof Error&&es5.getPrototypeOf(obj)===Error.prototype}var PromiseResolver,rErrorKey=/^(?:name|message|stack|cause)$/;function wrapAsOperationalError(obj){var ret;if(isUntypedError(obj)){(ret=new OperationalError(obj)).name=obj.name,ret.message=obj.message,ret.stack=obj.stack;for(var keys=es5.keys(obj),i=0;i<keys.length;++i){var key=keys[i];rErrorKey.test(key)||(ret[key]=obj[key])}return ret}return util.markAsOriginatingFromRejection(obj),obj}function nodebackForPromise(promise){return function(err,value){if(null!==promise){if(err){var wrapped=wrapAsOperationalError(maybeWrapAsError(err));promise._attachExtraTrace(wrapped),promise._reject(wrapped)}else if(arguments.length>2){for(var $_len=arguments.length,args=new Array($_len-1),$_i=1;$_i<$_len;++$_i)args[$_i-1]=arguments[$_i];promise._fulfill(args)}else promise._fulfill(value);promise=null}}}if(PromiseResolver=haveGetters?function(promise){this.promise=promise}:function(promise){this.promise=promise,this.asCallback=nodebackForPromise(promise),this.callback=this.asCallback},haveGetters){var prop={get:function(){return nodebackForPromise(this.promise)}};es5.defineProperty(PromiseResolver.prototype,"asCallback",prop),es5.defineProperty(PromiseResolver.prototype,"callback",prop)}PromiseResolver._nodebackForPromise=nodebackForPromise,PromiseResolver.prototype.toString=function(){return"[object PromiseResolver]"},PromiseResolver.prototype.resolve=PromiseResolver.prototype.fulfill=function(value){if(!(this instanceof PromiseResolver))throw new TypeError("Illegal invocation, resolver resolve/reject must be called within a resolver context. Consider using the promise constructor instead.\n\n    See http://goo.gl/sdkXL9\n");this.promise._resolveCallback(value)},PromiseResolver.prototype.reject=function(reason){if(!(this instanceof PromiseResolver))throw new TypeError("Illegal invocation, resolver resolve/reject must be called within a resolver context. Consider using the promise constructor instead.\n\n    See http://goo.gl/sdkXL9\n");this.promise._rejectCallback(reason)},PromiseResolver.prototype.progress=function(value){if(!(this instanceof PromiseResolver))throw new TypeError("Illegal invocation, resolver resolve/reject must be called within a resolver context. Consider using the promise constructor instead.\n\n    See http://goo.gl/sdkXL9\n");this.promise._progress(value)},PromiseResolver.prototype.cancel=function(err){this.promise.cancel(err)},PromiseResolver.prototype.timeout=function(){this.reject(new TimeoutError("timeout"))},PromiseResolver.prototype.isResolved=function(){return this.promise.isResolved()},PromiseResolver.prototype.toJSON=function(){return this.promise.toJSON()},module.exports=PromiseResolver},{"./errors.js":13,"./es5.js":14,"./util.js":38}],26:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL){var THIS={},util=_dereq_("./util.js"),nodebackForPromise=_dereq_("./promise_resolver.js")._nodebackForPromise,withAppended=util.withAppended,maybeWrapAsError=util.maybeWrapAsError,canEvaluate=util.canEvaluate,TypeError=_dereq_("./errors").TypeError,defaultSuffix="Async",defaultPromisified={__isPromisified__:!0},noCopyPropsPattern=new RegExp("^(?:"+["arity","length","name","arguments","caller","callee","prototype","__isPromisified__"].join("|")+")$"),defaultFilter=function(name){return util.isIdentifier(name)&&"_"!==name.charAt(0)&&"constructor"!==name};function propsFilter(key){return!noCopyPropsPattern.test(key)}function isPromisified(fn){try{return!0===fn.__isPromisified__}catch(e){return!1}}function hasPromisified(obj,key,suffix){var val=util.getDataPropertyOrDefault(obj,key+suffix,defaultPromisified);return!!val&&isPromisified(val)}function checkValid(ret,suffix,suffixRegexp){for(var i=0;i<ret.length;i+=2){var key=ret[i];if(suffixRegexp.test(key))for(var keyWithoutAsyncSuffix=key.replace(suffixRegexp,""),j=0;j<ret.length;j+=2)if(ret[j]===keyWithoutAsyncSuffix)throw new TypeError("Cannot promisify an API that has normal methods with '%s'-suffix\n\n    See http://goo.gl/iWrZbw\n".replace("%s",suffix))}}function promisifiableMethods(obj,suffix,suffixRegexp,filter){for(var keys=util.inheritedDataKeys(obj),ret=[],i=0;i<keys.length;++i){var key=keys[i],value=obj[key],passesDefaultFilter=filter===defaultFilter||defaultFilter(key,value,obj);"function"!=typeof value||isPromisified(value)||hasPromisified(obj,key,suffix)||!filter(key,value,obj,passesDefaultFilter)||ret.push(key,value)}return checkValid(ret,suffix,suffixRegexp),ret}var makeNodePromisifiedEval,escapeIdentRegex=function(str){return str.replace(/([$])/,"\\$")};function makeNodePromisifiedClosure(callback,receiver,_,fn){var defaultThis=function(){return this}(),method=callback;function promisified(){var _receiver=receiver;receiver===THIS&&(_receiver=this);var promise=new Promise(INTERNAL);promise._captureStackTrace();var cb="string"==typeof method&&this!==defaultThis?this[method]:callback,fn=nodebackForPromise(promise);try{cb.apply(_receiver,withAppended(arguments,fn))}catch(e){promise._rejectCallback(maybeWrapAsError(e),!0,!0)}return promise}return"string"==typeof method&&(callback=fn),util.notEnumerableProp(promisified,"__isPromisified__",!0),promisified}var makeNodePromisified=canEvaluate?makeNodePromisifiedEval:makeNodePromisifiedClosure;function promisifyAll(obj,suffix,filter,promisifier){for(var suffixRegexp=new RegExp(escapeIdentRegex(suffix)+"$"),methods=promisifiableMethods(obj,suffix,suffixRegexp,filter),i=0,len=methods.length;i<len;i+=2){var key=methods[i],fn=methods[i+1],promisifiedKey=key+suffix;if(promisifier===makeNodePromisified)obj[promisifiedKey]=makeNodePromisified(key,THIS,key,fn,suffix);else{var promisified=promisifier(fn,(function(){return makeNodePromisified(key,THIS,key,fn,suffix)}));util.notEnumerableProp(promisified,"__isPromisified__",!0),obj[promisifiedKey]=promisified}}return util.toFastProperties(obj),obj}function promisify(callback,receiver){return makeNodePromisified(callback,receiver,void 0,callback)}Promise.promisify=function(fn,receiver){if("function"!=typeof fn)throw new TypeError("fn must be a function\n\n    See http://goo.gl/916lJJ\n");if(isPromisified(fn))return fn;var ret=promisify(fn,arguments.length<2?THIS:receiver);return util.copyDescriptors(fn,ret,propsFilter),ret},Promise.promisifyAll=function(target,options){if("function"!=typeof target&&"object"!=typeof target)throw new TypeError("the target of promisifyAll must be an object or a function\n\n    See http://goo.gl/9ITlV0\n");var suffix=(options=Object(options)).suffix;"string"!=typeof suffix&&(suffix=defaultSuffix);var filter=options.filter;"function"!=typeof filter&&(filter=defaultFilter);var promisifier=options.promisifier;if("function"!=typeof promisifier&&(promisifier=makeNodePromisified),!util.isIdentifier(suffix))throw new RangeError("suffix must be a valid identifier\n\n    See http://goo.gl/8FZo5V\n");for(var keys=util.inheritedDataKeys(target),i=0;i<keys.length;++i){var value=target[keys[i]];"constructor"!==keys[i]&&util.isClass(value)&&(promisifyAll(value.prototype,suffix,filter,promisifier),promisifyAll(value,suffix,filter,promisifier))}return promisifyAll(target,suffix,filter,promisifier)}}},{"./errors":13,"./promise_resolver.js":25,"./util.js":38}],27:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,tryConvertToPromise,apiRejection){var util=_dereq_("./util.js"),isObject=util.isObject,es5=_dereq_("./es5.js");function PropertiesPromiseArray(obj){for(var keys=es5.keys(obj),len=keys.length,values=new Array(2*len),i=0;i<len;++i){var key=keys[i];values[i]=obj[key],values[i+len]=key}this.constructor$(values)}function props(promises){var ret,castValue=tryConvertToPromise(promises);return isObject(castValue)?(ret=castValue instanceof Promise?castValue._then(Promise.props,void 0,void 0,void 0,void 0):new PropertiesPromiseArray(castValue).promise(),castValue instanceof Promise&&ret._propagateFrom(castValue,4),ret):apiRejection("cannot await properties of a non-object\n\n    See http://goo.gl/OsFKC8\n")}util.inherits(PropertiesPromiseArray,PromiseArray),PropertiesPromiseArray.prototype._init=function(){this._init$(void 0,-3)},PropertiesPromiseArray.prototype._promiseFulfilled=function(value,index){if(this._values[index]=value,++this._totalResolved>=this._length){for(var val={},keyOffset=this.length(),i=0,len=this.length();i<len;++i)val[this._values[i+keyOffset]]=this._values[i];this._resolve(val)}},PropertiesPromiseArray.prototype._promiseProgressed=function(value,index){this._promise._progress({key:this._values[index+this.length()],value:value})},PropertiesPromiseArray.prototype.shouldCopyValues=function(){return!1},PropertiesPromiseArray.prototype.getActualLength=function(len){return len>>1},Promise.prototype.props=function(){return props(this)},Promise.props=function(promises){return props(promises)}}},{"./es5.js":14,"./util.js":38}],28:[function(_dereq_,module,exports){"use strict";function arrayMove(src,srcIndex,dst,dstIndex,len){for(var j=0;j<len;++j)dst[j+dstIndex]=src[j+srcIndex],src[j+srcIndex]=void 0}function Queue(capacity){this._capacity=capacity,this._length=0,this._front=0}Queue.prototype._willBeOverCapacity=function(size){return this._capacity<size},Queue.prototype._pushOne=function(arg){var length=this.length();this._checkCapacity(length+1),this[this._front+length&this._capacity-1]=arg,this._length=length+1},Queue.prototype._unshiftOne=function(value){var capacity=this._capacity;this._checkCapacity(this.length()+1);var i=(this._front-1&capacity-1^capacity)-capacity;this[i]=value,this._front=i,this._length=this.length()+1},Queue.prototype.unshift=function(fn,receiver,arg){this._unshiftOne(arg),this._unshiftOne(receiver),this._unshiftOne(fn)},Queue.prototype.push=function(fn,receiver,arg){var length=this.length()+3;if(this._willBeOverCapacity(length))return this._pushOne(fn),this._pushOne(receiver),void this._pushOne(arg);var j=this._front+length-3;this._checkCapacity(length);var wrapMask=this._capacity-1;this[j+0&wrapMask]=fn,this[j+1&wrapMask]=receiver,this[j+2&wrapMask]=arg,this._length=length},Queue.prototype.shift=function(){var front=this._front,ret=this[front];return this[front]=void 0,this._front=front+1&this._capacity-1,this._length--,ret},Queue.prototype.length=function(){return this._length},Queue.prototype._checkCapacity=function(size){this._capacity<size&&this._resizeTo(this._capacity<<1)},Queue.prototype._resizeTo=function(capacity){var oldCapacity=this._capacity;this._capacity=capacity,arrayMove(this,0,this,oldCapacity,this._front+this._length&oldCapacity-1)},module.exports=Queue},{}],29:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL,tryConvertToPromise,apiRejection){var isArray=_dereq_("./util.js").isArray,raceLater=function(promise){return promise.then((function(array){return race(array,promise)}))};function race(promises,parent){var maybePromise=tryConvertToPromise(promises);if(maybePromise instanceof Promise)return raceLater(maybePromise);if(!isArray(promises))return apiRejection("expecting an array, a promise or a thenable\n\n    See http://goo.gl/s8MMhc\n");var ret=new Promise(INTERNAL);void 0!==parent&&ret._propagateFrom(parent,5);for(var fulfill=ret._fulfill,reject=ret._reject,i=0,len=promises.length;i<len;++i){var val=promises[i];(void 0!==val||i in promises)&&Promise.cast(val)._then(fulfill,reject,void 0,ret,null)}return ret}Promise.race=function(promises){return race(promises,void 0)},Promise.prototype.race=function(){return race(this,void 0)}}},{"./util.js":38}],30:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,apiRejection,tryConvertToPromise,INTERNAL){var getDomain=Promise._getDomain,async=_dereq_("./async.js"),util=_dereq_("./util.js"),tryCatch=util.tryCatch,errorObj=util.errorObj;function ReductionPromiseArray(promises,fn,accum,_each){this.constructor$(promises),this._promise._captureStackTrace(),this._preservedValues=_each===INTERNAL?[]:null,this._zerothIsAccum=void 0===accum,this._gotAccum=!1,this._reducingIndex=this._zerothIsAccum?1:0,this._valuesPhase=void 0;var maybePromise=tryConvertToPromise(accum,this._promise),rejected=!1,isPromise=maybePromise instanceof Promise;isPromise&&((maybePromise=maybePromise._target())._isPending()?maybePromise._proxyPromiseArray(this,-1):maybePromise._isFulfilled()?(accum=maybePromise._value(),this._gotAccum=!0):(this._reject(maybePromise._reason()),rejected=!0)),isPromise||this._zerothIsAccum||(this._gotAccum=!0);var domain=getDomain();this._callback=null===domain?fn:domain.bind(fn),this._accum=accum,rejected||async.invoke(init,this,void 0)}function init(){this._init$(void 0,-5)}function reduce(promises,fn,initialValue,_each){return"function"!=typeof fn?apiRejection("fn must be a function\n\n    See http://goo.gl/916lJJ\n"):new ReductionPromiseArray(promises,fn,initialValue,_each).promise()}util.inherits(ReductionPromiseArray,PromiseArray),ReductionPromiseArray.prototype._init=function(){},ReductionPromiseArray.prototype._resolveEmptyArray=function(){(this._gotAccum||this._zerothIsAccum)&&this._resolve(null!==this._preservedValues?[]:this._accum)},ReductionPromiseArray.prototype._promiseFulfilled=function(value,index){var values=this._values;values[index]=value;var valuesPhaseIndex,length=this.length(),preservedValues=this._preservedValues,isEach=null!==preservedValues,gotAccum=this._gotAccum,valuesPhase=this._valuesPhase;if(!valuesPhase)for(valuesPhase=this._valuesPhase=new Array(length),valuesPhaseIndex=0;valuesPhaseIndex<length;++valuesPhaseIndex)valuesPhase[valuesPhaseIndex]=0;if(valuesPhaseIndex=valuesPhase[index],0===index&&this._zerothIsAccum?(this._accum=value,this._gotAccum=gotAccum=!0,valuesPhase[index]=0===valuesPhaseIndex?1:2):-1===index?(this._accum=value,this._gotAccum=gotAccum=!0):0===valuesPhaseIndex?valuesPhase[index]=1:(valuesPhase[index]=2,this._accum=value),gotAccum){for(var ret,callback=this._callback,receiver=this._promise._boundValue(),i=this._reducingIndex;i<length;++i)if(2!==(valuesPhaseIndex=valuesPhase[i])){if(1!==valuesPhaseIndex)return;if(value=values[i],this._promise._pushContext(),isEach?(preservedValues.push(value),ret=tryCatch(callback).call(receiver,value,i,length)):ret=tryCatch(callback).call(receiver,this._accum,value,i,length),this._promise._popContext(),ret===errorObj)return this._reject(ret.e);var maybePromise=tryConvertToPromise(ret,this._promise);if(maybePromise instanceof Promise){if((maybePromise=maybePromise._target())._isPending())return valuesPhase[i]=4,maybePromise._proxyPromiseArray(this,i);if(!maybePromise._isFulfilled())return this._reject(maybePromise._reason());ret=maybePromise._value()}this._reducingIndex=i+1,this._accum=ret}else this._reducingIndex=i+1;this._resolve(isEach?preservedValues:this._accum)}},Promise.prototype.reduce=function(fn,initialValue){return reduce(this,fn,initialValue,null)},Promise.reduce=function(promises,fn,initialValue,_each){return reduce(promises,fn,initialValue,_each)}}},{"./async.js":2,"./util.js":38}],31:[function(_dereq_,module,exports){"use strict";var schedule,util=_dereq_("./util"),noAsyncScheduler=function(){throw new Error("No async scheduler available\n\n    See http://goo.gl/m3OTXk\n")};if(util.isNode&&"undefined"==typeof MutationObserver){var GlobalSetImmediate=global.setImmediate,ProcessNextTick=process.nextTick;schedule=util.isRecentNode?function(fn){GlobalSetImmediate.call(global,fn)}:function(fn){ProcessNextTick.call(process,fn)}}else"undefined"==typeof MutationObserver||"undefined"!=typeof window&&window.navigator&&window.navigator.standalone?schedule="undefined"!=typeof setImmediate?function(fn){setImmediate(fn)}:"undefined"!=typeof setTimeout?function(fn){setTimeout(fn,0)}:noAsyncScheduler:(schedule=function(fn){var div=document.createElement("div");return new MutationObserver(fn).observe(div,{attributes:!0}),function(){div.classList.toggle("foo")}}).isStatic=!0;module.exports=schedule},{"./util":38}],32:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray){var PromiseInspection=Promise.PromiseInspection;function SettledPromiseArray(values){this.constructor$(values)}_dereq_("./util.js").inherits(SettledPromiseArray,PromiseArray),SettledPromiseArray.prototype._promiseResolved=function(index,inspection){this._values[index]=inspection,++this._totalResolved>=this._length&&this._resolve(this._values)},SettledPromiseArray.prototype._promiseFulfilled=function(value,index){var ret=new PromiseInspection;ret._bitField=268435456,ret._settledValue=value,this._promiseResolved(index,ret)},SettledPromiseArray.prototype._promiseRejected=function(reason,index){var ret=new PromiseInspection;ret._bitField=134217728,ret._settledValue=reason,this._promiseResolved(index,ret)},Promise.settle=function(promises){return new SettledPromiseArray(promises).promise()},Promise.prototype.settle=function(){return new SettledPromiseArray(this).promise()}}},{"./util.js":38}],33:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,PromiseArray,apiRejection){var util=_dereq_("./util.js"),RangeError=_dereq_("./errors.js").RangeError,AggregateError=_dereq_("./errors.js").AggregateError,isArray=util.isArray;function SomePromiseArray(values){this.constructor$(values),this._howMany=0,this._unwrap=!1,this._initialized=!1}function some(promises,howMany){if((0|howMany)!==howMany||howMany<0)return apiRejection("expecting a positive integer\n\n    See http://goo.gl/1wAmHx\n");var ret=new SomePromiseArray(promises),promise=ret.promise();return ret.setHowMany(howMany),ret.init(),promise}util.inherits(SomePromiseArray,PromiseArray),SomePromiseArray.prototype._init=function(){if(this._initialized)if(0!==this._howMany){this._init$(void 0,-5);var isArrayResolved=isArray(this._values);!this._isResolved()&&isArrayResolved&&this._howMany>this._canPossiblyFulfill()&&this._reject(this._getRangeError(this.length()))}else this._resolve([])},SomePromiseArray.prototype.init=function(){this._initialized=!0,this._init()},SomePromiseArray.prototype.setUnwrap=function(){this._unwrap=!0},SomePromiseArray.prototype.howMany=function(){return this._howMany},SomePromiseArray.prototype.setHowMany=function(count){this._howMany=count},SomePromiseArray.prototype._promiseFulfilled=function(value){this._addFulfilled(value),this._fulfilled()===this.howMany()&&(this._values.length=this.howMany(),1===this.howMany()&&this._unwrap?this._resolve(this._values[0]):this._resolve(this._values))},SomePromiseArray.prototype._promiseRejected=function(reason){if(this._addRejected(reason),this.howMany()>this._canPossiblyFulfill()){for(var e=new AggregateError,i=this.length();i<this._values.length;++i)e.push(this._values[i]);this._reject(e)}},SomePromiseArray.prototype._fulfilled=function(){return this._totalResolved},SomePromiseArray.prototype._rejected=function(){return this._values.length-this.length()},SomePromiseArray.prototype._addRejected=function(reason){this._values.push(reason)},SomePromiseArray.prototype._addFulfilled=function(value){this._values[this._totalResolved++]=value},SomePromiseArray.prototype._canPossiblyFulfill=function(){return this.length()-this._rejected()},SomePromiseArray.prototype._getRangeError=function(count){var message="Input array must contain at least "+this._howMany+" items but contains only "+count+" items";return new RangeError(message)},SomePromiseArray.prototype._resolveEmptyArray=function(){this._reject(this._getRangeError(0))},Promise.some=function(promises,howMany){return some(promises,howMany)},Promise.prototype.some=function(howMany){return some(this,howMany)},Promise._SomePromiseArray=SomePromiseArray}},{"./errors.js":13,"./util.js":38}],34:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise){function PromiseInspection(promise){void 0!==promise?(promise=promise._target(),this._bitField=promise._bitField,this._settledValue=promise._settledValue):(this._bitField=0,this._settledValue=void 0)}PromiseInspection.prototype.value=function(){if(!this.isFulfilled())throw new TypeError("cannot get fulfillment value of a non-fulfilled promise\n\n    See http://goo.gl/hc1DLj\n");return this._settledValue},PromiseInspection.prototype.error=PromiseInspection.prototype.reason=function(){if(!this.isRejected())throw new TypeError("cannot get rejection reason of a non-rejected promise\n\n    See http://goo.gl/hPuiwB\n");return this._settledValue},PromiseInspection.prototype.isFulfilled=Promise.prototype._isFulfilled=function(){return(268435456&this._bitField)>0},PromiseInspection.prototype.isRejected=Promise.prototype._isRejected=function(){return(134217728&this._bitField)>0},PromiseInspection.prototype.isPending=Promise.prototype._isPending=function(){return 0==(402653184&this._bitField)},PromiseInspection.prototype.isResolved=Promise.prototype._isResolved=function(){return(402653184&this._bitField)>0},Promise.prototype.isPending=function(){return this._target()._isPending()},Promise.prototype.isRejected=function(){return this._target()._isRejected()},Promise.prototype.isFulfilled=function(){return this._target()._isFulfilled()},Promise.prototype.isResolved=function(){return this._target()._isResolved()},Promise.prototype._value=function(){return this._settledValue},Promise.prototype._reason=function(){return this._unsetRejectionIsUnhandled(),this._settledValue},Promise.prototype.value=function(){var target=this._target();if(!target.isFulfilled())throw new TypeError("cannot get fulfillment value of a non-fulfilled promise\n\n    See http://goo.gl/hc1DLj\n");return target._settledValue},Promise.prototype.reason=function(){var target=this._target();if(!target.isRejected())throw new TypeError("cannot get rejection reason of a non-rejected promise\n\n    See http://goo.gl/hPuiwB\n");return target._unsetRejectionIsUnhandled(),target._settledValue},Promise.PromiseInspection=PromiseInspection}},{}],35:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL){var util=_dereq_("./util.js"),errorObj=util.errorObj,isObject=util.isObject;function tryConvertToPromise(obj,context){if(isObject(obj)){if(obj instanceof Promise)return obj;if(isAnyBluebirdPromise(obj)){var ret=new Promise(INTERNAL);return obj._then(ret._fulfillUnchecked,ret._rejectUncheckedCheckError,ret._progressUnchecked,ret,null),ret}var then=util.tryCatch(getThen)(obj);if(then===errorObj){context&&context._pushContext();ret=Promise.reject(then.e);return context&&context._popContext(),ret}if("function"==typeof then)return doThenable(obj,then,context)}return obj}function getThen(obj){return obj.then}var hasProp={}.hasOwnProperty;function isAnyBluebirdPromise(obj){return hasProp.call(obj,"_promise0")}function doThenable(x,then,context){var promise=new Promise(INTERNAL),ret=promise;context&&context._pushContext(),promise._captureStackTrace(),context&&context._popContext();var synchronous=!0,result=util.tryCatch(then).call(x,resolveFromThenable,rejectFromThenable,progressFromThenable);function resolveFromThenable(value){promise&&(promise._resolveCallback(value),promise=null)}function rejectFromThenable(reason){promise&&(promise._rejectCallback(reason,synchronous,!0),promise=null)}function progressFromThenable(value){promise&&"function"==typeof promise._progress&&promise._progress(value)}return synchronous=!1,promise&&result===errorObj&&(promise._rejectCallback(result.e,!0,!0),promise=null),ret}return tryConvertToPromise}},{"./util.js":38}],36:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,INTERNAL){var util=_dereq_("./util.js"),TimeoutError=Promise.TimeoutError,afterTimeout=function(promise,message){var err;promise.isPending()&&(!util.isPrimitive(message)&&message instanceof Error?err=message:("string"!=typeof message&&(message="operation timed out"),err=new TimeoutError(message)),util.markAsOriginatingFromRejection(err),promise._attachExtraTrace(err),promise._cancel(err))},afterValue=function(value){return delay(+this).thenReturn(value)},delay=Promise.delay=function(value,ms){if(void 0===ms){ms=value,value=void 0;var ret=new Promise(INTERNAL);return setTimeout((function(){ret._fulfill()}),ms),ret}return ms=+ms,Promise.resolve(value)._then(afterValue,null,null,ms,void 0)};function successClear(value){var handle=this;return handle instanceof Number&&(handle=+handle),clearTimeout(handle),value}function failureClear(reason){var handle=this;throw handle instanceof Number&&(handle=+handle),clearTimeout(handle),reason}Promise.prototype.delay=function(ms){return delay(this,ms)},Promise.prototype.timeout=function(ms,message){ms=+ms;var ret=this.then().cancellable();ret._cancellationParent=this;var handle=setTimeout((function(){afterTimeout(ret,message)}),ms);return ret._then(successClear,failureClear,void 0,handle,void 0)}}},{"./util.js":38}],37:[function(_dereq_,module,exports){"use strict";module.exports=function(Promise,apiRejection,tryConvertToPromise,createContext){var TypeError=_dereq_("./errors.js").TypeError,inherits=_dereq_("./util.js").inherits,PromiseInspection=Promise.PromiseInspection;function inspectionMapper(inspections){for(var len=inspections.length,i=0;i<len;++i){var inspection=inspections[i];if(inspection.isRejected())return Promise.reject(inspection.error());inspections[i]=inspection._settledValue}return inspections}function thrower(e){setTimeout((function(){throw e}),0)}function castPreservingDisposable(thenable){var maybePromise=tryConvertToPromise(thenable);return maybePromise!==thenable&&"function"==typeof thenable._isDisposable&&"function"==typeof thenable._getDisposer&&thenable._isDisposable()&&maybePromise._setDisposable(thenable._getDisposer()),maybePromise}function dispose(resources,inspection){var i=0,len=resources.length,ret=Promise.defer();function iterator(){if(i>=len)return ret.resolve();var maybePromise=castPreservingDisposable(resources[i++]);if(maybePromise instanceof Promise&&maybePromise._isDisposable()){try{maybePromise=tryConvertToPromise(maybePromise._getDisposer().tryDispose(inspection),resources.promise)}catch(e){return thrower(e)}if(maybePromise instanceof Promise)return maybePromise._then(iterator,thrower,null,null,null)}iterator()}return iterator(),ret.promise}function disposerSuccess(value){var inspection=new PromiseInspection;return inspection._settledValue=value,inspection._bitField=268435456,dispose(this,inspection).thenReturn(value)}function disposerFail(reason){var inspection=new PromiseInspection;return inspection._settledValue=reason,inspection._bitField=134217728,dispose(this,inspection).thenThrow(reason)}function Disposer(data,promise,context){this._data=data,this._promise=promise,this._context=context}function FunctionDisposer(fn,promise,context){this.constructor$(fn,promise,context)}function maybeUnwrapDisposer(value){return Disposer.isDisposer(value)?(this.resources[this.index]._setDisposable(value),value.promise()):value}Disposer.prototype.data=function(){return this._data},Disposer.prototype.promise=function(){return this._promise},Disposer.prototype.resource=function(){return this.promise().isFulfilled()?this.promise().value():null},Disposer.prototype.tryDispose=function(inspection){var resource=this.resource(),context=this._context;void 0!==context&&context._pushContext();var ret=null!==resource?this.doDispose(resource,inspection):null;return void 0!==context&&context._popContext(),this._promise._unsetDisposable(),this._data=null,ret},Disposer.isDisposer=function(d){return null!=d&&"function"==typeof d.resource&&"function"==typeof d.tryDispose},inherits(FunctionDisposer,Disposer),FunctionDisposer.prototype.doDispose=function(resource,inspection){return this.data().call(resource,resource,inspection)},Promise.using=function(){var len=arguments.length;if(len<2)return apiRejection("you must pass at least 2 arguments to Promise.using");var input,fn=arguments[len-1];if("function"!=typeof fn)return apiRejection("fn must be a function\n\n    See http://goo.gl/916lJJ\n");var spreadArgs=!0;2===len&&Array.isArray(arguments[0])?(len=(input=arguments[0]).length,spreadArgs=!1):(input=arguments,len--);for(var resources=new Array(len),i=0;i<len;++i){var resource=input[i];if(Disposer.isDisposer(resource)){var disposer=resource;(resource=resource.promise())._setDisposable(disposer)}else{var maybePromise=tryConvertToPromise(resource);maybePromise instanceof Promise&&(resource=maybePromise._then(maybeUnwrapDisposer,null,null,{resources:resources,index:i},void 0))}resources[i]=resource}var promise=Promise.settle(resources).then(inspectionMapper).then((function(vals){var ret;promise._pushContext();try{ret=spreadArgs?fn.apply(void 0,vals):fn.call(void 0,vals)}finally{promise._popContext()}return ret}))._then(disposerSuccess,disposerFail,void 0,resources,void 0);return resources.promise=promise,promise},Promise.prototype._setDisposable=function(disposer){this._bitField=262144|this._bitField,this._disposer=disposer},Promise.prototype._isDisposable=function(){return(262144&this._bitField)>0},Promise.prototype._getDisposer=function(){return this._disposer},Promise.prototype._unsetDisposable=function(){this._bitField=-262145&this._bitField,this._disposer=void 0},Promise.prototype.disposer=function(fn){if("function"==typeof fn)return new FunctionDisposer(fn,this,createContext());throw new TypeError}}},{"./errors.js":13,"./util.js":38}],38:[function(_dereq_,module,exports){"use strict";var es5=_dereq_("./es5.js"),canEvaluate="undefined"==typeof navigator,haveGetters=function(){try{var o={};return es5.defineProperty(o,"f",{get:function(){return 3}}),3===o.f}catch(e){return!1}}(),errorObj={e:{}},tryCatchTarget;function tryCatcher(){try{var target=tryCatchTarget;return tryCatchTarget=null,target.apply(this,arguments)}catch(e){return errorObj.e=e,errorObj}}function tryCatch(fn){return tryCatchTarget=fn,tryCatcher}var inherits=function(Child,Parent){var hasProp={}.hasOwnProperty;function T(){for(var propertyName in this.constructor=Child,this.constructor$=Parent,Parent.prototype)hasProp.call(Parent.prototype,propertyName)&&"$"!==propertyName.charAt(propertyName.length-1)&&(this[propertyName+"$"]=Parent.prototype[propertyName])}return T.prototype=Parent.prototype,Child.prototype=new T,Child.prototype};function isPrimitive(val){return null==val||!0===val||!1===val||"string"==typeof val||"number"==typeof val}function isObject(value){return!isPrimitive(value)}function maybeWrapAsError(maybeError){return isPrimitive(maybeError)?new Error(safeToString(maybeError)):maybeError}function withAppended(target,appendee){var i,len=target.length,ret=new Array(len+1);for(i=0;i<len;++i)ret[i]=target[i];return ret[i]=appendee,ret}function getDataPropertyOrDefault(obj,key,defaultValue){if(!es5.isES5)return{}.hasOwnProperty.call(obj,key)?obj[key]:void 0;var desc=Object.getOwnPropertyDescriptor(obj,key);return null!=desc?null==desc.get&&null==desc.set?desc.value:defaultValue:void 0}function notEnumerableProp(obj,name,value){if(isPrimitive(obj))return obj;var descriptor={value:value,configurable:!0,enumerable:!1,writable:!0};return es5.defineProperty(obj,name,descriptor),obj}function thrower(r){throw r}var inheritedDataKeys=function(){var excludedPrototypes=[Array.prototype,Object.prototype,Function.prototype],isExcludedProto=function(val){for(var i=0;i<excludedPrototypes.length;++i)if(excludedPrototypes[i]===val)return!0;return!1};if(es5.isES5){var getKeys=Object.getOwnPropertyNames;return function(obj){for(var ret=[],visitedKeys=Object.create(null);null!=obj&&!isExcludedProto(obj);){var keys;try{keys=getKeys(obj)}catch(e){return ret}for(var i=0;i<keys.length;++i){var key=keys[i];if(!visitedKeys[key]){visitedKeys[key]=!0;var desc=Object.getOwnPropertyDescriptor(obj,key);null!=desc&&null==desc.get&&null==desc.set&&ret.push(key)}}obj=es5.getPrototypeOf(obj)}return ret}}var hasProp={}.hasOwnProperty;return function(obj){if(isExcludedProto(obj))return[];var ret=[];enumeration:for(var key in obj)if(hasProp.call(obj,key))ret.push(key);else{for(var i=0;i<excludedPrototypes.length;++i)if(hasProp.call(excludedPrototypes[i],key))continue enumeration;ret.push(key)}return ret}}(),thisAssignmentPattern=/this\s*\.\s*\S+\s*=/;function isClass(fn){try{if("function"==typeof fn){var keys=es5.names(fn.prototype),hasMethods=es5.isES5&&keys.length>1,hasMethodsOtherThanConstructor=keys.length>0&&!(1===keys.length&&"constructor"===keys[0]),hasThisAssignmentAndStaticMethods=thisAssignmentPattern.test(fn+"")&&es5.names(fn).length>0;if(hasMethods||hasMethodsOtherThanConstructor||hasThisAssignmentAndStaticMethods)return!0}return!1}catch(e){return!1}}function toFastProperties(obj){function f(){}f.prototype=obj;for(var l=8;l--;)new f;return obj}var rident=/^[a-z$_][a-z$_0-9]*$/i;function isIdentifier(str){return rident.test(str)}function filledRange(count,prefix,suffix){for(var ret=new Array(count),i=0;i<count;++i)ret[i]=prefix+i+suffix;return ret}function safeToString(obj){try{return obj+""}catch(e){return"[no string representation]"}}function markAsOriginatingFromRejection(e){try{notEnumerableProp(e,"isOperational",!0)}catch(ignore){}}function originatesFromRejection(e){return null!=e&&(e instanceof Error.__BluebirdErrorTypes__.OperationalError||!0===e.isOperational)}function canAttachTrace(obj){return obj instanceof Error&&es5.propertyIsWritable(obj,"stack")}var ensureErrorObject="stack"in new Error?function(value){return canAttachTrace(value)?value:new Error(safeToString(value))}:function(value){if(canAttachTrace(value))return value;try{throw new Error(safeToString(value))}catch(err){return err}};function classString(obj){return{}.toString.call(obj)}function copyDescriptors(from,to,filter){for(var keys=es5.names(from),i=0;i<keys.length;++i){var key=keys[i];if(filter(key))try{es5.defineProperty(to,key,es5.getDescriptor(from,key))}catch(ignore){}}}var ret={isClass:isClass,isIdentifier:isIdentifier,inheritedDataKeys:inheritedDataKeys,getDataPropertyOrDefault:getDataPropertyOrDefault,thrower:thrower,isArray:es5.isArray,haveGetters:haveGetters,notEnumerableProp:notEnumerableProp,isPrimitive:isPrimitive,isObject:isObject,canEvaluate:canEvaluate,errorObj:errorObj,tryCatch:tryCatch,inherits:inherits,withAppended:withAppended,maybeWrapAsError:maybeWrapAsError,toFastProperties:toFastProperties,filledRange:filledRange,toString:safeToString,canAttachTrace:canAttachTrace,ensureErrorObject:ensureErrorObject,originatesFromRejection:originatesFromRejection,markAsOriginatingFromRejection:markAsOriginatingFromRejection,classString:classString,copyDescriptors:copyDescriptors,hasDevTools:"undefined"!=typeof chrome&&chrome&&"function"==typeof chrome.loadTimes,isNode:void 0!==process&&"[object process]"===classString(process).toLowerCase()},version;ret.isRecentNode=ret.isNode&&(version=process.versions.node.split(".").map(Number),0===version[0]&&version[1]>10||version[0]>0),ret.isNode&&ret.toFastProperties(process);try{throw new Error}catch(e){ret.lastLineError=e}module.exports=ret},{"./es5.js":14}]},{},[4])(4)})),"undefined"!=typeof window&&null!==window?window.P=window.Promise:"undefined"!=typeof self&&null!==self&&(self.P=self.Promise)}).call(this,require("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{_process:26}],3:[function(require,module,exports){(function(global){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <http://feross.org>
 * @license  MIT
 */
"use strict";var base64=require("base64-js"),ieee754=require("ieee754"),isArray=require("isarray");exports.Buffer=Buffer,exports.SlowBuffer=SlowBuffer,exports.INSPECT_MAX_BYTES=50,Buffer.poolSize=8192;var rootParent={};function typedArraySupport(){function Bar(){}try{var arr=new Uint8Array(1);return arr.foo=function(){return 42},arr.constructor=Bar,42===arr.foo()&&arr.constructor===Bar&&"function"==typeof arr.subarray&&0===arr.subarray(1,1).byteLength}catch(e){return!1}}function kMaxLength(){return Buffer.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function Buffer(arg){return this instanceof Buffer?(Buffer.TYPED_ARRAY_SUPPORT||(this.length=0,this.parent=void 0),"number"==typeof arg?fromNumber(this,arg):"string"==typeof arg?fromString(this,arg,arguments.length>1?arguments[1]:"utf8"):fromObject(this,arg)):arguments.length>1?new Buffer(arg,arguments[1]):new Buffer(arg)}function fromNumber(that,length){if(that=allocate(that,length<0?0:0|checked(length)),!Buffer.TYPED_ARRAY_SUPPORT)for(var i=0;i<length;i++)that[i]=0;return that}function fromString(that,string,encoding){return"string"==typeof encoding&&""!==encoding||(encoding="utf8"),(that=allocate(that,0|byteLength(string,encoding))).write(string,encoding),that}function fromObject(that,object){if(Buffer.isBuffer(object))return fromBuffer(that,object);if(isArray(object))return fromArray(that,object);if(null==object)throw new TypeError("must start with number, buffer, array or string");if("undefined"!=typeof ArrayBuffer){if(object.buffer instanceof ArrayBuffer)return fromTypedArray(that,object);if(object instanceof ArrayBuffer)return fromArrayBuffer(that,object)}return object.length?fromArrayLike(that,object):fromJsonObject(that,object)}function fromBuffer(that,buffer){var length=0|checked(buffer.length);return that=allocate(that,length),buffer.copy(that,0,0,length),that}function fromArray(that,array){var length=0|checked(array.length);that=allocate(that,length);for(var i=0;i<length;i+=1)that[i]=255&array[i];return that}function fromTypedArray(that,array){var length=0|checked(array.length);that=allocate(that,length);for(var i=0;i<length;i+=1)that[i]=255&array[i];return that}function fromArrayBuffer(that,array){return Buffer.TYPED_ARRAY_SUPPORT?(array.byteLength,that=Buffer._augment(new Uint8Array(array))):that=fromTypedArray(that,new Uint8Array(array)),that}function fromArrayLike(that,array){var length=0|checked(array.length);that=allocate(that,length);for(var i=0;i<length;i+=1)that[i]=255&array[i];return that}function fromJsonObject(that,object){var array,length=0;"Buffer"===object.type&&isArray(object.data)&&(length=0|checked((array=object.data).length)),that=allocate(that,length);for(var i=0;i<length;i+=1)that[i]=255&array[i];return that}function allocate(that,length){return Buffer.TYPED_ARRAY_SUPPORT?(that=Buffer._augment(new Uint8Array(length))).__proto__=Buffer.prototype:(that.length=length,that._isBuffer=!0),0!==length&&length<=Buffer.poolSize>>>1&&(that.parent=rootParent),that}function checked(length){if(length>=kMaxLength())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+kMaxLength().toString(16)+" bytes");return 0|length}function SlowBuffer(subject,encoding){if(!(this instanceof SlowBuffer))return new SlowBuffer(subject,encoding);var buf=new Buffer(subject,encoding);return delete buf.parent,buf}function byteLength(string,encoding){"string"!=typeof string&&(string=""+string);var len=string.length;if(0===len)return 0;for(var loweredCase=!1;;)switch(encoding){case"ascii":case"binary":case"raw":case"raws":return len;case"utf8":case"utf-8":return utf8ToBytes(string).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*len;case"hex":return len>>>1;case"base64":return base64ToBytes(string).length;default:if(loweredCase)return utf8ToBytes(string).length;encoding=(""+encoding).toLowerCase(),loweredCase=!0}}function slowToString(encoding,start,end){var loweredCase=!1;if(encoding||(encoding="utf8"),(start|=0)<0&&(start=0),(end=void 0===end||end===1/0?this.length:0|end)>this.length&&(end=this.length),end<=start)return"";for(;;)switch(encoding){case"hex":return hexSlice(this,start,end);case"utf8":case"utf-8":return utf8Slice(this,start,end);case"ascii":return asciiSlice(this,start,end);case"binary":return binarySlice(this,start,end);case"base64":return base64Slice(this,start,end);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return utf16leSlice(this,start,end);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(encoding+"").toLowerCase(),loweredCase=!0}}function hexWrite(buf,string,offset,length){offset=Number(offset)||0;var remaining=buf.length-offset;length?(length=Number(length))>remaining&&(length=remaining):length=remaining;var strLen=string.length;if(strLen%2!=0)throw new Error("Invalid hex string");length>strLen/2&&(length=strLen/2);for(var i=0;i<length;i++){var parsed=parseInt(string.substr(2*i,2),16);if(isNaN(parsed))throw new Error("Invalid hex string");buf[offset+i]=parsed}return i}function utf8Write(buf,string,offset,length){return blitBuffer(utf8ToBytes(string,buf.length-offset),buf,offset,length)}function asciiWrite(buf,string,offset,length){return blitBuffer(asciiToBytes(string),buf,offset,length)}function binaryWrite(buf,string,offset,length){return asciiWrite(buf,string,offset,length)}function base64Write(buf,string,offset,length){return blitBuffer(base64ToBytes(string),buf,offset,length)}function ucs2Write(buf,string,offset,length){return blitBuffer(utf16leToBytes(string,buf.length-offset),buf,offset,length)}function base64Slice(buf,start,end){return 0===start&&end===buf.length?base64.fromByteArray(buf):base64.fromByteArray(buf.slice(start,end))}function utf8Slice(buf,start,end){end=Math.min(buf.length,end);for(var res=[],i=start;i<end;){var secondByte,thirdByte,fourthByte,tempCodePoint,firstByte=buf[i],codePoint=null,bytesPerSequence=firstByte>239?4:firstByte>223?3:firstByte>191?2:1;if(i+bytesPerSequence<=end)switch(bytesPerSequence){case 1:firstByte<128&&(codePoint=firstByte);break;case 2:128==(192&(secondByte=buf[i+1]))&&(tempCodePoint=(31&firstByte)<<6|63&secondByte)>127&&(codePoint=tempCodePoint);break;case 3:secondByte=buf[i+1],thirdByte=buf[i+2],128==(192&secondByte)&&128==(192&thirdByte)&&(tempCodePoint=(15&firstByte)<<12|(63&secondByte)<<6|63&thirdByte)>2047&&(tempCodePoint<55296||tempCodePoint>57343)&&(codePoint=tempCodePoint);break;case 4:secondByte=buf[i+1],thirdByte=buf[i+2],fourthByte=buf[i+3],128==(192&secondByte)&&128==(192&thirdByte)&&128==(192&fourthByte)&&(tempCodePoint=(15&firstByte)<<18|(63&secondByte)<<12|(63&thirdByte)<<6|63&fourthByte)>65535&&tempCodePoint<1114112&&(codePoint=tempCodePoint)}null===codePoint?(codePoint=65533,bytesPerSequence=1):codePoint>65535&&(codePoint-=65536,res.push(codePoint>>>10&1023|55296),codePoint=56320|1023&codePoint),res.push(codePoint),i+=bytesPerSequence}return decodeCodePointsArray(res)}Buffer.TYPED_ARRAY_SUPPORT=void 0!==global.TYPED_ARRAY_SUPPORT?global.TYPED_ARRAY_SUPPORT:typedArraySupport(),Buffer.TYPED_ARRAY_SUPPORT?(Buffer.prototype.__proto__=Uint8Array.prototype,Buffer.__proto__=Uint8Array):(Buffer.prototype.length=void 0,Buffer.prototype.parent=void 0),Buffer.isBuffer=function(b){return!(null==b||!b._isBuffer)},Buffer.compare=function(a,b){if(!Buffer.isBuffer(a)||!Buffer.isBuffer(b))throw new TypeError("Arguments must be Buffers");if(a===b)return 0;for(var x=a.length,y=b.length,i=0,len=Math.min(x,y);i<len&&a[i]===b[i];)++i;return i!==len&&(x=a[i],y=b[i]),x<y?-1:y<x?1:0},Buffer.isEncoding=function(encoding){switch(String(encoding).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"binary":case"base64":case"raw":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},Buffer.concat=function(list,length){if(!isArray(list))throw new TypeError("list argument must be an Array of Buffers.");if(0===list.length)return new Buffer(0);var i;if(void 0===length)for(length=0,i=0;i<list.length;i++)length+=list[i].length;var buf=new Buffer(length),pos=0;for(i=0;i<list.length;i++){var item=list[i];item.copy(buf,pos),pos+=item.length}return buf},Buffer.byteLength=byteLength,Buffer.prototype.toString=function(){var length=0|this.length;return 0===length?"":0===arguments.length?utf8Slice(this,0,length):slowToString.apply(this,arguments)},Buffer.prototype.equals=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b||0===Buffer.compare(this,b)},Buffer.prototype.inspect=function(){var str="",max=exports.INSPECT_MAX_BYTES;return this.length>0&&(str=this.toString("hex",0,max).match(/.{2}/g).join(" "),this.length>max&&(str+=" ... ")),"<Buffer "+str+">"},Buffer.prototype.compare=function(b){if(!Buffer.isBuffer(b))throw new TypeError("Argument must be a Buffer");return this===b?0:Buffer.compare(this,b)},Buffer.prototype.indexOf=function(val,byteOffset){if(byteOffset>2147483647?byteOffset=2147483647:byteOffset<-2147483648&&(byteOffset=-2147483648),byteOffset>>=0,0===this.length)return-1;if(byteOffset>=this.length)return-1;if(byteOffset<0&&(byteOffset=Math.max(this.length+byteOffset,0)),"string"==typeof val)return 0===val.length?-1:String.prototype.indexOf.call(this,val,byteOffset);if(Buffer.isBuffer(val))return arrayIndexOf(this,val,byteOffset);if("number"==typeof val)return Buffer.TYPED_ARRAY_SUPPORT&&"function"===Uint8Array.prototype.indexOf?Uint8Array.prototype.indexOf.call(this,val,byteOffset):arrayIndexOf(this,[val],byteOffset);function arrayIndexOf(arr,val,byteOffset){for(var foundIndex=-1,i=0;byteOffset+i<arr.length;i++)if(arr[byteOffset+i]===val[-1===foundIndex?0:i-foundIndex]){if(-1===foundIndex&&(foundIndex=i),i-foundIndex+1===val.length)return byteOffset+foundIndex}else foundIndex=-1;return-1}throw new TypeError("val must be string, number or Buffer")},Buffer.prototype.get=function(offset){return console.log(".get() is deprecated. Access using array indexes instead."),this.readUInt8(offset)},Buffer.prototype.set=function(v,offset){return console.log(".set() is deprecated. Access using array indexes instead."),this.writeUInt8(v,offset)},Buffer.prototype.write=function(string,offset,length,encoding){if(void 0===offset)encoding="utf8",length=this.length,offset=0;else if(void 0===length&&"string"==typeof offset)encoding=offset,length=this.length,offset=0;else if(isFinite(offset))offset|=0,isFinite(length)?(length|=0,void 0===encoding&&(encoding="utf8")):(encoding=length,length=void 0);else{var swap=encoding;encoding=offset,offset=0|length,length=swap}var remaining=this.length-offset;if((void 0===length||length>remaining)&&(length=remaining),string.length>0&&(length<0||offset<0)||offset>this.length)throw new RangeError("attempt to write outside buffer bounds");encoding||(encoding="utf8");for(var loweredCase=!1;;)switch(encoding){case"hex":return hexWrite(this,string,offset,length);case"utf8":case"utf-8":return utf8Write(this,string,offset,length);case"ascii":return asciiWrite(this,string,offset,length);case"binary":return binaryWrite(this,string,offset,length);case"base64":return base64Write(this,string,offset,length);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return ucs2Write(this,string,offset,length);default:if(loweredCase)throw new TypeError("Unknown encoding: "+encoding);encoding=(""+encoding).toLowerCase(),loweredCase=!0}},Buffer.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var MAX_ARGUMENTS_LENGTH=4096;function decodeCodePointsArray(codePoints){var len=codePoints.length;if(len<=MAX_ARGUMENTS_LENGTH)return String.fromCharCode.apply(String,codePoints);for(var res="",i=0;i<len;)res+=String.fromCharCode.apply(String,codePoints.slice(i,i+=MAX_ARGUMENTS_LENGTH));return res}function asciiSlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;i++)ret+=String.fromCharCode(127&buf[i]);return ret}function binarySlice(buf,start,end){var ret="";end=Math.min(buf.length,end);for(var i=start;i<end;i++)ret+=String.fromCharCode(buf[i]);return ret}function hexSlice(buf,start,end){var len=buf.length;(!start||start<0)&&(start=0),(!end||end<0||end>len)&&(end=len);for(var out="",i=start;i<end;i++)out+=toHex(buf[i]);return out}function utf16leSlice(buf,start,end){for(var bytes=buf.slice(start,end),res="",i=0;i<bytes.length;i+=2)res+=String.fromCharCode(bytes[i]+256*bytes[i+1]);return res}function checkOffset(offset,ext,length){if(offset%1!=0||offset<0)throw new RangeError("offset is not uint");if(offset+ext>length)throw new RangeError("Trying to access beyond buffer length")}function checkInt(buf,value,offset,ext,max,min){if(!Buffer.isBuffer(buf))throw new TypeError("buffer must be a Buffer instance");if(value>max||value<min)throw new RangeError("value is out of bounds");if(offset+ext>buf.length)throw new RangeError("index out of range")}function objectWriteUInt16(buf,value,offset,littleEndian){value<0&&(value=65535+value+1);for(var i=0,j=Math.min(buf.length-offset,2);i<j;i++)buf[offset+i]=(value&255<<8*(littleEndian?i:1-i))>>>8*(littleEndian?i:1-i)}function objectWriteUInt32(buf,value,offset,littleEndian){value<0&&(value=4294967295+value+1);for(var i=0,j=Math.min(buf.length-offset,4);i<j;i++)buf[offset+i]=value>>>8*(littleEndian?i:3-i)&255}function checkIEEE754(buf,value,offset,ext,max,min){if(value>max||value<min)throw new RangeError("value is out of bounds");if(offset+ext>buf.length)throw new RangeError("index out of range");if(offset<0)throw new RangeError("index out of range")}function writeFloat(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,4,34028234663852886e22,-34028234663852886e22),ieee754.write(buf,value,offset,littleEndian,23,4),offset+4}function writeDouble(buf,value,offset,littleEndian,noAssert){return noAssert||checkIEEE754(buf,value,offset,8,17976931348623157e292,-17976931348623157e292),ieee754.write(buf,value,offset,littleEndian,52,8),offset+8}Buffer.prototype.slice=function(start,end){var newBuf,len=this.length;if((start=~~start)<0?(start+=len)<0&&(start=0):start>len&&(start=len),(end=void 0===end?len:~~end)<0?(end+=len)<0&&(end=0):end>len&&(end=len),end<start&&(end=start),Buffer.TYPED_ARRAY_SUPPORT)newBuf=Buffer._augment(this.subarray(start,end));else{var sliceLen=end-start;newBuf=new Buffer(sliceLen,void 0);for(var i=0;i<sliceLen;i++)newBuf[i]=this[i+start]}return newBuf.length&&(newBuf.parent=this.parent||this),newBuf},Buffer.prototype.readUIntLE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val},Buffer.prototype.readUIntBE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset+--byteLength],mul=1;byteLength>0&&(mul*=256);)val+=this[offset+--byteLength]*mul;return val},Buffer.prototype.readUInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),this[offset]},Buffer.prototype.readUInt16LE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]|this[offset+1]<<8},Buffer.prototype.readUInt16BE=function(offset,noAssert){return noAssert||checkOffset(offset,2,this.length),this[offset]<<8|this[offset+1]},Buffer.prototype.readUInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),(this[offset]|this[offset+1]<<8|this[offset+2]<<16)+16777216*this[offset+3]},Buffer.prototype.readUInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),16777216*this[offset]+(this[offset+1]<<16|this[offset+2]<<8|this[offset+3])},Buffer.prototype.readIntLE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var val=this[offset],mul=1,i=0;++i<byteLength&&(mul*=256);)val+=this[offset+i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readIntBE=function(offset,byteLength,noAssert){offset|=0,byteLength|=0,noAssert||checkOffset(offset,byteLength,this.length);for(var i=byteLength,mul=1,val=this[offset+--i];i>0&&(mul*=256);)val+=this[offset+--i]*mul;return val>=(mul*=128)&&(val-=Math.pow(2,8*byteLength)),val},Buffer.prototype.readInt8=function(offset,noAssert){return noAssert||checkOffset(offset,1,this.length),128&this[offset]?-1*(255-this[offset]+1):this[offset]},Buffer.prototype.readInt16LE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset]|this[offset+1]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt16BE=function(offset,noAssert){noAssert||checkOffset(offset,2,this.length);var val=this[offset+1]|this[offset]<<8;return 32768&val?4294901760|val:val},Buffer.prototype.readInt32LE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]|this[offset+1]<<8|this[offset+2]<<16|this[offset+3]<<24},Buffer.prototype.readInt32BE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),this[offset]<<24|this[offset+1]<<16|this[offset+2]<<8|this[offset+3]},Buffer.prototype.readFloatLE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!0,23,4)},Buffer.prototype.readFloatBE=function(offset,noAssert){return noAssert||checkOffset(offset,4,this.length),ieee754.read(this,offset,!1,23,4)},Buffer.prototype.readDoubleLE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!0,52,8)},Buffer.prototype.readDoubleBE=function(offset,noAssert){return noAssert||checkOffset(offset,8,this.length),ieee754.read(this,offset,!1,52,8)},Buffer.prototype.writeUIntLE=function(value,offset,byteLength,noAssert){value=+value,offset|=0,byteLength|=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength),0);var mul=1,i=0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUIntBE=function(value,offset,byteLength,noAssert){value=+value,offset|=0,byteLength|=0,noAssert||checkInt(this,value,offset,byteLength,Math.pow(2,8*byteLength),0);var i=byteLength-1,mul=1;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=value/mul&255;return offset+byteLength},Buffer.prototype.writeUInt8=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,1,255,0),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),this[offset]=255&value,offset+1},Buffer.prototype.writeUInt16LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeUInt16BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,65535,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeUInt32LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset+3]=value>>>24,this[offset+2]=value>>>16,this[offset+1]=value>>>8,this[offset]=255&value):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeUInt32BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,4294967295,0),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeIntLE=function(value,offset,byteLength,noAssert){if(value=+value,offset|=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=0,mul=1,sub=value<0?1:0;for(this[offset]=255&value;++i<byteLength&&(mul*=256);)this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeIntBE=function(value,offset,byteLength,noAssert){if(value=+value,offset|=0,!noAssert){var limit=Math.pow(2,8*byteLength-1);checkInt(this,value,offset,byteLength,limit-1,-limit)}var i=byteLength-1,mul=1,sub=value<0?1:0;for(this[offset+i]=255&value;--i>=0&&(mul*=256);)this[offset+i]=(value/mul>>0)-sub&255;return offset+byteLength},Buffer.prototype.writeInt8=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,1,127,-128),Buffer.TYPED_ARRAY_SUPPORT||(value=Math.floor(value)),value<0&&(value=255+value+1),this[offset]=255&value,offset+1},Buffer.prototype.writeInt16LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8):objectWriteUInt16(this,value,offset,!0),offset+2},Buffer.prototype.writeInt16BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,2,32767,-32768),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>8,this[offset+1]=255&value):objectWriteUInt16(this,value,offset,!1),offset+2},Buffer.prototype.writeInt32LE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=255&value,this[offset+1]=value>>>8,this[offset+2]=value>>>16,this[offset+3]=value>>>24):objectWriteUInt32(this,value,offset,!0),offset+4},Buffer.prototype.writeInt32BE=function(value,offset,noAssert){return value=+value,offset|=0,noAssert||checkInt(this,value,offset,4,2147483647,-2147483648),value<0&&(value=4294967295+value+1),Buffer.TYPED_ARRAY_SUPPORT?(this[offset]=value>>>24,this[offset+1]=value>>>16,this[offset+2]=value>>>8,this[offset+3]=255&value):objectWriteUInt32(this,value,offset,!1),offset+4},Buffer.prototype.writeFloatLE=function(value,offset,noAssert){return writeFloat(this,value,offset,!0,noAssert)},Buffer.prototype.writeFloatBE=function(value,offset,noAssert){return writeFloat(this,value,offset,!1,noAssert)},Buffer.prototype.writeDoubleLE=function(value,offset,noAssert){return writeDouble(this,value,offset,!0,noAssert)},Buffer.prototype.writeDoubleBE=function(value,offset,noAssert){return writeDouble(this,value,offset,!1,noAssert)},Buffer.prototype.copy=function(target,targetStart,start,end){if(start||(start=0),end||0===end||(end=this.length),targetStart>=target.length&&(targetStart=target.length),targetStart||(targetStart=0),end>0&&end<start&&(end=start),end===start)return 0;if(0===target.length||0===this.length)return 0;if(targetStart<0)throw new RangeError("targetStart out of bounds");if(start<0||start>=this.length)throw new RangeError("sourceStart out of bounds");if(end<0)throw new RangeError("sourceEnd out of bounds");end>this.length&&(end=this.length),target.length-targetStart<end-start&&(end=target.length-targetStart+start);var i,len=end-start;if(this===target&&start<targetStart&&targetStart<end)for(i=len-1;i>=0;i--)target[i+targetStart]=this[i+start];else if(len<1e3||!Buffer.TYPED_ARRAY_SUPPORT)for(i=0;i<len;i++)target[i+targetStart]=this[i+start];else target._set(this.subarray(start,start+len),targetStart);return len},Buffer.prototype.fill=function(value,start,end){if(value||(value=0),start||(start=0),end||(end=this.length),end<start)throw new RangeError("end < start");if(end!==start&&0!==this.length){if(start<0||start>=this.length)throw new RangeError("start out of bounds");if(end<0||end>this.length)throw new RangeError("end out of bounds");var i;if("number"==typeof value)for(i=start;i<end;i++)this[i]=value;else{var bytes=utf8ToBytes(value.toString()),len=bytes.length;for(i=start;i<end;i++)this[i]=bytes[i%len]}return this}},Buffer.prototype.toArrayBuffer=function(){if("undefined"!=typeof Uint8Array){if(Buffer.TYPED_ARRAY_SUPPORT)return new Buffer(this).buffer;for(var buf=new Uint8Array(this.length),i=0,len=buf.length;i<len;i+=1)buf[i]=this[i];return buf.buffer}throw new TypeError("Buffer.toArrayBuffer not supported in this browser")};var BP=Buffer.prototype;Buffer._augment=function(arr){return arr.constructor=Buffer,arr._isBuffer=!0,arr._set=arr.set,arr.get=BP.get,arr.set=BP.set,arr.write=BP.write,arr.toString=BP.toString,arr.toLocaleString=BP.toString,arr.toJSON=BP.toJSON,arr.equals=BP.equals,arr.compare=BP.compare,arr.indexOf=BP.indexOf,arr.copy=BP.copy,arr.slice=BP.slice,arr.readUIntLE=BP.readUIntLE,arr.readUIntBE=BP.readUIntBE,arr.readUInt8=BP.readUInt8,arr.readUInt16LE=BP.readUInt16LE,arr.readUInt16BE=BP.readUInt16BE,arr.readUInt32LE=BP.readUInt32LE,arr.readUInt32BE=BP.readUInt32BE,arr.readIntLE=BP.readIntLE,arr.readIntBE=BP.readIntBE,arr.readInt8=BP.readInt8,arr.readInt16LE=BP.readInt16LE,arr.readInt16BE=BP.readInt16BE,arr.readInt32LE=BP.readInt32LE,arr.readInt32BE=BP.readInt32BE,arr.readFloatLE=BP.readFloatLE,arr.readFloatBE=BP.readFloatBE,arr.readDoubleLE=BP.readDoubleLE,arr.readDoubleBE=BP.readDoubleBE,arr.writeUInt8=BP.writeUInt8,arr.writeUIntLE=BP.writeUIntLE,arr.writeUIntBE=BP.writeUIntBE,arr.writeUInt16LE=BP.writeUInt16LE,arr.writeUInt16BE=BP.writeUInt16BE,arr.writeUInt32LE=BP.writeUInt32LE,arr.writeUInt32BE=BP.writeUInt32BE,arr.writeIntLE=BP.writeIntLE,arr.writeIntBE=BP.writeIntBE,arr.writeInt8=BP.writeInt8,arr.writeInt16LE=BP.writeInt16LE,arr.writeInt16BE=BP.writeInt16BE,arr.writeInt32LE=BP.writeInt32LE,arr.writeInt32BE=BP.writeInt32BE,arr.writeFloatLE=BP.writeFloatLE,arr.writeFloatBE=BP.writeFloatBE,arr.writeDoubleLE=BP.writeDoubleLE,arr.writeDoubleBE=BP.writeDoubleBE,arr.fill=BP.fill,arr.inspect=BP.inspect,arr.toArrayBuffer=BP.toArrayBuffer,arr};var INVALID_BASE64_RE=/[^+\/0-9A-Za-z-_]/g;function base64clean(str){if((str=stringtrim(str).replace(INVALID_BASE64_RE,"")).length<2)return"";for(;str.length%4!=0;)str+="=";return str}function stringtrim(str){return str.trim?str.trim():str.replace(/^\s+|\s+$/g,"")}function toHex(n){return n<16?"0"+n.toString(16):n.toString(16)}function utf8ToBytes(string,units){var codePoint;units=units||1/0;for(var length=string.length,leadSurrogate=null,bytes=[],i=0;i<length;i++){if((codePoint=string.charCodeAt(i))>55295&&codePoint<57344){if(!leadSurrogate){if(codePoint>56319){(units-=3)>-1&&bytes.push(239,191,189);continue}if(i+1===length){(units-=3)>-1&&bytes.push(239,191,189);continue}leadSurrogate=codePoint;continue}if(codePoint<56320){(units-=3)>-1&&bytes.push(239,191,189),leadSurrogate=codePoint;continue}codePoint=65536+(leadSurrogate-55296<<10|codePoint-56320)}else leadSurrogate&&(units-=3)>-1&&bytes.push(239,191,189);if(leadSurrogate=null,codePoint<128){if((units-=1)<0)break;bytes.push(codePoint)}else if(codePoint<2048){if((units-=2)<0)break;bytes.push(codePoint>>6|192,63&codePoint|128)}else if(codePoint<65536){if((units-=3)<0)break;bytes.push(codePoint>>12|224,codePoint>>6&63|128,63&codePoint|128)}else{if(!(codePoint<1114112))throw new Error("Invalid code point");if((units-=4)<0)break;bytes.push(codePoint>>18|240,codePoint>>12&63|128,codePoint>>6&63|128,63&codePoint|128)}}return bytes}function asciiToBytes(str){for(var byteArray=[],i=0;i<str.length;i++)byteArray.push(255&str.charCodeAt(i));return byteArray}function utf16leToBytes(str,units){for(var c,hi,lo,byteArray=[],i=0;i<str.length&&!((units-=2)<0);i++)hi=(c=str.charCodeAt(i))>>8,lo=c%256,byteArray.push(lo),byteArray.push(hi);return byteArray}function base64ToBytes(str){return base64.toByteArray(base64clean(str))}function blitBuffer(src,dst,offset,length){for(var i=0;i<length&&!(i+offset>=dst.length||i>=src.length);i++)dst[i+offset]=src[i];return i}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"base64-js":1,ieee754:5,isarray:4}],4:[function(require,module,exports){var toString={}.toString;module.exports=Array.isArray||function(arr){return"[object Array]"==toString.call(arr)}},{}],5:[function(require,module,exports){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
exports.read=function(buffer,offset,isLE,mLen,nBytes){var e,m,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,nBits=-7,i=isLE?nBytes-1:0,d=isLE?-1:1,s=buffer[offset+i];for(i+=d,e=s&(1<<-nBits)-1,s>>=-nBits,nBits+=eLen;nBits>0;e=256*e+buffer[offset+i],i+=d,nBits-=8);for(m=e&(1<<-nBits)-1,e>>=-nBits,nBits+=mLen;nBits>0;m=256*m+buffer[offset+i],i+=d,nBits-=8);if(0===e)e=1-eBias;else{if(e===eMax)return m?NaN:1/0*(s?-1:1);m+=Math.pow(2,mLen),e-=eBias}return(s?-1:1)*m*Math.pow(2,e-mLen)},exports.write=function(buffer,value,offset,isLE,mLen,nBytes){var e,m,c,eLen=8*nBytes-mLen-1,eMax=(1<<eLen)-1,eBias=eMax>>1,rt=23===mLen?Math.pow(2,-24)-Math.pow(2,-77):0,i=isLE?0:nBytes-1,d=isLE?1:-1,s=value<0||0===value&&1/value<0?1:0;for(value=Math.abs(value),isNaN(value)||value===1/0?(m=isNaN(value)?1:0,e=eMax):(e=Math.floor(Math.log(value)/Math.LN2),value*(c=Math.pow(2,-e))<1&&(e--,c*=2),(value+=e+eBias>=1?rt/c:rt*Math.pow(2,1-eBias))*c>=2&&(e++,c/=2),e+eBias>=eMax?(m=0,e=eMax):e+eBias>=1?(m=(value*c-1)*Math.pow(2,mLen),e+=eBias):(m=value*Math.pow(2,eBias-1)*Math.pow(2,mLen),e=0));mLen>=8;buffer[offset+i]=255&m,i+=d,m/=256,mLen-=8);for(e=e<<mLen|m,eLen+=mLen;eLen>0;buffer[offset+i]=255&e,i+=d,e/=256,eLen-=8);buffer[offset+i-d]|=128*s}},{}],6:[function(require,module,exports){var Pipe=require("../pipe").Pipe,Context=function(){};Context.prototype.setResult=function(result){return this.result=result,this.hasResult=!0,this},Context.prototype.exit=function(){return this.exiting=!0,this},Context.prototype.switchTo=function(next,pipe){return"string"==typeof next||next instanceof Pipe?this.nextPipe=next:(this.next=next,pipe&&(this.nextPipe=pipe)),this},Context.prototype.push=function(child,name){return child.parent=this,void 0!==name&&(child.childName=name),child.root=this.root||this,child.options=child.options||this.options,this.children?(this.children[this.children.length-1].next=child,this.children.push(child)):(this.children=[child],this.nextAfterChildren=this.next||null,this.next=child),child.next=this,this},exports.Context=Context},{"../pipe":20}],7:[function(require,module,exports){var Context=require("./context").Context,dateReviver=require("../date-reviver"),DiffContext=function(left,right){this.left=left,this.right=right,this.pipe="diff"};DiffContext.prototype=new Context,DiffContext.prototype.setResult=function(result){if(this.options.cloneDiffValues){var clone="function"==typeof this.options.cloneDiffValues?this.options.cloneDiffValues:function(value){return JSON.parse(JSON.stringify(value),dateReviver)};"object"==typeof result[0]&&(result[0]=clone(result[0])),"object"==typeof result[1]&&(result[1]=clone(result[1]))}return Context.prototype.setResult.apply(this,arguments)},exports.DiffContext=DiffContext},{"../date-reviver":10,"./context":6}],8:[function(require,module,exports){var Context=require("./context").Context,PatchContext=function(left,delta){this.left=left,this.delta=delta,this.pipe="patch"};PatchContext.prototype=new Context,exports.PatchContext=PatchContext},{"./context":6}],9:[function(require,module,exports){var Context=require("./context").Context,ReverseContext=function(delta){this.delta=delta,this.pipe="reverse"};ReverseContext.prototype=new Context,exports.ReverseContext=ReverseContext},{"./context":6}],10:[function(require,module,exports){module.exports=function(key,value){var parts;return"string"==typeof value&&(parts=/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d*))?(Z|([+\-])(\d{2}):(\d{2}))$/.exec(value))?new Date(Date.UTC(+parts[1],+parts[2]-1,+parts[3],+parts[4],+parts[5],+parts[6],+(parts[7]||0))):value}},{}],11:[function(require,module,exports){var Processor=require("./processor").Processor,Pipe=require("./pipe").Pipe,DiffContext=require("./contexts/diff").DiffContext,PatchContext=require("./contexts/patch").PatchContext,ReverseContext=require("./contexts/reverse").ReverseContext,trivial=require("./filters/trivial"),nested=require("./filters/nested"),arrays=require("./filters/arrays"),dates=require("./filters/dates"),texts=require("./filters/texts"),DiffPatcher=function(options){this.processor=new Processor(options),this.processor.pipe(new Pipe("diff").append(nested.collectChildrenDiffFilter,trivial.diffFilter,dates.diffFilter,texts.diffFilter,nested.objectsDiffFilter,arrays.diffFilter).shouldHaveResult()),this.processor.pipe(new Pipe("patch").append(nested.collectChildrenPatchFilter,arrays.collectChildrenPatchFilter,trivial.patchFilter,texts.patchFilter,nested.patchFilter,arrays.patchFilter).shouldHaveResult()),this.processor.pipe(new Pipe("reverse").append(nested.collectChildrenReverseFilter,arrays.collectChildrenReverseFilter,trivial.reverseFilter,texts.reverseFilter,nested.reverseFilter,arrays.reverseFilter).shouldHaveResult())};DiffPatcher.prototype.options=function(){return this.processor.options.apply(this.processor,arguments)},DiffPatcher.prototype.diff=function(left,right){return this.processor.process(new DiffContext(left,right))},DiffPatcher.prototype.patch=function(left,delta){return this.processor.process(new PatchContext(left,delta))},DiffPatcher.prototype.reverse=function(delta){return this.processor.process(new ReverseContext(delta))},DiffPatcher.prototype.unpatch=function(right,delta){return this.patch(right,this.reverse(delta))},exports.DiffPatcher=DiffPatcher},{"./contexts/diff":7,"./contexts/patch":8,"./contexts/reverse":9,"./filters/arrays":13,"./filters/dates":14,"./filters/nested":16,"./filters/texts":17,"./filters/trivial":18,"./pipe":20,"./processor":21}],12:[function(require,module,exports){exports.isBrowser="undefined"!=typeof window},{}],13:[function(require,module,exports){var DiffContext=require("../contexts/diff").DiffContext,PatchContext=require("../contexts/patch").PatchContext,ReverseContext=require("../contexts/reverse").ReverseContext,lcs=require("./lcs"),ARRAY_MOVE=3,isArray="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},arrayIndexOf="function"==typeof Array.prototype.indexOf?function(array,item){return array.indexOf(item)}:function(array,item){for(var length=array.length,i=0;i<length;i++)if(array[i]===item)return i;return-1};function arraysHaveMatchByRef(array1,array2,len1,len2){for(var index1=0;index1<len1;index1++)for(var val1=array1[index1],index2=0;index2<len2;index2++){if(val1===array2[index2])return!0}}function matchItems(array1,array2,index1,index2,context){var value1=array1[index1],value2=array2[index2];if(value1===value2)return!0;if("object"!=typeof value1||"object"!=typeof value2)return!1;var hash1,hash2,objectHash=context.objectHash;return objectHash?("number"==typeof index1?(context.hashCache1=context.hashCache1||[],void 0===(hash1=context.hashCache1[index1])&&(context.hashCache1[index1]=hash1=objectHash(value1,index1))):hash1=objectHash(value1),void 0!==hash1&&("number"==typeof index2?(context.hashCache2=context.hashCache2||[],void 0===(hash2=context.hashCache2[index2])&&(context.hashCache2[index2]=hash2=objectHash(value2,index2))):hash2=objectHash(value2),void 0!==hash2&&hash1===hash2)):context.matchByPosition&&index1===index2}var diffFilter=function(context){if(context.leftIsArray){var index,index1,index2,child,result,matchContext={objectHash:context.options&&context.options.objectHash,matchByPosition:context.options&&context.options.matchByPosition},commonHead=0,commonTail=0,array1=context.left,array2=context.right,len1=array1.length,len2=array2.length;for(len1>0&&len2>0&&!matchContext.objectHash&&"boolean"!=typeof matchContext.matchByPosition&&(matchContext.matchByPosition=!arraysHaveMatchByRef(array1,array2,len1,len2));commonHead<len1&&commonHead<len2&&matchItems(array1,array2,commonHead,commonHead,matchContext);)index=commonHead,child=new DiffContext(context.left[index],context.right[index]),context.push(child,index),commonHead++;for(;commonTail+commonHead<len1&&commonTail+commonHead<len2&&matchItems(array1,array2,len1-1-commonTail,len2-1-commonTail,matchContext);)index1=len1-1-commonTail,index2=len2-1-commonTail,child=new DiffContext(context.left[index1],context.right[index2]),context.push(child,index2),commonTail++;if(commonHead+commonTail!==len1)if(commonHead+commonTail!==len2){delete matchContext.hashCache1,delete matchContext.hashCache2;var trimmed1=array1.slice(commonHead,len1-commonTail),trimmed2=array2.slice(commonHead,len2-commonTail),seq=lcs.get(trimmed1,trimmed2,matchItems,matchContext),removedItems=[];for(result=result||{_t:"a"},index=commonHead;index<len1-commonTail;index++)arrayIndexOf(seq.indices1,index-commonHead)<0&&(result["_"+index]=[array1[index],0,0],removedItems.push(index));var detectMove=!0;context.options&&context.options.arrays&&!1===context.options.arrays.detectMove&&(detectMove=!1);var includeValueOnMove=!1;context.options&&context.options.arrays&&context.options.arrays.includeValueOnMove&&(includeValueOnMove=!0);var removedItemsLength=removedItems.length;for(index=commonHead;index<len2-commonTail;index++){var indexOnArray2=arrayIndexOf(seq.indices2,index-commonHead);if(indexOnArray2<0){var isMove=!1;if(detectMove&&removedItemsLength>0)for(var removeItemIndex1=0;removeItemIndex1<removedItemsLength;removeItemIndex1++)if(matchItems(trimmed1,trimmed2,(index1=removedItems[removeItemIndex1])-commonHead,index-commonHead,matchContext)){result["_"+index1].splice(1,2,index,ARRAY_MOVE),includeValueOnMove||(result["_"+index1][0]=""),index2=index,child=new DiffContext(context.left[index1],context.right[index2]),context.push(child,index2),removedItems.splice(removeItemIndex1,1),isMove=!0;break}isMove||(result[index]=[array2[index]])}else index1=seq.indices1[indexOnArray2]+commonHead,index2=seq.indices2[indexOnArray2]+commonHead,child=new DiffContext(context.left[index1],context.right[index2]),context.push(child,index2)}context.setResult(result).exit()}else{for(result=result||{_t:"a"},index=commonHead;index<len1-commonTail;index++)result["_"+index]=[array1[index],0,0];context.setResult(result).exit()}else{if(len1===len2)return void context.setResult(void 0).exit();for(result=result||{_t:"a"},index=commonHead;index<len2-commonTail;index++)result[index]=[array2[index]];context.setResult(result).exit()}}};diffFilter.filterName="arrays";var compare={numerically:function(a,b){return a-b},numericallyBy:function(name){return function(a,b){return a[name]-b[name]}}},patchFilter=function(context){if(context.nested&&"a"===context.delta._t){var index,index1,delta=context.delta,array=context.left,toRemove=[],toInsert=[],toModify=[];for(index in delta)if("_t"!==index)if("_"===index[0]){if(0!==delta[index][2]&&delta[index][2]!==ARRAY_MOVE)throw new Error("only removal or move can be applied at original array indices, invalid diff type: "+delta[index][2]);toRemove.push(parseInt(index.slice(1),10))}else 1===delta[index].length?toInsert.push({index:parseInt(index,10),value:delta[index][0]}):toModify.push({index:parseInt(index,10),delta:delta[index]});for(index=(toRemove=toRemove.sort(compare.numerically)).length-1;index>=0;index--){var indexDiff=delta["_"+(index1=toRemove[index])],removedValue=array.splice(index1,1)[0];indexDiff[2]===ARRAY_MOVE&&toInsert.push({index:indexDiff[1],value:removedValue})}var toInsertLength=(toInsert=toInsert.sort(compare.numericallyBy("index"))).length;for(index=0;index<toInsertLength;index++){var insertion=toInsert[index];array.splice(insertion.index,0,insertion.value)}var child,toModifyLength=toModify.length;if(toModifyLength>0)for(index=0;index<toModifyLength;index++){var modification=toModify[index];child=new PatchContext(context.left[modification.index],modification.delta),context.push(child,modification.index)}context.children?context.exit():context.setResult(context.left).exit()}};patchFilter.filterName="arrays";var collectChildrenPatchFilter=function(context){if(context&&context.children&&"a"===context.delta._t){for(var child,length=context.children.length,index=0;index<length;index++)child=context.children[index],context.left[child.childName]=child.result;context.setResult(context.left).exit()}};collectChildrenPatchFilter.filterName="arraysCollectChildren";var reverseFilter=function(context){if(context.nested){if("a"===context.delta._t){var name,child;for(name in context.delta)"_t"!==name&&(child=new ReverseContext(context.delta[name]),context.push(child,name));context.exit()}}else context.delta[2]===ARRAY_MOVE&&(context.newName="_"+context.delta[1],context.setResult([context.delta[0],parseInt(context.childName.substr(1),10),ARRAY_MOVE]).exit())};reverseFilter.filterName="arrays";var reverseArrayDeltaIndex=function(delta,index,itemDelta){if("string"==typeof index&&"_"===index[0])return parseInt(index.substr(1),10);if(isArray(itemDelta)&&0===itemDelta[2])return"_"+index;var reverseIndex=+index;for(var deltaIndex in delta){var deltaItem=delta[deltaIndex];if(isArray(deltaItem))if(deltaItem[2]===ARRAY_MOVE){var moveFromIndex=parseInt(deltaIndex.substr(1),10),moveToIndex=deltaItem[1];if(moveToIndex===+index)return moveFromIndex;moveFromIndex<=reverseIndex&&moveToIndex>reverseIndex?reverseIndex++:moveFromIndex>=reverseIndex&&moveToIndex<reverseIndex&&reverseIndex--}else if(0===deltaItem[2]){parseInt(deltaIndex.substr(1),10)<=reverseIndex&&reverseIndex++}else 1===deltaItem.length&&deltaIndex<=reverseIndex&&reverseIndex--}return reverseIndex},collectChildrenReverseFilter=function(context){if(context&&context.children&&"a"===context.delta._t){for(var child,length=context.children.length,delta={_t:"a"},index=0;index<length;index++){var name=(child=context.children[index]).newName;void 0===name&&(name=reverseArrayDeltaIndex(context.delta,child.childName,child.result)),delta[name]!==child.result&&(delta[name]=child.result)}context.setResult(delta).exit()}};collectChildrenReverseFilter.filterName="arraysCollectChildren",exports.diffFilter=diffFilter,exports.patchFilter=patchFilter,exports.collectChildrenPatchFilter=collectChildrenPatchFilter,exports.reverseFilter=reverseFilter,exports.collectChildrenReverseFilter=collectChildrenReverseFilter},{"../contexts/diff":7,"../contexts/patch":8,"../contexts/reverse":9,"./lcs":15}],14:[function(require,module,exports){var diffFilter=function(context){context.left instanceof Date?(context.right instanceof Date?context.left.getTime()!==context.right.getTime()?context.setResult([context.left,context.right]):context.setResult(void 0):context.setResult([context.left,context.right]),context.exit()):context.right instanceof Date&&context.setResult([context.left,context.right]).exit()};diffFilter.filterName="dates",exports.diffFilter=diffFilter},{}],15:[function(require,module,exports){var defaultMatch=function(array1,array2,index1,index2){return array1[index1]===array2[index2]},lengthMatrix=function(array1,array2,match,context){var x,y,len1=array1.length,len2=array2.length,matrix=[len1+1];for(x=0;x<len1+1;x++)for(matrix[x]=[len2+1],y=0;y<len2+1;y++)matrix[x][y]=0;for(matrix.match=match,x=1;x<len1+1;x++)for(y=1;y<len2+1;y++)match(array1,array2,x-1,y-1,context)?matrix[x][y]=matrix[x-1][y-1]+1:matrix[x][y]=Math.max(matrix[x-1][y],matrix[x][y-1]);return matrix},backtrack=function(matrix,array1,array2,index1,index2,context){if(0===index1||0===index2)return{sequence:[],indices1:[],indices2:[]};if(matrix.match(array1,array2,index1-1,index2-1,context)){var subsequence=backtrack(matrix,array1,array2,index1-1,index2-1,context);return subsequence.sequence.push(array1[index1-1]),subsequence.indices1.push(index1-1),subsequence.indices2.push(index2-1),subsequence}return matrix[index1][index2-1]>matrix[index1-1][index2]?backtrack(matrix,array1,array2,index1,index2-1,context):backtrack(matrix,array1,array2,index1-1,index2,context)},get=function(array1,array2,match,context){var matrix=lengthMatrix(array1,array2,match||defaultMatch,context=context||{}),result=backtrack(matrix,array1,array2,array1.length,array2.length,context);return"string"==typeof array1&&"string"==typeof array2&&(result.sequence=result.sequence.join("")),result};exports.get=get},{}],16:[function(require,module,exports){var DiffContext=require("../contexts/diff").DiffContext,PatchContext=require("../contexts/patch").PatchContext,ReverseContext=require("../contexts/reverse").ReverseContext,collectChildrenDiffFilter=function(context){if(context&&context.children){for(var child,length=context.children.length,result=context.result,index=0;index<length;index++)void 0!==(child=context.children[index]).result&&((result=result||{})[child.childName]=child.result);result&&context.leftIsArray&&(result._t="a"),context.setResult(result).exit()}};collectChildrenDiffFilter.filterName="collectChildren";var objectsDiffFilter=function(context){if(!context.leftIsArray&&"object"===context.leftType){var name,child,propertyFilter=context.options.propertyFilter;for(name in context.left)Object.prototype.hasOwnProperty.call(context.left,name)&&(propertyFilter&&!propertyFilter(name,context)||(child=new DiffContext(context.left[name],context.right[name]),context.push(child,name)));for(name in context.right)Object.prototype.hasOwnProperty.call(context.right,name)&&(propertyFilter&&!propertyFilter(name,context)||void 0===context.left[name]&&(child=new DiffContext(void 0,context.right[name]),context.push(child,name)));context.children&&0!==context.children.length?context.exit():context.setResult(void 0).exit()}};objectsDiffFilter.filterName="objects";var patchFilter=function(context){if(context.nested&&!context.delta._t){var name,child;for(name in context.delta)child=new PatchContext(context.left[name],context.delta[name]),context.push(child,name);context.exit()}};patchFilter.filterName="objects";var collectChildrenPatchFilter=function(context){if(context&&context.children&&!context.delta._t){for(var child,length=context.children.length,index=0;index<length;index++)child=context.children[index],Object.prototype.hasOwnProperty.call(context.left,child.childName)&&void 0===child.result?delete context.left[child.childName]:context.left[child.childName]!==child.result&&(context.left[child.childName]=child.result);context.setResult(context.left).exit()}};collectChildrenPatchFilter.filterName="collectChildren";var reverseFilter=function(context){if(context.nested&&!context.delta._t){var name,child;for(name in context.delta)child=new ReverseContext(context.delta[name]),context.push(child,name);context.exit()}};reverseFilter.filterName="objects";var collectChildrenReverseFilter=function(context){if(context&&context.children&&!context.delta._t){for(var child,length=context.children.length,delta={},index=0;index<length;index++)delta[(child=context.children[index]).childName]!==child.result&&(delta[child.childName]=child.result);context.setResult(delta).exit()}};collectChildrenReverseFilter.filterName="collectChildren",exports.collectChildrenDiffFilter=collectChildrenDiffFilter,exports.objectsDiffFilter=objectsDiffFilter,exports.patchFilter=patchFilter,exports.collectChildrenPatchFilter=collectChildrenPatchFilter,exports.reverseFilter=reverseFilter,exports.collectChildrenReverseFilter=collectChildrenReverseFilter},{"../contexts/diff":7,"../contexts/patch":8,"../contexts/reverse":9}],17:[function(require,module,exports){var TEXT_DIFF=2,DEFAULT_MIN_LENGTH=60,cachedDiffPatch=null,getDiffMatchPatch=function(required){if(!cachedDiffPatch){var instance;if("undefined"!=typeof diff_match_patch)instance="function"==typeof diff_match_patch?new diff_match_patch:new diff_match_patch.diff_match_patch;else if("function"==typeof require)try{var dmp=require("../../public/external/"+"diff_match_patch_uncompressed");instance=new dmp.diff_match_patch}catch(err){instance=null}if(!instance){if(!required)return null;var error=new Error("text diff_match_patch library not found");throw error.diff_match_patch_not_found=!0,error}cachedDiffPatch={diff:function(txt1,txt2){return instance.patch_toText(instance.patch_make(txt1,txt2))},patch:function(txt1,patch){for(var results=instance.patch_apply(instance.patch_fromText(patch),txt1),i=0;i<results[1].length;i++){if(!results[1][i])new Error("text patch failed").textPatchFailed=!0}return results[0]}}}return cachedDiffPatch},diffFilter=function(context){if("string"===context.leftType){var minLength=context.options&&context.options.textDiff&&context.options.textDiff.minLength||DEFAULT_MIN_LENGTH;if(context.left.length<minLength||context.right.length<minLength)context.setResult([context.left,context.right]).exit();else{var diffMatchPatch=getDiffMatchPatch();if(diffMatchPatch){var diff=diffMatchPatch.diff;context.setResult([diff(context.left,context.right),0,TEXT_DIFF]).exit()}else context.setResult([context.left,context.right]).exit()}}};diffFilter.filterName="texts";var patchFilter=function(context){if(!context.nested&&context.delta[2]===TEXT_DIFF){var patch=getDiffMatchPatch(!0).patch;context.setResult(patch(context.left,context.delta[0])).exit()}};patchFilter.filterName="texts";var textDeltaReverse=function(delta){var i,l,lines,line,lineTmp,header=null,headerRegex=/^@@ +\-(\d+),(\d+) +\+(\d+),(\d+) +@@$/;for(i=0,l=(lines=delta.split("\n")).length;i<l;i++){var lineStart=(line=lines[i]).slice(0,1);"@"===lineStart?(header=headerRegex.exec(line),null,null,lines[i]="@@ -"+header[3]+","+header[4]+" +"+header[1]+","+header[2]+" @@"):"+"===lineStart?(i,lines[i]="-"+lines[i].slice(1),"+"===lines[i-1].slice(0,1)&&(lineTmp=lines[i],lines[i]=lines[i-1],lines[i-1]=lineTmp)):"-"===lineStart&&(i,lines[i]="+"+lines[i].slice(1))}return lines.join("\n")},reverseFilter=function(context){context.nested||context.delta[2]===TEXT_DIFF&&context.setResult([textDeltaReverse(context.delta[0]),0,TEXT_DIFF]).exit()};reverseFilter.filterName="texts",exports.diffFilter=diffFilter,exports.patchFilter=patchFilter,exports.reverseFilter=reverseFilter},{}],18:[function(require,module,exports){var isArray="function"==typeof Array.isArray?Array.isArray:function(a){return a instanceof Array},diffFilter=function(context){if(context.left!==context.right)if(void 0!==context.left)if(void 0!==context.right){if("function"==typeof context.left||"function"==typeof context.right)throw new Error("functions are not supported");context.leftType=null===context.left?"null":typeof context.left,context.rightType=null===context.right?"null":typeof context.right,context.leftType===context.rightType&&"boolean"!==context.leftType&&"number"!==context.leftType?("object"===context.leftType&&(context.leftIsArray=isArray(context.left)),"object"===context.rightType&&(context.rightIsArray=isArray(context.right)),context.leftIsArray===context.rightIsArray||context.setResult([context.left,context.right]).exit()):context.setResult([context.left,context.right]).exit()}else context.setResult([context.left,0,0]).exit();else{if("function"==typeof context.right)throw new Error("functions are not supported");context.setResult([context.right]).exit()}else context.setResult(void 0).exit()};diffFilter.filterName="trivial";var patchFilter=function(context){void 0!==context.delta?(context.nested=!isArray(context.delta),context.nested||(1!==context.delta.length?2!==context.delta.length?3!==context.delta.length||0!==context.delta[2]||context.setResult(void 0).exit():context.setResult(context.delta[1]).exit():context.setResult(context.delta[0]).exit())):context.setResult(context.left).exit()};patchFilter.filterName="trivial";var reverseFilter=function(context){void 0!==context.delta?(context.nested=!isArray(context.delta),context.nested||(1!==context.delta.length?2!==context.delta.length?3!==context.delta.length||0!==context.delta[2]||context.setResult([context.delta[0]]).exit():context.setResult([context.delta[1],context.delta[0]]).exit():context.setResult([context.delta[0],0,0]).exit())):context.setResult(context.delta).exit()};reverseFilter.filterName="trivial",exports.diffFilter=diffFilter,exports.patchFilter=patchFilter,exports.reverseFilter=reverseFilter},{}],19:[function(require,module,exports){var defaultInstance,environment=require("./environment"),DiffPatcher=require("./diffpatcher").DiffPatcher;if(exports.DiffPatcher=DiffPatcher,exports.create=function(options){return new DiffPatcher(options)},exports.dateReviver=require("./date-reviver"),exports.diff=function(){return defaultInstance||(defaultInstance=new DiffPatcher),defaultInstance.diff.apply(defaultInstance,arguments)},exports.patch=function(){return defaultInstance||(defaultInstance=new DiffPatcher),defaultInstance.patch.apply(defaultInstance,arguments)},exports.unpatch=function(){return defaultInstance||(defaultInstance=new DiffPatcher),defaultInstance.unpatch.apply(defaultInstance,arguments)},exports.reverse=function(){return defaultInstance||(defaultInstance=new DiffPatcher),defaultInstance.reverse.apply(defaultInstance,arguments)},environment.isBrowser)exports.homepage="{{package-homepage}}",exports.version="{{package-version}}";else{var packageInfo=require("../package.json");exports.homepage=packageInfo.homepage,exports.version=packageInfo.version;var formatters=require("./formatters");exports.formatters=formatters,exports.console=formatters.console}},{"./date-reviver":10,"./diffpatcher":11,"./environment":12}],20:[function(require,module,exports){var Pipe=function(name){this.name=name,this.filters=[]};Pipe.prototype.process=function(input){if(!this.processor)throw new Error("add this pipe to a processor before using it");for(var debug=this.debug,length=this.filters.length,context=input,index=0;index<length;index++){var filter=this.filters[index];if(debug&&this.log("filter: "+filter.filterName),filter(context),"object"==typeof context&&context.exiting){context.exiting=!1;break}}!context.next&&this.resultCheck&&this.resultCheck(context)},Pipe.prototype.log=function(msg){console.log("[jsondiffpatch] "+this.name+" pipe, "+msg)},Pipe.prototype.append=function(){return this.filters.push.apply(this.filters,arguments),this},Pipe.prototype.prepend=function(){return this.filters.unshift.apply(this.filters,arguments),this},Pipe.prototype.indexOf=function(filterName){if(!filterName)throw new Error("a filter name is required");for(var index=0;index<this.filters.length;index++){if(this.filters[index].filterName===filterName)return index}throw new Error("filter not found: "+filterName)},Pipe.prototype.list=function(){for(var names=[],index=0;index<this.filters.length;index++){var filter=this.filters[index];names.push(filter.filterName)}return names},Pipe.prototype.after=function(filterName){var index=this.indexOf(filterName),params=Array.prototype.slice.call(arguments,1);if(!params.length)throw new Error("a filter is required");return params.unshift(index+1,0),Array.prototype.splice.apply(this.filters,params),this},Pipe.prototype.before=function(filterName){var index=this.indexOf(filterName),params=Array.prototype.slice.call(arguments,1);if(!params.length)throw new Error("a filter is required");return params.unshift(index,0),Array.prototype.splice.apply(this.filters,params),this},Pipe.prototype.clear=function(){return this.filters.length=0,this},Pipe.prototype.shouldHaveResult=function(should){if(!1!==should){if(!this.resultCheck){var pipe=this;return this.resultCheck=function(context){if(!context.hasResult){console.log(context);var error=new Error(pipe.name+" failed");throw error.noResult=!0,error}},this}}else this.resultCheck=null},exports.Pipe=Pipe},{}],21:[function(require,module,exports){var Processor=function(options){this.selfOptions=options||{},this.pipes={}};Processor.prototype.options=function(options){return options&&(this.selfOptions=options),this.selfOptions},Processor.prototype.pipe=function(name,pipe){if("string"==typeof name){if(void 0===pipe)return this.pipes[name];this.pipes[name]=pipe}if(name&&name.name){if((pipe=name).processor===this)return pipe;this.pipes[pipe.name]=pipe}return pipe.processor=this,pipe},Processor.prototype.process=function(input,pipe){var context=input;context.options=this.options();for(var lastPipe,lastContext,nextPipe=pipe||input.pipe||"default";nextPipe;)void 0!==context.nextAfterChildren&&(context.next=context.nextAfterChildren,context.nextAfterChildren=null),"string"==typeof nextPipe&&(nextPipe=this.pipe(nextPipe)),nextPipe.process(context),lastContext=context,lastPipe=nextPipe,nextPipe=null,context&&context.next&&(context=context.next,nextPipe=lastContext.nextPipe||context.pipe||lastPipe);return context.hasResult?context.result:void 0},exports.Processor=Processor},{}],22:[function(require,module,exports){exports.RateLimiter=require("./lib/rateLimiter"),exports.TokenBucket=require("./lib/tokenBucket")},{"./lib/rateLimiter":24,"./lib/tokenBucket":25}],23:[function(require,module,exports){(function(process){var getMilliseconds=function(){if(void 0!==process&&process.hrtime){var hrtime=process.hrtime(),seconds=hrtime[0],nanoseconds=hrtime[1];return 1e3*seconds+Math.floor(nanoseconds/1e6)}return(new Date).getTime()};module.exports=getMilliseconds}).call(this,require("_process"))},{_process:26}],24:[function(require,module,exports){(function(process){var TokenBucket=require("./tokenBucket"),getMilliseconds=require("./clock"),RateLimiter=function(tokensPerInterval,interval,fireImmediately){this.tokenBucket=new TokenBucket(tokensPerInterval,tokensPerInterval,interval,null),this.tokenBucket.content=tokensPerInterval,this.curIntervalStart=getMilliseconds(),this.tokensThisInterval=0,this.fireImmediately=fireImmediately};RateLimiter.prototype={tokenBucket:null,curIntervalStart:0,tokensThisInterval:0,fireImmediately:!1,removeTokens:function(count,callback){if(count>this.tokenBucket.bucketSize)return process.nextTick(callback.bind(null,"Requested tokens "+count+" exceeds maximum tokens per interval "+this.tokenBucket.bucketSize,null)),!1;var self=this,now=getMilliseconds();if((now<this.curIntervalStart||now-this.curIntervalStart>=this.tokenBucket.interval)&&(this.curIntervalStart=now,this.tokensThisInterval=0),count>this.tokenBucket.tokensPerInterval-this.tokensThisInterval){if(this.fireImmediately)process.nextTick(callback.bind(null,null,-1));else{var waitInterval=Math.ceil(this.curIntervalStart+this.tokenBucket.interval-now);setTimeout((function(){self.tokenBucket.removeTokens(count,afterTokensRemoved)}),waitInterval)}return!1}return this.tokenBucket.removeTokens(count,afterTokensRemoved);function afterTokensRemoved(err,tokensRemaining){if(err)return callback(err,null);self.tokensThisInterval+=count,callback(null,tokensRemaining)}},tryRemoveTokens:function(count){if(count>this.tokenBucket.bucketSize)return!1;var now=getMilliseconds();if((now<this.curIntervalStart||now-this.curIntervalStart>=this.tokenBucket.interval)&&(this.curIntervalStart=now,this.tokensThisInterval=0),count>this.tokenBucket.tokensPerInterval-this.tokensThisInterval)return!1;var removed=this.tokenBucket.tryRemoveTokens(count);return removed&&(this.tokensThisInterval+=count),removed},getTokensRemaining:function(){return this.tokenBucket.drip(),this.tokenBucket.content}},module.exports=RateLimiter}).call(this,require("_process"))},{"./clock":23,"./tokenBucket":25,_process:26}],25:[function(require,module,exports){(function(process){var TokenBucket=function(bucketSize,tokensPerInterval,interval,parentBucket){if(this.bucketSize=bucketSize,this.tokensPerInterval=tokensPerInterval,"string"==typeof interval)switch(interval){case"sec":case"second":this.interval=1e3;break;case"min":case"minute":this.interval=6e4;break;case"hr":case"hour":this.interval=36e5;break;case"day":this.interval=864e5;break;default:throw new Error("Invaid interval "+interval)}else this.interval=interval;this.parentBucket=parentBucket,this.content=0,this.lastDrip=+new Date};TokenBucket.prototype={bucketSize:1,tokensPerInterval:1,interval:1e3,parentBucket:null,content:0,lastDrip:0,removeTokens:function(count,callback){var self=this;return this.bucketSize?count>this.bucketSize?(process.nextTick(callback.bind(null,"Requested tokens "+count+" exceeds bucket size "+this.bucketSize,null)),!1):(this.drip(),count>this.content?comeBackLater():this.parentBucket?this.parentBucket.removeTokens(count,(function(err,remainingTokens){return err?callback(err,null):count>self.content?comeBackLater():(self.content-=count,void callback(null,Math.min(remainingTokens,self.content)))})):(this.content-=count,process.nextTick(callback.bind(null,null,this.content)),!0)):(process.nextTick(callback.bind(null,null,count,Number.POSITIVE_INFINITY)),!0);function comeBackLater(){var waitInterval=Math.ceil((count-self.content)*(self.interval/self.tokensPerInterval));return setTimeout((function(){self.removeTokens(count,callback)}),waitInterval),!1}},tryRemoveTokens:function(count){return!this.bucketSize||!(count>this.bucketSize)&&(this.drip(),!(count>this.content)&&(!(this.parentBucket&&!this.parentBucket.tryRemoveTokens(count))&&(this.content-=count,!0)))},drip:function(){if(this.tokensPerInterval){var now=+new Date,deltaMS=Math.max(now-this.lastDrip,0);this.lastDrip=now;var dripAmount=deltaMS*(this.tokensPerInterval/this.interval);this.content=Math.min(this.content+dripAmount,this.bucketSize)}else this.content=this.bucketSize}},module.exports=TokenBucket}).call(this,require("_process"))},{_process:26}],26:[function(require,module,exports){var cachedSetTimeout,cachedClearTimeout,process=module.exports={};function defaultSetTimout(){throw new Error("setTimeout has not been defined")}function defaultClearTimeout(){throw new Error("clearTimeout has not been defined")}function runTimeout(fun){if(cachedSetTimeout===setTimeout)return setTimeout(fun,0);if((cachedSetTimeout===defaultSetTimout||!cachedSetTimeout)&&setTimeout)return cachedSetTimeout=setTimeout,setTimeout(fun,0);try{return cachedSetTimeout(fun,0)}catch(e){try{return cachedSetTimeout.call(null,fun,0)}catch(e){return cachedSetTimeout.call(this,fun,0)}}}function runClearTimeout(marker){if(cachedClearTimeout===clearTimeout)return clearTimeout(marker);if((cachedClearTimeout===defaultClearTimeout||!cachedClearTimeout)&&clearTimeout)return cachedClearTimeout=clearTimeout,clearTimeout(marker);try{return cachedClearTimeout(marker)}catch(e){try{return cachedClearTimeout.call(null,marker)}catch(e){return cachedClearTimeout.call(this,marker)}}}!function(){try{cachedSetTimeout="function"==typeof setTimeout?setTimeout:defaultSetTimout}catch(e){cachedSetTimeout=defaultSetTimout}try{cachedClearTimeout="function"==typeof clearTimeout?clearTimeout:defaultClearTimeout}catch(e){cachedClearTimeout=defaultClearTimeout}}();var currentQueue,queue=[],draining=!1,queueIndex=-1;function cleanUpNextTick(){draining&&currentQueue&&(draining=!1,currentQueue.length?queue=currentQueue.concat(queue):queueIndex=-1,queue.length&&drainQueue())}function drainQueue(){if(!draining){var timeout=runTimeout(cleanUpNextTick);draining=!0;for(var len=queue.length;len;){for(currentQueue=queue,queue=[];++queueIndex<len;)currentQueue&&currentQueue[queueIndex].run();queueIndex=-1,len=queue.length}currentQueue=null,draining=!1,runClearTimeout(timeout)}}function Item(fun,array){this.fun=fun,this.array=array}function noop(){}process.nextTick=function(fun){var args=new Array(arguments.length-1);if(arguments.length>1)for(var i=1;i<arguments.length;i++)args[i-1]=arguments[i];queue.push(new Item(fun,args)),1!==queue.length||draining||runTimeout(drainQueue)},Item.prototype.run=function(){this.fun.apply(null,this.array)},process.title="browser",process.browser=!0,process.env={},process.argv=[],process.version="",process.versions={},process.on=noop,process.addListener=noop,process.once=noop,process.off=noop,process.removeListener=noop,process.removeAllListeners=noop,process.emit=noop,process.prependListener=noop,process.prependOnceListener=noop,process.listeners=function(name){return[]},process.binding=function(name){throw new Error("process.binding is not supported")},process.cwd=function(){return"/"},process.chdir=function(dir){throw new Error("process.chdir is not supported")},process.umask=function(){return 0}},{}],27:[function(require,module,exports){module.exports=OmegaPac},{}],28:[function(require,module,exports){var BrowserStorage,Promise,Storage,_globalLocalStorageCache,extend=function(child,parent){for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;Storage=require("./storage"),Promise=require("bluebird"),_globalLocalStorageCache=null,BrowserStorage=function(superClass){function BrowserStorage(storage,prefix){this.storage=storage,this.prefix=null!=prefix?prefix:"",this.proto=Object.getPrototypeOf(this.storage)}return extend(BrowserStorage,superClass),BrowserStorage.prototype.get=function(keys){var promiseResult,_this;return promiseResult=idbKeyval.get("localStorage").then((_this=this,function(initValuesMap){var base,i,key,len,map,value;if(_globalLocalStorageCache||("function"==typeof(base=_this.proto).initValuesMap&&base.initValuesMap(initValuesMap),_globalLocalStorageCache=!0),map={},"string"==typeof keys)map[keys]=void 0;else if(Array.isArray(keys))for(i=0,len=keys.length;i<len;i++)map[key=keys[i]]=void 0;else"object"==typeof keys&&(map=keys);for(key in map)if(hasProp.call(map,key)){try{value=JSON.parse(_this.proto.getItem.call(_this.storage,_this.prefix+key))}catch(error){}null!=value&&(map[key]=value),void 0===map[key]&&delete map[key]}return map})),Promise.resolve(promiseResult)},BrowserStorage.prototype.set=function(items){var promiseResult,_this;return promiseResult=idbKeyval.get("localStorage").then((_this=this,function(initValuesMap){var base,key,value;for(key in _globalLocalStorageCache||("function"==typeof(base=_this.proto).initValuesMap&&base.initValuesMap(initValuesMap),_globalLocalStorageCache=!0),items)hasProp.call(items,key)&&(value=items[key],value=JSON.stringify(value),_this.proto.setItem.call(_this.storage,_this.prefix+key,value));return new Promise((function(resolve){return setTimeout((function(){return resolve(items)}),1)}))})).then(function(_this){return function(items){var initValuesMap;return _this.proto.getValuesMap?(initValuesMap=_this.proto.getValuesMap(),idbKeyval.set("localStorage",initValuesMap).then((function(){return items}))):items}}(this)),Promise.resolve(promiseResult)},BrowserStorage.prototype.remove=function(keys){var promiseResult,_this;return promiseResult=idbKeyval.get("localStorage").then((_this=this,function(initValuesMap){var base,i,index,key,len,results;if(_globalLocalStorageCache||("function"==typeof(base=_this.proto).initValuesMap&&base.initValuesMap(initValuesMap),_globalLocalStorageCache=!0),null==keys)if(_this.prefix)for(index=0;null!==(key=_this.proto.key.call(_this.storage,index));)key.substr(0,_this.prefix.length)===_this.prefix?_this.proto.removeItem.call(_this.storage,_this.prefix+keys):index++;else _this.proto.clear.call(_this.storage);for("string"==typeof keys&&_this.proto.removeItem.call(_this.storage,_this.prefix+keys),results=[],i=0,len=keys.length;i<len;i++)key=keys[i],results.push(_this.proto.removeItem.call(_this.storage,_this.prefix+key));return results})).then((function(){return new Promise((function(resolve){return setTimeout((function(){return resolve()}),1)}))})).then(function(_this){return function(){var initValuesMap;if(_this.proto.getValuesMap)return initValuesMap=_this.proto.getValuesMap(),idbKeyval.set("localStorage",initValuesMap).then((function(){}))}}(this)),Promise.resolve(promiseResult)},BrowserStorage}(Storage),module.exports=BrowserStorage},{"./storage":34,bluebird:2}],29:[function(require,module,exports){module.exports=function(){return{schemaVersion:2,"-enableQuickSwitch":!1,"-refreshOnProfileChange":!0,"-startupProfileName":"","-quickSwitchProfiles":[],"-revertProxyChanges":!0,"-confirmDeletion":!0,"-showInspectMenu":!0,"-addConditionsToBottom":!1,"-showExternalProfile":!0,"-downloadInterval":1440,"+proxy":{bypassList:[{pattern:"127.0.0.1",conditionType:"BypassCondition"},{pattern:"::1",conditionType:"BypassCondition"},{pattern:"localhost",conditionType:"BypassCondition"}],profileType:"FixedProfile",name:"proxy",color:"#99ccee",fallbackProxy:{port:8080,scheme:"http",host:"proxy.example.com"}},"+auto switch":{profileType:"SwitchProfile",rules:[{condition:{pattern:"internal.example.com",conditionType:"HostWildcardCondition"},profileName:"direct"},{condition:{pattern:"*.example.com",conditionType:"HostWildcardCondition"},profileName:"proxy"}],name:"auto switch",color:"#99dd99",defaultProfileName:"direct"}}}},{}],30:[function(require,module,exports){var ContentTypeRejectedError,HttpError,HttpNotFoundError,HttpServerError,NetworkError,extend=function(child,parent){for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;NetworkError=function(superClass){function NetworkError(err){NetworkError.__super__.constructor.apply(this,arguments),this.cause=err,this.name="NetworkError"}return extend(NetworkError,superClass),NetworkError}(Error),HttpError=function(superClass){function HttpError(){var ref;HttpError.__super__.constructor.apply(this,arguments),this.statusCode=null!=(ref=this.cause)?ref.statusCode:void 0,this.name="HttpError"}return extend(HttpError,superClass),HttpError}(NetworkError),HttpNotFoundError=function(superClass){function HttpNotFoundError(){HttpNotFoundError.__super__.constructor.apply(this,arguments),this.name="HttpNotFoundError"}return extend(HttpNotFoundError,superClass),HttpNotFoundError}(HttpError),HttpServerError=function(superClass){function HttpServerError(){HttpServerError.__super__.constructor.apply(this,arguments),this.name="HttpServerError"}return extend(HttpServerError,superClass),HttpServerError}(HttpError),ContentTypeRejectedError=function(superClass){function ContentTypeRejectedError(){ContentTypeRejectedError.__super__.constructor.apply(this,arguments),this.name="ContentTypeRejectedError"}return extend(ContentTypeRejectedError,superClass),ContentTypeRejectedError}(Error),module.exports={NetworkError:NetworkError,HttpError:HttpError,HttpNotFoundError:HttpNotFoundError,HttpServerError:HttpServerError,ContentTypeRejectedError:ContentTypeRejectedError}},{}],31:[function(require,module,exports){var replacer;require("./log"),replacer=function(key,value){switch(key){case"username":case"password":case"host":case"port":case"token":case"gistToken":case"gistId":return"<secret>";default:return value}},module.exports={str:function(obj){return"object"==typeof obj&&null!==obj?null!=obj.debugStr?"function"==typeof obj.debugStr?obj.debugStr():obj.debugStr:obj instanceof Error?obj.stack||obj.message:JSON.stringify(obj,replacer,4):"function"==typeof obj?obj.name?"<f: "+obj.name+">":obj.toString():""+obj},log:console.log.bind(console),error:console.error.bind(console),func:function(name,args){return this.log(name,"(",[].slice.call(args),")")},method:function(name,self,args){return this.log(this.str(self),"<<",name,[].slice.call(args))}}},{"./log":31}],32:[function(require,module,exports){var Log,OmegaPac,Options,Promise,Storage,jsondiffpatch,bind=function(fn,me){return function(){return fn.apply(me,arguments)}},extend=function(child,parent){for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;Promise=require("bluebird"),Log=require("./log"),Storage=require("./storage"),OmegaPac=require("omega-pac"),jsondiffpatch=require("jsondiffpatch"),Options=function(){var NoOptionsError,ProfileNotExistError;function Options(_storage,_state,log,sync,proxyImpl){this._storage=_storage,this._state=_state,this.log=log,this.sync=sync,this.proxyImpl=proxyImpl,this._setOptions=bind(this._setOptions,this),this._options={},this._tempProfileRules={},this._tempProfileRulesByProfile={},null==this._storage&&(this._storage=Storage()),null==this._state&&(this._state=Storage()),null==this.log&&(this.log=Log)}return Options.prototype._options=null,Options.prototype._storage=null,Options.prototype._state=null,Options.prototype._currentProfileName=null,Options.prototype._revertToProfileName=null,Options.prototype._watchingProfiles={},Options.prototype._tempProfile=null,Options.prototype._tempProfileActive=!1,Options.prototype.fallbackProfileName="system",Options.prototype._isSystem=!1,Options.prototype.debugStr="Options",Options.prototype.ready=null,Options.ProfileNotExistError=ProfileNotExistError=function(superClass){function ProfileNotExistError(profileName1){this.profileName=profileName1,ProfileNotExistError.__super__.constructor.apply(this,arguments).constructor("Profile "+this.profileName+" does not exist!")}return extend(ProfileNotExistError,superClass),ProfileNotExistError}(Error),Options.NoOptionsError=NoOptionsError=function(superClass){function NoOptionsError(){NoOptionsError.__super__.constructor.apply(this,arguments)}return extend(NoOptionsError,superClass),NoOptionsError}(Error),Options.transformValueForSync=function(value,key){var k,profile,v;if("-customCss"!==key){if("+"===key[0]&&OmegaPac.Profiles.updateUrl(value)){for(k in profile={},value)v=value[k],"lastUpdate"!==k&&"ruleList"!==k&&"pacScript"!==k&&(profile[k]=v);value=profile}return value}},Options.prototype.initWithOptions=function(options,startupCheck){return null==options?this.init(startupCheck):this.ready=this._storage.remove().then((_this=this,function(){return _this._storage.set(options)})).then(function(_this){return function(){return _this.init(startupCheck)}}(this));var _this},Options.prototype.loadOptions=function(arg){var loadRaw,retry,_this;return null==(retry=(null!=arg?arg:{}).retry)&&(retry=3),"function"==typeof this._syncWatchStop&&this._syncWatchStop(),this._syncWatchStop=null,"function"==typeof this._watchStop&&this._watchStop(),this._watchStop=null,loadRaw="undefined"!=typeof options&&null!==options?Promise.resolve(options):null==this.sync?(this._state.set({syncOptions:"unsupported"}),this._storage.get(null)):this._state.get({syncOptions:"",gistId:"",gistToken:""}).then((_this=this,function(arg1){var gistId,gistToken,syncOptions;return syncOptions=arg1.syncOptions,gistId=arg1.gistId,gistToken=arg1.gistToken,gistId||("disabled"!==syncOptions&&(syncOptions="pristine"),_this._state.set({syncOptions:syncOptions})),_this.sync.enabled="sync"===syncOptions,_this.sync.enabled?(_this.sync.init({gistId:gistId,gistToken:gistToken}).catch((function(e){return console.error("sync init fail::",e)})),_this._syncWatchStop=_this.sync.watchAndPull(_this._storage),_this.sync.copyTo(_this._storage).catch(Storage.StorageUnavailableError,(function(){return console.error("Warning: Sync storage is not available in this browser! Disabling options sync."),"function"==typeof _this._syncWatchStop&&_this._syncWatchStop(),_this._syncWatchStop=null,_this.sync=null,_this._state.set({syncOptions:"unsupported"})})).then((function(){return _this._storage.get(null)}))):_this._storage.get(null)})),this.optionsLoaded=loadRaw.then(function(_this){return function(options){return _this.upgrade(options)}}(this)).then(function(_this){return function(arg1){var changes,options;return options=arg1[0],changes=arg1[1],_this._storage.apply({changes:changes}).return(options)}}(this)).tap(function(_this){return function(options){return _this._options=options,_this._watchStop=_this._watch(),_this._state.get({syncOptions:""}).then((function(arg1){if(!arg1.syncOptions)return _this._state.set({syncOptions:"conflict"}),_this.sync.storage.get("schemaVersion").then((function(arg2){if(!arg2.schemaVersion)return _this._state.set({syncOptions:"pristine"})}))}))}}(this)).catch(function(_this){return function(e){return retry>0?Promise.resolve().then((function(){return e instanceof NoOptionsError?(_this._state.get({firstRun:"new","web.switchGuide":"showOnFirstUse"}).then((function(items){return _this._state.set(items)})),null==_this.sync?null:_this._state.get({syncOptions:""}).then((function(arg1){if("conflict"!==arg1.syncOptions)return _this.sync.storage.get(null).then((function(options){return options.schemaVersion?(_this._state.set({syncOptions:"sync"}),_this.sync.enabled=!0,_this.log.log("Options#loadOptions::fromSync",options),options):(_this._state.set({syncOptions:"pristine"}),null)})).catch((function(){return null}))}))):(_this.log.error(e.stack),_this._state.remove(["syncOptions"]),null)})).then((function(options){var prevEnabled;return null==options&&(options=_this.parseOptions(_this.getDefaultOptions())),null!=_this.sync&&(prevEnabled=_this.sync.enabled,_this.sync.enabled=!1),_this._storage.remove().then((function(){return _this._storage.set(options)})).then((function(){return null!=_this.sync&&(_this.sync.enabled=prevEnabled),_this.loadOptions({retry:retry-1})}))})):Promise.reject(e)}}(this))},Options.prototype.init=function(startupCheck){var _this;return null==startupCheck&&(startupCheck=function(){return!0}),this.ready=this.loadOptions().then((_this=this,function(){return globalThis.isBrowserRestart&&startupCheck()&&_this._options["-startupProfileName"]?(console.log("apply browser restart startup profile",_this._options["-startupProfileName"]),_this.applyProfile(_this._options["-startupProfileName"])):_this._state.get({currentProfileName:_this.fallbackProfileName,isSystemProfile:!1}).then((function(st){return console.log("apply init startup profile",st),st.isSystemProfile?_this.applyProfile("system"):_this.applyProfile(st.currentProfileName||_this.fallbackProfileName)}))})).catch(function(_this){return function(err){return!err instanceof ProfileNotExistError&&_this.log.error(err),_this.applyProfile(_this.fallbackProfileName)}}(this)).catch(function(_this){return function(err){return _this.log.error(err)}}(this)).then(function(_this){return function(){return _this.getAll()}}(this)),this.ready.then(function(_this){return function(){if(_this._state.get({firstRun:""}).then((function(arg){var firstRun;if(firstRun=arg.firstRun)return _this.onFirstRun(firstRun)})),_this._options["-downloadInterval"]>0)return _this.updateProfile()}}(this)),this.ready},Options.prototype.toString=function(){return"<Options>"},Options.prototype.printProfile=function(profile){return null},Options.prototype.upgrade=function(options,changes){var autoDetectUsed,version;return null==changes&&(changes={}),1===(version=null!=options?options.schemaVersion:void 0)&&(autoDetectUsed=!1,OmegaPac.Profiles.each(options,(function(key,profile){if(!autoDetectUsed&&OmegaPac.Profiles.directReferenceSet(profile)["+auto_detect"])return autoDetectUsed=!0})),autoDetectUsed&&(options["+auto_detect"]=OmegaPac.Profiles.create({name:"auto_detect",profileType:"PacProfile",pacUrl:"http://wpad/wpad.dat",color:"#00cccc"})),version=changes.schemaVersion=options.schemaVersion=2),OmegaPac.Profiles.each(options,(function(key,profile){if("disabled"===profile.syncOptions)return delete profile.syncOptions,delete profile.syncError})),2===version?Promise.resolve([options,changes]):Promise.reject(new Error("Invalid schemaVersion "+version+"!"))},Options.prototype.parseOptions=function(options){var Buffer;if("string"==typeof options){if("{"!==options[0])try{Buffer=require("buffer").Buffer,options=new Buffer(options,"base64").toString("utf8")}catch(error){error,options=null}options=function(){try{return JSON.parse(options)}catch(error){}}()}if(!options)throw new Error("Invalid options!");return options},Options.prototype.reset=function(options){var _options,_this;return this.log.method("Options#reset",this,arguments),null==options&&(options=this.getDefaultOptions()),_options=this.parseOptions(options),this.upgrade(_options).then((_this=this,function(arg){var opt;return opt=arg[0],null!=_this.sync&&(_this.sync.enabled=!1),_this._state.remove(["syncOptions"]),"function"==typeof _this._watchStop&&_this._watchStop(),_this._watchStop=null,_this._storage.remove().then((function(){return _this._storage.set(opt)})).then((function(){return _this.init()})).then((function(){if(_options["-startupProfileName"])return _this.applyProfile(_options["-startupProfileName"])}))}))},Options.prototype.onFirstRun=function(reason){return null},Options.prototype.getDefaultOptions=function(){return require("./default_options")()},Options.prototype.getAll=function(){return this._options},Options.prototype.profile=function(name){return OmegaPac.Profiles.byName(name,this._options)},Options.prototype.patch=function(patch){var changes,delta,key;if(patch){for(key in this.log.method("Options#patch",this,arguments),this._options=jsondiffpatch.patch(this._options,patch),changes={},patch)hasProp.call(patch,key)&&(3===(delta=patch[key]).length&&0===delta[1]&&0===delta[2]?changes[key]=void 0:changes[key]=this._options[key]);return this._setOptions(changes)}},Options.prototype._setOptions=function(changes,args){var checkRev,currentProfileAffected,j,key,len,profilesChanged,ref,ref1,ref2,ref3,removed,value,_this;for(key in removed=[],checkRev=null!=(ref=null!=args?args.checkRevision:void 0)&&ref,profilesChanged=!1,currentProfileAffected=!1,changes)if(hasProp.call(changes,key)){if(void 0===(value=changes[key]))delete this._options[key],removed.push(key),"+"===key[0]&&(profilesChanged=!0,key==="+"+this._currentProfileName&&(currentProfileAffected="removed"));else{if("+"===key[0]){if(checkRev&&this._options[key]&&OmegaPac.Revision.compare(this._options[key].revision,value.revision)>=0)continue;profilesChanged=!0}this._options[key]=value}!currentProfileAffected&&this._watchingProfiles[key]&&(currentProfileAffected="changed")}switch(currentProfileAffected){case"removed":this.applyProfile(this.fallbackProfileName);break;case"changed":this.applyProfile(this._currentProfileName,{update:!1});break;default:profilesChanged&&this._setAvailableProfiles()}if(null==(ref1=null!=args?args.persist:void 0)||ref1){for((null!=(ref2=this.sync)?ref2.enabled:void 0)&&null!=(ref3=this.sync)&&ref3.requestPush(changes),j=0,len=removed.length;j<len;j++)delete changes[key=removed[j]];return this._storage.set(changes).then((_this=this,function(){return _this._storage.remove(removed),_this._options}))}},Options.prototype._watch=function(){var handler,_this;return _this=this,(handler=function(changes){var customCss,monitorWebRequests,quickSwitchProfiles,refresh,showExternal,showMenu;if(changes?_this._setOptions(changes,{checkRevision:!0,persist:!1}):changes=_this._options,null!=(refresh=changes["-refreshOnProfileChange"])&&_this._state.set({refreshOnProfileChange:refresh}),null!=(customCss=changes["-customCss"])&&_this._state.set({customCss:csso.minify(customCss).css}),Object.prototype.hasOwnProperty.call(changes,"-showExternalProfile")&&(null==(showExternal=changes["-showExternalProfile"])&&(showExternal=!0,_this._setOptions({"-showExternalProfile":!0},{persist:!0})),_this._state.set({showExternalProfile:showExternal})),quickSwitchProfiles=changes["-quickSwitchProfiles"],quickSwitchProfiles=_this._cleanUpQuickSwitchProfiles(quickSwitchProfiles),null==changes["-enableQuickSwitch"]&&null==quickSwitchProfiles||_this.reloadQuickSwitch(),null!=changes["-downloadInterval"]&&_this.schedule("updateProfile",_this._options["-downloadInterval"]),null==changes["-showInspectMenu"]&&changes!==_this._options||(null==(showMenu=_this._options["-showInspectMenu"])&&(showMenu=!0,_this._setOptions({"-showInspectMenu":!0},{persist:!0})),_this.setInspect({showMenu:showMenu})),null!=changes["-monitorWebRequests"]||changes===_this._options)return null==(monitorWebRequests=_this._options["-monitorWebRequests"])&&(monitorWebRequests=!0,_this._setOptions({"-monitorWebRequests":!0},{persist:!0})),_this.setMonitorWebRequests(monitorWebRequests)})(),this._storage.watch(null,handler)},Options.prototype._cleanUpQuickSwitchProfiles=function(quickSwitchProfiles){var seenQuickSwitchProfile,validQuickSwitchProfiles,_this;if(null!=quickSwitchProfiles)return seenQuickSwitchProfile={},(validQuickSwitchProfiles=quickSwitchProfiles.filter((_this=this,function(name){var key;return!(!name||(key=OmegaPac.Profiles.nameAsKey(name),seenQuickSwitchProfile[key]||!OmegaPac.Profiles.byName(name,_this._options)||(seenQuickSwitchProfile[key]=!0,0)))}))).length!==quickSwitchProfiles.length&&this._setOptions({"-quickSwitchProfiles":validQuickSwitchProfiles},{persist:!0}),validQuickSwitchProfiles},Options.prototype.reloadQuickSwitch=function(){var profiles;return(profiles=this._options["-quickSwitchProfiles"]).length<2&&(profiles=null),this._options["-enableQuickSwitch"]?this.setQuickSwitch(profiles,!!profiles):this.setQuickSwitch(null,!!profiles)},Options.prototype.setInspect=function(){return Promise.resolve()},Options.prototype.setMonitorWebRequests=function(){return Promise.resolve()},Options.prototype.watch=function(callback){return this._storage.watch(null,callback)},Options.prototype._profileNotFound=function(name){return this.log.error("Profile "+name+" not found! Things may go very, very wrong."),OmegaPac.Profiles.create({name:name,profileType:"VirtualProfile",defaultProfileName:"direct"})},Options.prototype.pacForProfile=function(profile,compress){var ast;return null==compress&&(compress=!1),ast=OmegaPac.PacGenerator.script(this._options,profile,{profileNotFound:this._profileNotFound.bind(this)}),compress&&(ast=OmegaPac.PacGenerator.compress(ast)),Promise.resolve(OmegaPac.PacGenerator.ascii(ast.print_to_string()))},Options.prototype._setAvailableProfiles=function(){var allReferenceSet,currentIncludable,profile,profiles,results,_this;return profile=this._currentProfileName?this.currentProfile():null,profiles={},currentIncludable=profile&&OmegaPac.Profiles.isIncludable(profile),allReferenceSet=null,profile&&OmegaPac.Profiles.isInclusive(profile)||(results=[]),OmegaPac.Profiles.each(this._options,(_this=this,function(key,p){if(profiles[key]={name:p.name,profileType:p.profileType,color:p.color,desc:_this.printProfile(p),builtin:!!p.builtin||void 0},"VirtualProfile"===p.profileType&&(profiles[key].defaultProfileName=p.defaultProfileName,null==allReferenceSet&&(allReferenceSet=profile?OmegaPac.Profiles.allReferenceSet(profile,_this._options,{profileNotFound:_this._profileNotFound.bind(_this)}):{}),allReferenceSet[key]&&(profiles[key].validResultProfiles=OmegaPac.Profiles.validResultProfilesFor(p,_this._options).map((function(result){return result.name})))),currentIncludable&&OmegaPac.Profiles.isIncludable(p))return null!=results?results.push(p.name):void 0})),profile&&OmegaPac.Profiles.isInclusive(profile)&&(results=(results=OmegaPac.Profiles.validResultProfilesFor(profile,this._options)).map((function(profile){return profile.name}))),this._state.set({availableProfiles:profiles,validResultProfiles:results})},Options.prototype.applyProfile=function(name,options){var applyProxy,j,key,l,len,len1,list,profile,ref,removedKeys,rule,_this;if(this.log.method("Options#applyProfile",this,arguments),!(profile=OmegaPac.Profiles.byName(name,this._options)))return Promise.reject(new ProfileNotExistError(name));if(this._currentProfileName=profile.name,this._isSystem=(null!=options?options.system:void 0)||"SystemProfile"===profile.profileType,this._watchingProfiles=OmegaPac.Profiles.allReferenceSet(profile,this._options,{profileNotFound:this._profileNotFound.bind(this)}),this._state.set({currentProfileName:this._currentProfileName,isSystemProfile:this._isSystem,currentProfileCanAddRule:null!=profile.rules&&"VirtualProfile"!==profile.profileType}),this._setAvailableProfiles(),this.currentProfileChanged(null!=options?options.reason:void 0),null!=options&&!1===options.proxy)return Promise.resolve();if(this._tempProfileActive=!1,null!=this._tempProfile&&OmegaPac.Profiles.isIncludable(profile)){for(key in this._tempProfileActive=!0,this._tempProfile.defaultProfileName!==profile.name&&(this._tempProfile.defaultProfileName=profile.name,this._tempProfile.color=profile.color,OmegaPac.Profiles.updateRevision(this._tempProfile)),removedKeys=[],ref=this._tempProfileRulesByProfile)if(hasProp.call(ref,key)&&(list=ref[key],!OmegaPac.Profiles.byKey(key,this._options)))for(removedKeys.push(key),j=0,len=list.length;j<len;j++)(rule=list[j]).profileName=null,this._tempProfile.rules.splice(this._tempProfile.rules.indexOf(rule),1);if(removedKeys.length>0){for(l=0,len1=removedKeys.length;l<len1;l++)key=removedKeys[l],delete this._tempProfileRulesByProfile[key];OmegaPac.Profiles.updateRevision(this._tempProfile)}this._watchingProfiles=OmegaPac.Profiles.allReferenceSet(this._tempProfile,this._options,{profileNotFound:this._profileNotFound.bind(this)}),applyProxy=this.proxyImpl.applyProfile(this._tempProfile,profile,this._options)}else applyProxy=this.proxyImpl.applyProfile(profile,profile,this._options);return null!=options&&!1===options.update||applyProxy.then((_this=this,function(){var ref1,updateProfiles;if(_this._options["-downloadInterval"]>0&&_this._currentProfileName===profile.name){for(key in updateProfiles=[],ref1=_this._watchingProfiles)name=ref1[key],updateProfiles.push(name);return updateProfiles.length>0?_this.updateProfile(updateProfiles):void 0}})),applyProxy},Options.prototype.currentProfile=function(){return this._currentProfileName?OmegaPac.Profiles.byName(this._currentProfileName,this._options):this._externalProfile},Options.prototype.isSystem=function(){return this._isSystem},Options.prototype.currentProfileChanged=function(){return null},Options.prototype.setQuickSwitch=function(quickSwitch,canEnable){return Promise.resolve()},Options.prototype.schedule=function(name,periodInMinutes,callback){return Promise.resolve()},Options.prototype.isCurrentProfileStatic=function(){var currentProfile;return!this._currentProfileName||!this._tempProfileActive&&(currentProfile=this.currentProfile(),!OmegaPac.Profiles.isInclusive(currentProfile))},Options.prototype.updateProfile=function(name,opt_bypass_cache){var results,_this;return results={},OmegaPac.Profiles.each(this._options,(_this=this,function(key,profile){var fetchResult,type_hints,url;if(null!=name)if(Array.isArray(name)){if(!(name.indexOf(profile.name)>=0))return}else if(profile.name!==name)return;if(url=OmegaPac.Profiles.updateUrl(profile))return type_hints=OmegaPac.Profiles.updateContentTypeHints(profile),fetchResult=_this.fetchUrl(url,opt_bypass_cache,type_hints),results[key]=fetchResult.then((function(data){var changes;return data?((profile=OmegaPac.Profiles.byKey(key,_this._options)).lastUpdate=(new Date).toISOString(),OmegaPac.Profiles.update(profile,data)?(OmegaPac.Profiles.dropCache(profile),(changes={})[key]=profile,_this._setOptions(changes).return(profile)):profile):profile})).catch((function(reason){return reason instanceof Error?reason:new Error(reason)}))})),Promise.props(results)},Options.prototype.fetchUrl=function(url,opt_bypass_cache,opt_type_hints){return Promise.reject(new Error("not implemented"))},Options.prototype._replaceRefChanges=function(fromName,toName,changes){var i,j,quickSwitch,ref;if(null==changes&&(changes={}),OmegaPac.Profiles.each(this._options,(function(key,p){if(p.name!==fromName&&p.name!==toName)return OmegaPac.Profiles.replaceRef(p,fromName,toName)?(OmegaPac.Profiles.updateRevision(p),changes[OmegaPac.Profiles.nameAsKey(p)]=p):void 0})),this._options["-startupProfileName"]===fromName&&(changes["-startupProfileName"]=toName),(quickSwitch=this._options["-quickSwitchProfiles"]).indexOf(toName)<0)for(i=j=0,ref=quickSwitch.length;0<=ref?j<ref:j>ref;i=0<=ref?++j:--j)quickSwitch[i]===fromName&&(quickSwitch[i]=toName,changes["-quickSwitchProfiles"]=quickSwitch);return changes},Options.prototype.replaceRef=function(fromName,toName){var changes,fromKey,key,value;if(this.log.method("Options#replaceRef",this,arguments),!OmegaPac.Profiles.byName(fromName,this._options))return Promise.reject(new ProfileNotExistError(fromName));for(key in changes=this._replaceRefChanges(fromName,toName))hasProp.call(changes,key)&&(value=changes[key],this._options[key]=value);return fromKey=OmegaPac.Profiles.nameAsKey(fromName),this._watchingProfiles[fromKey]&&(this._currentProfileName===fromName&&(this._currentProfileName=toName),this.applyProfile(this._currentProfileName)),this._setOptions(changes)},Options.prototype.renameProfile=function(fromName,toName){var changes,fromKey,key,profile,value;if(this.log.method("Options#renameProfile",this,arguments),OmegaPac.Profiles.byName(toName,this._options))return Promise.reject(new Error("Target name "+name+" already taken!"));if(!(profile=OmegaPac.Profiles.byName(fromName,this._options)))return Promise.reject(new ProfileNotExistError(fromName));for(key in profile.name=toName,(changes={})[OmegaPac.Profiles.nameAsKey(profile)]=profile,this._replaceRefChanges(fromName,toName,changes),changes)hasProp.call(changes,key)&&(value=changes[key],this._options[key]=value);return changes[fromKey=OmegaPac.Profiles.nameAsKey(fromName)]=void 0,delete this._options[fromKey],this._watchingProfiles[fromKey]&&(this._currentProfileName===fromName&&(this._currentProfileName=toName),this.applyProfile(this._currentProfileName)),this._setOptions(changes)},Options.prototype.addTempRule=function(domain,profileName,toggle){var changed,currentProfile,key,list,rule,rulesByProfile;if(this.log.method("Options#addTempRule",this,arguments),!this._currentProfileName)return Promise.resolve();if(!OmegaPac.Profiles.byName(profileName,this._options))return Promise.reject(new ProfileNotExistError(profileName));if(null==this._tempProfile&&(this._tempProfile=OmegaPac.Profiles.create("","SwitchProfile"),currentProfile=this.currentProfile(),this._tempProfile.color=currentProfile.color,this._tempProfile.defaultProfileName=currentProfile.name),changed=0,rule=this._tempProfileRules[domain],toggle){if(rule&&1===toggle)return Promise.resolve();if(!rule&&-1===toggle)return Promise.resolve()}return rule&&rule.profileName?rule.profileName!==profileName?(key=OmegaPac.Profiles.nameAsKey(rule.profileName),(list=this._tempProfileRulesByProfile[key]).splice(list.indexOf(rule),1),rule.profileName=profileName,changed=1):(this._tempProfile.rules.splice(this._tempProfile.rules.indexOf(rule),1),delete this._tempProfileRules[domain],changed=-1):(rule={condition:{conditionType:"HostWildcardCondition",pattern:"*."+domain},profileName:profileName,isTempRule:!0},this._tempProfile.rules.push(rule),this._tempProfileRules[domain]=rule,changed=1),key=OmegaPac.Profiles.nameAsKey(profileName),null==(rulesByProfile=this._tempProfileRulesByProfile[key])&&(rulesByProfile=this._tempProfileRulesByProfile[key]=[]),1===changed?rulesByProfile.push(rule):rulesByProfile.splice(rulesByProfile.indexOf(rule),1),changed?(OmegaPac.Profiles.updateRevision(this._tempProfile),this.applyProfile(this._currentProfileName)):Promise.resolve()},Options.prototype.queryTempRule=function(domain){var rule;if(rule=this._tempProfileRules[domain]){if(rule.profileName)return rule.profileName;delete this._tempProfileRules[domain]}return null},Options.prototype.addCondition=function(condition,profileName){var changes,cond,i,j,l,len,profile,ref,tag;if(this.log.method("Options#addCondition",this,arguments),!this._currentProfileName)return Promise.resolve();if(null==(null!=(profile=OmegaPac.Profiles.byName(this._currentProfileName,this._options))?profile.rules:void 0))return Promise.reject(new Error("Cannot add condition to Profile "+this.profile.name+" ("+profile.type+")"));if(null==OmegaPac.Profiles.byName(profileName,this._options))return Promise.reject(new ProfileNotExistError(profileName));for(Array.isArray(condition)||(condition=[condition]),j=0,len=condition.length;j<len;j++){for(cond=condition[j],tag=OmegaPac.Conditions.tag(cond),i=l=0,ref=profile.rules.length;0<=ref?l<ref:l>ref;i=0<=ref?++l:--l)if(OmegaPac.Conditions.tag(profile.rules[i].condition)===tag){profile.rules.splice(i,1);break}this._options["-addConditionsToBottom"]?profile.rules.push({condition:cond,profileName:profileName}):profile.rules.unshift({condition:cond,profileName:profileName})}return OmegaPac.Profiles.updateRevision(profile),(changes={})[OmegaPac.Profiles.nameAsKey(profile)]=profile,this._setOptions(changes)},Options.prototype.setDefaultProfile=function(profileName,defaultProfileName){var changes,profile;return this.log.method("Options#setDefaultProfile",this,arguments),null==(profile=OmegaPac.Profiles.byName(profileName,this._options))?Promise.reject(new ProfileNotExistError(profileName)):null==profile.defaultProfileName?Promise.reject(new Error("Profile "+this.profile.name+" (@{profile.type}) does not have defaultProfileName!")):null==OmegaPac.Profiles.byName(defaultProfileName,this._options)?Promise.reject(new ProfileNotExistError(defaultProfileName)):(profile.defaultProfileName=defaultProfileName,OmegaPac.Profiles.updateRevision(profile),(changes={})[OmegaPac.Profiles.nameAsKey(profile)]=profile,this._setOptions(changes))},Options.prototype.addProfile=function(profile){var changes;return this.log.method("Options#addProfile",this,arguments),OmegaPac.Profiles.byName(profile.name,this._options)?Promise.reject(new Error("Target name "+profile.name+" already taken!")):((changes={})[OmegaPac.Profiles.nameAsKey(profile)]=profile,this._setOptions(changes))},Options.prototype.matchProfile=function(request){var lastProfile,next,profile,result,results;if(!this._currentProfileName)return Promise.resolve({profile:this._externalProfile,results:[]});for(results=[],profile=this._tempProfileActive?this._tempProfile:OmegaPac.Profiles.byName(this._currentProfileName,this._options);profile&&(lastProfile=profile,null!=(result=OmegaPac.Profiles.match(profile,request)));){if(results.push(result),Array.isArray(result))next=result[0];else{if(!result.profileName)break;next=OmegaPac.Profiles.nameAsKey(result.profileName)}profile=OmegaPac.Profiles.byKey(next,this._options)}return Promise.resolve({profile:lastProfile,results:results})},Options.prototype.setExternalProfile=function(profile,args){var p;if(this._options["-revertProxyChanges"]&&!this._isSystem&&profile.name!==this._currentProfileName&&this._currentProfileName){if(!(null!=args?args.noRevert:void 0))return this.applyProfile(this._revertToProfileName),void(this._revertToProfileName=null);null==this._revertToProfileName&&(this._revertToProfileName=this._currentProfileName)}if(p=OmegaPac.Profiles.byName(profile.name,this._options))return(null!=args?args.internal:void 0)?this.applyProfile(p.name,{proxy:!1}):this.applyProfile(p.name,{proxy:!1,system:this._isSystem,reason:"external"});this._currentProfileName=null,this._externalProfile=profile,null==profile.color&&(profile.color="#49afcd"),this._state.set({currentProfileName:"",externalProfile:profile,validResultProfiles:[],currentProfileCanAddRule:!1}),this.currentProfileChanged("external")},Options.prototype.setOptionsSync=function(enabled,args){return null==args&&(args={}),this.log.method("Options#setOptionsSync",this,arguments),null==this.sync?Promise.reject(new Error("Options syncing is unsupported.")):this._state.get({syncOptions:"",lastGistCommit:""}).then((_this=this,function(arg){var gistId,gistToken,syncOptions;return syncOptions=arg.syncOptions,arg.lastGistCommit,enabled?"conflict"!==syncOptions||args.force?"sync"!==syncOptions?(gistId=args.gistId,gistToken=args.gistToken,_this.sync.init({gistId:gistId,gistToken:gistToken,withRemoteData:!0}).then((function(arg1){var remoteOptions;return remoteOptions=arg1.options,arg1.lastGistCommit,_this._state.set({syncOptions:"sync",gistId:gistId,gistToken:gistToken}).then((function(){return"conflict"===syncOptions?(_this.sync.enabled=!1,"function"==typeof _this._watchStop&&_this._watchStop(),_this._watchStop=null,_this._storage.remove().then((function(){if(remoteOptions)return console.log("flush data"),_this.sync.flush({data:remoteOptions})})).then((function(){return _this.sync.enabled=!0,_this.init().then((function(){return remoteOptions&&remoteOptions["-startupProfileName"]&&(console.log("apply startup"),_this.applyProfile(remoteOptions["-startupProfileName"])),args.useBuiltInSync?_this.sync.toggleBuiltInSync(!0):_this.sync.toggleBuiltInSync(!1)})).then((function(){return _this.updateProfile()}))}))):(null!=remoteOptions?remoteOptions.schemaVersion:void 0)?_this.sync.flush({data:remoteOptions}).then((function(){_this.sync.enabled=!1,_this._state.set({syncOptions:"conflict"})})):(_this.sync.enabled=!0,"function"==typeof _this._syncWatchStop&&_this._syncWatchStop(),_this.sync.requestPush(_this._options),_this._syncWatchStop=_this.sync.watchAndPull(_this._storage),void(args.useBuiltInSync?_this.sync.toggleBuiltInSync(!0):_this.sync.toggleBuiltInSync(!1)))}))}))):void 0:Promise.reject(new Error("Syncing not enabled due to conflict. Retry with force to overwrite local options and enable syncing.")):("sync"===syncOptions&&_this._state.set({syncOptions:"disabled"}),_this.sync.enabled=!1,"function"==typeof _this._syncWatchStop&&_this._syncWatchStop(),_this._syncWatchStop=null,void _this.sync.destroy())}));var _this},Options.prototype.resetOptionsSync=function(args){return this.log.method("Options#resetOptionsSync",this,arguments),null==this.sync?Promise.reject(new Error("Options syncing is unsupported.")):(this.sync.enabled=!1,"function"==typeof this._syncWatchStop&&this._syncWatchStop(),this._syncWatchStop=null,this._state.set({syncOptions:"conflict"}).then((_this=this,function(){return _this.sync.init(args)})).then(function(_this){return function(){return _this.sync.storage.remove()}}(this)).then(function(_this){return function(){return _this._state.set({syncOptions:"pristine"})}}(this)));var _this},Options.prototype.checkOptionsSyncChange=function(){if(this.sync&&this.sync.enabled)return this.sync.checkChange()},Options}(),module.exports=Options},{"./default_options":29,"./log":31,"./storage":34,bluebird:2,buffer:3,jsondiffpatch:19,"omega-pac":27}],33:[function(require,module,exports){var BUILTINSYNCKEY,Log,OptionsSync,Promise,Revision,Storage,TokenBucket,jsondiffpatch,hasProp={}.hasOwnProperty;Promise=require("bluebird"),Storage=require("./storage"),Log=require("./log"),Revision=require("omega-pac").Revision,jsondiffpatch=require("jsondiffpatch"),TokenBucket=require("limiter").TokenBucket,BUILTINSYNCKEY="zeroOmegaSync",OptionsSync=function(){function OptionsSync(storage,builtInSyncStorage,state,_bucket){var base1,_this;this.storage=storage,this.builtInSyncStorage=builtInSyncStorage,this.state=state,this._bucket=_bucket,this._pending={},null==this._bucket&&(this._bucket=new TokenBucket(10,10,"minute",null)),null==(base1=this._bucket).clear&&(base1.clear=(_this=this,function(){return _this._bucket.tryRemoveTokens(_this._bucket.content)}))}var diff;return OptionsSync.TokenBucket=TokenBucket,OptionsSync.prototype._timeout=null,OptionsSync.prototype._bucket=null,OptionsSync.prototype._waiting=!1,OptionsSync.prototype.debounce=1e3,OptionsSync.prototype.pullThrottle=1e3,OptionsSync.prototype.storage=null,OptionsSync.prototype.builtInSyncStorage=null,OptionsSync.prototype.state=null,OptionsSync.prototype.transformValue=function(v){return v},OptionsSync.prototype.merge=(diff=jsondiffpatch.create({objectHash:function(obj){return JSON.stringify(obj)},textDiff:{minLength:1/0}}),function(key,newVal,oldVal){return newVal===oldVal||null!=(null!=oldVal?oldVal.revision:void 0)&&null!=(null!=newVal?newVal.revision:void 0)&&Revision.compare(oldVal.revision,newVal.revision)>=0||null==diff.diff(oldVal,newVal)?oldVal:newVal}),OptionsSync.prototype.enabled=!0,OptionsSync.prototype.requestPush=function(changes){var key,value;for(key in null!=this._timeout&&clearTimeout(this._timeout),changes)hasProp.call(changes,key)&&(void 0!==(value=changes[key])&&void 0===(value=this.transformValue(value,key))||(this._pending[key]=value));if(this.enabled)return this._timeout=setTimeout(this._doPush.bind(this),this.debounce)},OptionsSync.prototype.pendingChanges=function(){return this._pending},OptionsSync.prototype._doPush=function(){var _this;if(this._timeout=null,!this._waiting)return this._waiting=!0,this._bucket.removeTokens(1,(_this=this,function(){return _this.storage.get(null).then((function(base){var changes;return changes=_this._pending,_this._pending={},_this._waiting=!1,Storage.operationsForChanges(changes,{base:base,merge:_this.merge})})).then((function(arg){var remove,set;return set=arg.set,remove=arg.remove,(0===Object.keys(set).length?Promise.resolve(0):(Log.log("OptionsSync::set",set),_this.storage.set(set).return(1))).then((function(cost){if(set={},remove.length>0)return _this._bucket.tryRemoveTokens(cost)?(Log.log("OptionsSync::remove",remove),_this.storage.remove(remove)):Promise.reject("bucket")})).catch((function(e){var i,key,len,value,valuesAffected;for(key in set)hasProp.call(set,key)&&(value=set[key],key in _this._pending||(_this._pending[key]=value));for(i=0,len=remove.length;i<len;i++)(key=remove[i])in _this._pending||(_this._pending[key]=void 0);if("bucket"===e)return _this._doPush();if(e instanceof Storage.RateLimitExceededError)Log.log("OptionsSync::rateLimitExceeded"),_this._bucket.clear(),_this.requestPush({});else{if(!(e instanceof Storage.QuotaExceededError))return Promise.reject(e);for(key in valuesAffected=0,set)hasProp.call(set,key)&&(value=set[key],"+"===key[0]&&"disabled"!==value.syncOptions&&(value.syncOptions="disabled",value.syncError={reason:"quotaPerItem"},valuesAffected++));valuesAffected>0?_this.requestPush({}):_this._pending={}}}))}))}))},OptionsSync.prototype._logOperations=function(text,operations){if(Object.keys(operations.set).length&&Log.log(text+"::set",operations.set),operations.remove.length)return Log.log(text+"::remove",operations.remove)},OptionsSync.prototype.copyTo=function(local){return Promise.join(local.get(null),this.storage.get(null),(_this=this,function(base,changes){return local.apply({changes:changes,base:base,merge:_this.merge}).then((function(operations){return _this._logOperations("OptionsSync::copyTo",operations)}))}));var _this},OptionsSync.prototype.watchAndPull=function(local){var doPull,pull,pullScheduled,_this;return pullScheduled=null,pull={},_this=this,doPull=function(){return local.get(null).then((function(base){var changes;return changes=pull,pull={},pullScheduled=null,Storage.operationsForChanges(changes,{base:base,merge:_this.merge})})).then((function(operations){return _this._logOperations("OptionsSync::pull",operations),local.apply(operations)}))},this.storage.watch(null,function(_this){return function(changes,opts){var key,value;for(key in null==opts&&(opts={}),changes)hasProp.call(changes,key)&&(value=changes[key],pull[key]=value);if(null==pullScheduled)return opts.immediately?doPull():pullScheduled=setTimeout(doPull,_this.pullThrottle)}}(this))},OptionsSync.prototype.toggleBuiltInSync=function(useBuiltInSync){return this.getBuiltInSyncConfig().then((_this=this,function(builtInSyncConfig){return _this.state.get({gistId:"",gistToken:"",lastGistCommit:""}).then((function(syncConfig){var _obj;return void 0===useBuiltInSync&&(useBuiltInSync=!builtInSyncConfig),!0===useBuiltInSync?((_obj={})[BUILTINSYNCKEY]=syncConfig,_this.builtInSyncStorage.set(_obj)):_this.builtInSyncStorage.remove(BUILTINSYNCKEY)}))}));var _this},OptionsSync.prototype.getBuiltInSyncConfig=function(){return this.builtInSyncStorage.get(BUILTINSYNCKEY).then((function(_obj){return _obj[BUILTINSYNCKEY]}))},OptionsSync.prototype.updateBuiltInSyncConfigIf=function(_builtInSyncConfig){return this.getBuiltInSyncConfig().then((_this=this,function(builtInSyncConfig){var _obj,newBuiltInSyncConfig;if(builtInSyncConfig)return newBuiltInSyncConfig=Object.assign({},builtInSyncConfig,_builtInSyncConfig),(_obj={})[BUILTINSYNCKEY]=newBuiltInSyncConfig,_this.builtInSyncStorage.set(_obj)}));var _this},OptionsSync.prototype.checkChange=function(){return this.storage.checkChange({immediately:!0,force:!0})},OptionsSync.prototype.init=function(args){return args.optionsSync=this,args.state=this.state,this.storage.init(args)},OptionsSync.prototype.destroy=function(){return this.storage.destroy()},OptionsSync.prototype.flush=function(arg){var data;return data=arg.data,this.storage.flush({data:data})},OptionsSync}(),module.exports=OptionsSync},{"./log":31,"./storage":34,bluebird:2,jsondiffpatch:19,limiter:22,"omega-pac":27}],34:[function(require,module,exports){var Log,Promise,Storage,extend=function(child,parent){for(var key in parent)hasProp.call(parent,key)&&(child[key]=parent[key]);function ctor(){this.constructor=child}return ctor.prototype=parent.prototype,child.prototype=new ctor,child.__super__=parent.prototype,child},hasProp={}.hasOwnProperty;Promise=require("bluebird"),Log=require("./log"),Storage=function(){function Storage(){}return Storage.RateLimitExceededError=function(superClass){function RateLimitExceededError(){RateLimitExceededError.__super__.constructor.apply(this,arguments)}return extend(RateLimitExceededError,superClass),RateLimitExceededError}(Error),Storage.QuotaExceededError=function(superClass){function QuotaExceededError(){QuotaExceededError.__super__.constructor.apply(this,arguments)}return extend(QuotaExceededError,superClass),QuotaExceededError}(Error),Storage.StorageUnavailableError=function(superClass){function StorageUnavailableError(){StorageUnavailableError.__super__.constructor.apply(this,arguments)}return extend(StorageUnavailableError,superClass),StorageUnavailableError}(Error),Storage.operationsForChanges=function(changes,arg){var base,key,merge,newVal,oldVal,ref,remove,set;for(key in base=(ref=null!=arg?arg:{}).base,merge=ref.merge,set={},remove=[],changes)newVal=changes[key],oldVal=null!=base?base[key]:newVal,merge&&(newVal=merge(key,newVal,oldVal)),null!=base&&newVal===oldVal||(void 0===newVal?void 0===oldVal&&null!=base||remove.push(key):set[key]=newVal);return{set:set,remove:remove}},Storage.prototype.get=function(keys){var i,key,len,map,ref,value;if(Log.method("Storage#get",this,arguments),!this._items)return Promise.resolve({});if(null==keys&&(keys=this._items),map={},"string"==typeof keys)map[keys]=this._items[keys];else if(Array.isArray(keys))for(i=0,len=keys.length;i<len;i++)map[key=keys[i]]=this._items[key];else if("object"==typeof keys)for(key in keys)value=keys[key],map[key]=null!=(ref=this._items[key])?ref:value;return Promise.resolve(map)},Storage.prototype.set=function(items){var key,value;for(key in Log.method("Storage#set",this,arguments),null==this._items&&(this._items={}),items)value=items[key],this._items[key]=value;return Promise.resolve(items)},Storage.prototype.remove=function(keys){var i,key,len;if(Log.method("Storage#remove",this,arguments),null!=this._items)if(null==keys)this._items={};else if(Array.isArray(keys))for(i=0,len=keys.length;i<len;i++)key=keys[i],delete this._items[key];else delete this._items[keys];return Promise.resolve()},Storage.prototype.watch=function(keys,callback){return Log.method("Storage#watch",this,arguments),function(){return null}},Storage.prototype.apply=function(operations){return"changes"in operations&&(operations=Storage.operationsForChanges(operations.changes,operations)),this.set(operations.set).then((_this=this,function(){return _this.remove(operations.remove)})).return(operations);var _this},Storage}(),module.exports=Storage},{"./log":31,bluebird:2}],35:[function(require,module,exports){exports.Promise=require("bluebird")},{bluebird:2}],OmegaTarget:[function(require,module,exports){var name,ref,ref1,value;for(name in module.exports={Log:require("./src/log"),Storage:require("./src/storage"),BrowserStorage:require("./src/browser_storage"),Options:require("./src/options"),OptionsSync:require("./src/options_sync"),OmegaPac:require("omega-pac")},ref=require("./src/utils.coffee"))value=ref[name],module.exports[name]=value;for(name in ref1=require("./src/errors.coffee"))value=ref1[name],module.exports[name]=value},{"./src/browser_storage":28,"./src/errors.coffee":30,"./src/log":31,"./src/options":32,"./src/options_sync":33,"./src/storage":34,"./src/utils.coffee":35,"omega-pac":27}]},{},["OmegaTarget"])("OmegaTarget")}));